---
/**
 * PerformanceBadge Component
 *
 * Displays Lighthouse metrics in the footer.
 * Shows shared scores (A11y, BP, SEO) once, and Performance scores per device.
 * Metrics are auto-generated from PageSpeed Insights API during build.
 *
 * @example
 * <PerformanceBadge translations={translations} />
 */

import lighthouseMetrics from '@/data/lighthouse-metrics.json';

interface PerformanceMetrics {
    performance: {
        lcp: string;
        cls: string;
        fcp: string;
        tbt: string;
        si: string;
        score: string;
    };
    accessibility: {
        score: string;
    };
    bestPractices: {
        score: string;
    };
    seo: {
        score: string;
    };
}

interface Props {
    /** Translations */
    translations?: {
        title: string;
        desktop: string;
        mobile: string;
        performance: string;
        accessibility: string;
        bestPractices: string;
        seo: string;
        lcp: string;
        cls: string;
        fcp: string;
        source: string;
        tooltips: {
            performance: string;
            accessibility: string;
            bestPractices: string;
            seo: string;
            lcp: string;
            cls: string;
            fcp: string;
        };
    };
}

// Get metrics from JSON file (manually updated, committed to repo)
const desktop: PerformanceMetrics = lighthouseMetrics.desktop as PerformanceMetrics;
const mobile: PerformanceMetrics = lighthouseMetrics.mobile as PerformanceMetrics;

// Format the date for display (YYYY-MM-DD format)
const lastUpdatedDate = new Date(lighthouseMetrics.lastUpdated);
const lastUpdated = `${lastUpdatedDate.getFullYear()}-${String(lastUpdatedDate.getMonth() + 1).padStart(2, '0')}-${String(lastUpdatedDate.getDate()).padStart(2, '0')}`;

// Get the report URL from the metrics file (or fallback to generic URL)
const reportUrl =
    (lighthouseMetrics as { reportUrl?: string }).reportUrl ||
    `https://pagespeed.web.dev/analysis?url=${encodeURIComponent(lighthouseMetrics.url)}`;

const {
    translations = {
        title: 'Lighthouse Scores',
        desktop: 'Desktop',
        mobile: 'Mobile',
        performance: 'Perf',
        accessibility: 'A11y',
        bestPractices: 'BP',
        seo: 'SEO',
        lcp: 'LCP',
        cls: 'CLS',
        fcp: 'FCP',
        source: 'PageSpeed Insights',
        tooltips: {
            performance: 'Performance Score',
            accessibility: 'Accessibility Score',
            bestPractices: 'Best Practices Score',
            seo: 'SEO Score',
            lcp: 'Largest Contentful Paint',
            cls: 'Cumulative Layout Shift',
            fcp: 'First Contentful Paint'
        }
    }
} = Astro.props;
---

<div class="performance-badge text-xs">
    <!-- Header with icon and title -->
    <div class="flex items-center gap-1.5 text-foreground-muted mb-1">
        <svg
            class="w-3.5 h-3.5 text-primary"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
        >
            <path d="M13 10V3L4 14h7v7l9-11h-7z"></path>
        </svg>
        <a
            href={reportUrl}
            target="_blank"
            rel="noopener noreferrer"
            class="font-medium hover:text-primary transition-colors"
        >
            {translations.title}
        </a>
    </div>

    <!-- Source info: date + source note -->
    <div class="text-[9px] text-foreground-muted/50 mb-1.5">
        {lastUpdated} Â· {translations.source}
    </div>

    <!-- Two-column layout: Shared scores | Performance by device -->
    <div class="flex gap-6 text-[10px]">
        <!-- Left: Shared Scores (A11y, BP, SEO) - tooltips to the left -->
        <div class="flex flex-col gap-0.5">
            <span class="metric-item text-foreground-muted" data-tooltip={translations.tooltips.accessibility} data-tooltip-position="left">{translations.accessibility} <span class="text-primary font-mono">{desktop.accessibility.score}</span></span>
            <span class="metric-item text-foreground-muted" data-tooltip={translations.tooltips.bestPractices} data-tooltip-position="left">{translations.bestPractices} <span class="text-primary font-mono">{desktop.bestPractices.score}</span></span>
            <span class="metric-item text-foreground-muted" data-tooltip={translations.tooltips.seo} data-tooltip-position="left">{translations.seo} <span class="text-primary font-mono">{desktop.seo.score}</span></span>
        </div>

        <!-- Right: Performance by device with Web Vitals -->
        <div class="border-l border-foreground-muted/10 pl-4">
            <div class="grid grid-cols-[auto_1fr_1fr_1fr_1fr] gap-x-2 gap-y-0.5">
                <!-- Desktop Row - tooltips up -->
                <span class="text-foreground-muted/70">{translations.desktop}</span>
                <span class="metric-item text-foreground-muted" data-tooltip={translations.tooltips.performance} data-tooltip-position="top">{translations.performance} <span class="text-primary font-mono font-semibold">{desktop.performance.score}</span></span>
                <span class="metric-item text-foreground-muted/80" data-tooltip={translations.tooltips.lcp} data-tooltip-position="top">{translations.lcp} <span class="text-primary/80 font-mono">{desktop.performance.lcp}</span></span>
                <span class="metric-item text-foreground-muted/80" data-tooltip={translations.tooltips.fcp} data-tooltip-position="top">{translations.fcp} <span class="text-primary/80 font-mono">{desktop.performance.fcp}</span></span>
                <span class="metric-item text-foreground-muted/80" data-tooltip={translations.tooltips.cls} data-tooltip-position="top">{translations.cls} <span class="text-primary/80 font-mono">{desktop.performance.cls}</span></span>

                <!-- Mobile Row - tooltips down -->
                <span class="text-foreground-muted/70">{translations.mobile}</span>
                <span class="metric-item text-foreground-muted" data-tooltip={translations.tooltips.performance} data-tooltip-position="bottom">{translations.performance} <span class="text-primary font-mono font-semibold">{mobile.performance.score}</span></span>
                <span class="metric-item text-foreground-muted/80" data-tooltip={translations.tooltips.lcp} data-tooltip-position="bottom">{translations.lcp} <span class="text-primary/80 font-mono">{mobile.performance.lcp}</span></span>
                <span class="metric-item text-foreground-muted/80" data-tooltip={translations.tooltips.fcp} data-tooltip-position="bottom">{translations.fcp} <span class="text-primary/80 font-mono">{mobile.performance.fcp}</span></span>
                <span class="metric-item text-foreground-muted/80" data-tooltip={translations.tooltips.cls} data-tooltip-position="bottom">{translations.cls} <span class="text-primary/80 font-mono">{mobile.performance.cls}</span></span>
            </div>
        </div>
    </div>
</div>

<style>
    /* Metric item base */
    .metric-item {
        position: relative;
        cursor: help;
    }

    /* ========== TOP TOOLTIP (default) ========== */
    .metric-item[data-tooltip-position="top"]::before {
        content: "";
        position: absolute;
        top: -6px;
        left: 50%;
        transform: translateX(-50%);
        border-width: 4px 6px 0 6px;
        border-style: solid;
        z-index: 100;
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: none;
    }

    .metric-item[data-tooltip-position="top"]::after {
        content: attr(data-tooltip);
        position: absolute;
        left: 50%;
        top: -6px;
        transform: translateX(-50%) translateY(-100%);
        text-align: center;
        padding: 6px 10px;
        font-size: 11px;
        min-width: 80px;
        border-radius: 6px;
        pointer-events: none;
        z-index: 100;
        opacity: 0;
        transition: opacity 0.3s ease;
        white-space: nowrap;
        font-weight: 500;
    }

    /* ========== BOTTOM TOOLTIP ========== */
    .metric-item[data-tooltip-position="bottom"]::before {
        content: "";
        position: absolute;
        bottom: -6px;
        left: 50%;
        transform: translateX(-50%);
        border-width: 0 6px 4px 6px;
        border-style: solid;
        z-index: 100;
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: none;
    }

    .metric-item[data-tooltip-position="bottom"]::after {
        content: attr(data-tooltip);
        position: absolute;
        left: 50%;
        bottom: -6px;
        transform: translateX(-50%) translateY(100%);
        text-align: center;
        padding: 6px 10px;
        font-size: 11px;
        min-width: 80px;
        border-radius: 6px;
        pointer-events: none;
        z-index: 100;
        opacity: 0;
        transition: opacity 0.3s ease;
        white-space: nowrap;
        font-weight: 500;
    }

    /* ========== LEFT TOOLTIP (desktop only) ========== */
    @media (min-width: 640px) {
        .metric-item[data-tooltip-position="left"]::before {
            content: "";
            position: absolute;
            left: -6px;
            top: 50%;
            transform: translateY(-50%);
            border-width: 6px 0 6px 4px;
            border-style: solid;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .metric-item[data-tooltip-position="left"]::after {
            content: attr(data-tooltip);
            position: absolute;
            right: 100%;
            top: 50%;
            transform: translateY(-50%);
            margin-right: 6px;
            text-align: center;
            padding: 6px 10px;
            font-size: 11px;
            min-width: 80px;
            border-radius: 6px;
            pointer-events: none;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s ease;
            white-space: nowrap;
            font-weight: 500;
        }
    }

    /* ========== LEFT becomes RIGHT on mobile ========== */
    @media (max-width: 639px) {
        .metric-item[data-tooltip-position="left"]::before {
            content: "";
            position: absolute;
            right: -6px;
            top: 50%;
            transform: translateY(-50%);
            border-width: 6px 4px 6px 0;
            border-style: solid;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .metric-item[data-tooltip-position="left"]::after {
            content: attr(data-tooltip);
            position: absolute;
            left: 100%;
            top: 50%;
            transform: translateY(-50%);
            margin-left: 6px;
            text-align: center;
            padding: 6px 10px;
            font-size: 11px;
            min-width: 80px;
            border-radius: 6px;
            pointer-events: none;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s ease;
            white-space: nowrap;
            font-weight: 500;
        }
    }

    /* ========== TOOLTIP COLORS - Uses CSS variables from global.css ========== */
    /* Top arrow */
    .metric-item[data-tooltip-position="top"]::before {
        border-color: rgb(var(--tooltip-border)) transparent transparent transparent;
    }
    /* Bottom arrow */
    .metric-item[data-tooltip-position="bottom"]::before {
        border-color: transparent transparent rgb(var(--tooltip-border)) transparent;
    }
    /* Left arrow (desktop) - arrow points right toward element */
    @media (min-width: 640px) {
        .metric-item[data-tooltip-position="left"]::before {
            border-color: transparent transparent transparent rgb(var(--tooltip-border));
        }
    }
    /* Left arrow becomes Right on mobile - arrow points left toward element */
    @media (max-width: 639px) {
        .metric-item[data-tooltip-position="left"]::before {
            border-color: transparent rgb(var(--tooltip-border)) transparent transparent;
        }
    }
    /* Tooltip background */
    .metric-item[data-tooltip]::after {
        background: rgb(var(--tooltip-bg));
        color: rgb(var(--tooltip-text));
    }

    /* ========== SHOW ON HOVER ========== */
    .metric-item[data-tooltip]:hover::after,
    .metric-item[data-tooltip]:hover::before {
        opacity: 1;
    }
</style>
