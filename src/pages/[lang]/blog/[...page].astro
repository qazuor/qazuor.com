---
import type { CollectionEntry } from 'astro:content';
import { getCollection } from 'astro:content';
import type { GetStaticPaths, Page } from 'astro';
import AnimatedGradientBackground from '@/components/ui/AnimatedGradientBackground.astro';
import SectionTitle from '@/components/ui/SectionTitle.astro';
import { languages } from '@/i18n/ui';
import { getLangFromUrl, getTranslations } from '@/i18n/utils';
import BaseLayout from '@/layouts/BaseLayout.astro';

// Define the type for our blog post data
interface BlogPostData {
    title: string;
    excerpt: string;
    date: string;
    readTime: string;
    tags: string[];
    slug: string;
}

interface Props {
    page: Page<BlogPostData>;
}

export const getStaticPaths: GetStaticPaths = async ({ paginate }) => {
    const allBlogPosts = await getCollection('blog');

    // Filter out drafts and sort by date (newest first)
    const publishedPosts = allBlogPosts
        .filter((post: CollectionEntry<'blog'>) => !post.data.draft)
        .sort(
            (a: CollectionEntry<'blog'>, b: CollectionEntry<'blog'>) =>
                b.data.publishDate.getTime() - a.data.publishDate.getTime()
        );

    // Generate paginated paths for each language
    return Object.keys(languages).flatMap((lang) => {
        const postsForLang = publishedPosts.map((post: CollectionEntry<'blog'>) => ({
            title: post.data.title,
            excerpt: post.data.excerpt,
            date: post.data.publishDate.toISOString().split('T')[0],
            readTime: post.data.readTime,
            tags: post.data.tags,
            slug: `/${lang}/blog/${post.slug}`
        }));

        return paginate(postsForLang, {
            params: { lang },
            pageSize: 6 // 6 posts per page
        });
    });
};

const { page }: Props = Astro.props;
const lang = getLangFromUrl(Astro.url);
const t = getTranslations(lang);

const title = `${t('blog.title')} - qazuor.com`;
---

<BaseLayout title={title}>
    <div class="relative section overflow-hidden pt-32" style="background-color: #0891b2;">
        <AnimatedGradientBackground />

        <div class="container-custom">
            <!-- Header -->
            <div class="mb-16">
                <SectionTitle title={t('blog.title')} subtitle={t('blog.subtitle')} />

                <!-- Page indicator -->
                {
                    page.lastPage > 1 && (
                        <p class="mt-6 text-center text-sm text-foreground-secondary">
                            {t('blog.pagination.page')} {page.currentPage} {t('blog.pagination.of')} {page.lastPage} •{' '}
                            {page.total} {t('blog.pagination.articles')}
                        </p>
                    )
                }
            </div>

        <!-- Blog Posts Grid -->
        {
            page.data.length > 0 ? (
                <>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                        {page.data.map((post: BlogPostData) => (
                            <article class="blog-card card-hover group p-6">
                                {/* Header */}
                                <div class="flex items-center gap-4 mb-4 text-sm text-foreground-muted">
                                    <time datetime={post.date} class="flex items-center gap-2">
                                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                stroke-width={2}
                                                d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
                                            />
                                        </svg>
                                        {new Date(post.date).toLocaleDateString(lang === 'es' ? 'es-ES' : 'en-US', {
                                            year: 'numeric',
                                            month: 'short',
                                            day: 'numeric'
                                        })}
                                    </time>
                                    <span>•</span>
                                    <span class="flex items-center gap-2">
                                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                stroke-width={2}
                                                d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                                            />
                                        </svg>
                                        {post.readTime.match(/\d+/)?.[0]} {t('blog.readTime')}
                                    </span>
                                </div>

                                {/* Title */}
                                <h3 class="text-xl font-bold mb-3 text-foreground group-hover:text-primary transition-colors duration-300">
                                    <a href={post.slug} class="hover:underline">
                                        {post.title}
                                    </a>
                                </h3>

                                {/* Excerpt */}
                                <p class="text-foreground-secondary text-sm mb-4 line-clamp-3">{post.excerpt}</p>

                                {/* Tags */}
                                <div class="flex flex-wrap gap-2 mb-4">
                                    {post.tags.map((tag: string) => (
                                        <span class="px-3 py-1 text-xs font-medium bg-foreground/5 text-foreground-secondary rounded-full border border-foreground/10 hover:border-primary hover:text-primary transition-colors duration-300">
                                            #{tag}
                                        </span>
                                    ))}
                                </div>

                                {/* Read more link */}
                                <a
                                    href={post.slug}
                                    class="inline-flex items-center text-primary hover:text-primary-600 font-medium transition-colors duration-300 group/link"
                                >
                                    {t('blog.readMore')}
                                    <svg
                                        class="w-4 h-4 ml-1 group-hover/link:translate-x-1 transition-transform duration-300"
                                        fill="none"
                                        viewBox="0 0 24 24"
                                        stroke="currentColor"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width={2}
                                            d="M9 5l7 7-7 7"
                                        />
                                    </svg>
                                </a>
                            </article>
                        ))}
                    </div>

                    {/* Pagination Controls */}
                    {page.lastPage > 1 && (
                        <nav class="mt-16 flex items-center justify-center gap-2" aria-label="Pagination">
                            {/* Previous Button */}
                            {page.url.prev ? (
                                <a
                                    href={page.url.prev}
                                    class="inline-flex items-center gap-2 px-4 py-2 bg-background-secondary hover:bg-primary hover:text-white border border-foreground/10 hover:border-primary rounded-lg transition-all duration-300 font-medium"
                                >
                                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width={2}
                                            d="M15 19l-7-7 7-7"
                                        />
                                    </svg>
                                    {t('blog.pagination.previous')}
                                </a>
                            ) : (
                                <span class="inline-flex items-center gap-2 px-4 py-2 bg-background-secondary/50 border border-foreground/10 rounded-lg text-foreground-muted cursor-not-allowed">
                                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width={2}
                                            d="M15 19l-7-7 7-7"
                                        />
                                    </svg>
                                    {t('blog.pagination.previous')}
                                </span>
                            )}

                            {/* Page Numbers */}
                            <div class="flex items-center gap-2">
                                {Array.from({ length: page.lastPage }, (_, i) => i + 1).map((pageNum) => {
                                    const isCurrentPage = pageNum === page.currentPage;
                                    const href = pageNum === 1 ? `/${lang}/blog` : `/${lang}/blog/${pageNum}`;

                                    return isCurrentPage ? (
                                        <span class="px-4 py-2 bg-primary text-white rounded-lg font-bold shadow-glow-primary">
                                            {pageNum}
                                        </span>
                                    ) : (
                                        <a
                                            href={href}
                                            class="px-4 py-2 bg-background-secondary hover:bg-primary hover:text-white border border-foreground/10 hover:border-primary rounded-lg transition-all duration-300 font-medium"
                                        >
                                            {pageNum}
                                        </a>
                                    );
                                })}
                            </div>

                            {/* Next Button */}
                            {page.url.next ? (
                                <a
                                    href={page.url.next}
                                    class="inline-flex items-center gap-2 px-4 py-2 bg-background-secondary hover:bg-primary hover:text-white border border-foreground/10 hover:border-primary rounded-lg transition-all duration-300 font-medium"
                                >
                                    {t('blog.pagination.next')}
                                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width={2}
                                            d="M9 5l7 7-7 7"
                                        />
                                    </svg>
                                </a>
                            ) : (
                                <span class="inline-flex items-center gap-2 px-4 py-2 bg-background-secondary/50 border border-foreground/10 rounded-lg text-foreground-muted cursor-not-allowed">
                                    {t('blog.pagination.next')}
                                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width={2}
                                            d="M9 5l7 7-7 7"
                                        />
                                    </svg>
                                </span>
                            )}
                        </nav>
                    )}
                </>
            ) : (
                <div class="text-center py-20">
                    <p class="text-foreground-secondary text-lg">{t('blog.noArticles')}</p>
                </div>
            )
        }
        </div>
    </div>
</BaseLayout>
