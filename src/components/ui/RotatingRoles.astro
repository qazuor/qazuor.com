---
interface Props {
    roles: string[];
    className?: string;
}

const { roles, className = '' } = Astro.props;
---

<div class={`absolute bottom-16 lg:bottom-20 left-1/2 -translate-x-1/2 ${className}`} style="z-index: 100;">
    <span
        id="rotating-roles"
        class="text-sm lg:text-lg font-medium text-primary bg-background/90 backdrop-blur-md px-3 py-1.5 lg:px-4 lg:py-2 rounded-full border border-foreground/20 shadow-lg rotating-roles"
        data-roles={JSON.stringify(roles)}
        set:html={roles[0]}
    />
</div>

<script>
    /**
     * Rotating Roles Animation - Vanilla JS Implementation
     * Replaces GSAP with native Web Animations API
     */

    // Store active interval to prevent duplicates
    let activeInterval: number | null = null;
    let currentIndex = 0;

    // Easing equivalent to GSAP's back.out(1.7)
    const EASE_BACK_OUT = 'cubic-bezier(0.34, 1.56, 0.64, 1)';
    const EASE_OUT = 'cubic-bezier(0.33, 1, 0.68, 1)';

    // Initialize rotating roles
    function initializeRotatingRoles() {
        const element = document.getElementById('rotating-roles');
        if (!element) return;

        const rolesData = element.getAttribute('data-roles');
        if (!rolesData) return;

        try {
            const roles: string[] = JSON.parse(rolesData);
            if (roles.length === 0) return;

            // Clear previous interval if exists
            if (activeInterval) {
                clearInterval(activeInterval);
                activeInterval = null;
            }

            // Reset state
            currentIndex = 0;
            element.style.opacity = '1';
            element.style.transform = 'scale(1)';

            // Single role: just fade in
            if (roles.length === 1) {
                element.animate(
                    [
                        { opacity: 0, transform: 'scale(0.9)' },
                        { opacity: 1, transform: 'scale(1)' }
                    ],
                    { duration: 800, easing: EASE_BACK_OUT, delay: 500, fill: 'forwards' }
                );
                return;
            }

            // Multiple roles: create rotation
            async function rotateToNext() {
                // Calculate next index
                currentIndex = (currentIndex + 1) % roles.length;

                // Fade out + scale down
                const fadeOut = element!.animate(
                    [
                        { opacity: 1, transform: 'scale(1)' },
                        { opacity: 0, transform: 'scale(0.95)' }
                    ],
                    { duration: 200, easing: EASE_OUT, fill: 'forwards' }
                );

                await fadeOut.finished;

                // Change text
                element!.innerHTML = roles[currentIndex];

                // Fade in + scale up with bounce
                element!.animate(
                    [
                        { opacity: 0, transform: 'scale(0.95)' },
                        { opacity: 1, transform: 'scale(1)' }
                    ],
                    { duration: 400, easing: EASE_BACK_OUT, fill: 'forwards' }
                );
            }

            // Start rotation after initial delay
            setTimeout(() => {
                rotateToNext();
                // Then rotate every 2.5 seconds (1.5s display + 0.6s animation + 0.4s pause)
                activeInterval = window.setInterval(rotateToNext, 2500);
            }, 1500);

        } catch (error) {
            console.error('Error parsing roles data:', error);
        }
    }

    // Initialize on page load
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeRotatingRoles);
    } else {
        initializeRotatingRoles();
    }

    // Re-initialize after View Transitions
    document.addEventListener('qazuor:content-ready', initializeRotatingRoles);
</script>

<style>
    /* Rotating roles styling with shine effect */
    .rotating-roles {
        white-space: nowrap;
        min-height: 2.5rem;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow: hidden;
        box-shadow:
            0 4px 15px rgba(var(--color-primary), 0.3),
            0 0 20px rgba(var(--color-primary), 0.1);
        animation: subtle-glow 3s ease-in-out infinite alternate;
    }

    /* Shine effect overlay */
    .rotating-roles::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
        transition: left 0.8s ease-in-out;
        z-index: 1;
    }

    /* Trigger shine on hover */
    .rotating-roles:hover::before {
        left: 100%;
    }

    @keyframes subtle-glow {
        from {
            box-shadow:
                0 4px 15px rgba(var(--color-primary), 0.3),
                0 0 20px rgba(var(--color-primary), 0.1);
        }
        to {
            box-shadow:
                0 4px 25px rgba(var(--color-primary), 0.4),
                0 0 30px rgba(var(--color-primary), 0.15);
        }
    }
</style>
