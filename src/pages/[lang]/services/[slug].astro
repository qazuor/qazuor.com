---
import ServiceJsonLd from '@/components/seo/ServiceJsonLd.astro';
import AnimatedGradientBackground from '@/components/ui/AnimatedGradientBackground.astro';
import SectionTitle from '@/components/ui/SectionTitle.astro';
import ServiceIcon from '@/components/ui/ServiceIcon.astro';
import { getInterestsForService } from '@/data';
import { services } from '@/data/services';
import { languages } from '@/i18n/ui';
import { getLangFromUrl, getTranslations } from '@/i18n/utils';
import BaseLayout from '@/layouts/BaseLayout.astro';

export function getStaticPaths() {
    const langs = Object.keys(languages);
    const paths = langs.flatMap((lang) =>
        services.map((service) => ({
            params: { lang, slug: service.slug }
        }))
    );
    return paths;
}

const { slug } = Astro.params;
const lang = getLangFromUrl(Astro.url);
const t = getTranslations(lang);

// Get service data
const service = services.find((s) => s.slug === slug);
if (!service) {
    return Astro.redirect('/404');
}

// Map service ID to translation key
const serviceKeyMap: Record<string, string> = {
    'web-apps': 'webApps',
    'landing-pages': 'landingPages',
    'automation-integration': 'automation',
    'social-media-design': 'socialDesign',
    'web-optimization': 'webOptimization',
    wordpress: 'wordpress'
};
const serviceKey = serviceKeyMap[service.id];

// SEO
const pageTitle = t(service.meta.titleKey, { markdown: false });
const pageDescription = t(service.meta.descriptionKey, { markdown: false });

// Service translations
const serviceTitle = t(`services.${serviceKey}.title`, { markdown: true });
const serviceDescription = t(`services.${serviceKey}.descriptionExpanded`, { markdown: true });

// Features - dynamically determine count
const features: string[] = [];
let featureIndex = 0;
while (true) {
    try {
        const feature = t(`services.${serviceKey}.features.${featureIndex}`);
        if (!feature || feature === `services.${serviceKey}.features.${featureIndex}`) break;
        features.push(feature);
        featureIndex++;
    } catch {
        break;
    }
}

// Pricing breakdown - dynamically determine count
const pricingBreakdown: string[] = [];
let pricingIndex = 0;
while (true) {
    try {
        const pricing = t(`services.${serviceKey}.pricing.breakdown.${pricingIndex}`, {
            markdown: true
        });
        if (!pricing || pricing === `services.${serviceKey}.pricing.breakdown.${pricingIndex}`) break;
        pricingBreakdown.push(pricing);
        pricingIndex++;
    } catch {
        break;
    }
}

// Pricing factors - dynamically determine count
const pricingFactors: string[] = [];
let factorIndex = 0;
while (true) {
    try {
        const factor = t(`services.${serviceKey}.pricing.factors.${factorIndex}`);
        if (!factor || factor === `services.${serviceKey}.pricing.factors.${factorIndex}`) break;
        pricingFactors.push(factor);
        factorIndex++;
    } catch {
        break;
    }
}

// FAQs - dynamically determine count (with markdown processing for answers)
const faqs: Array<{ question: string; answer: string }> = [];
let faqIndex = 0;
while (true) {
    try {
        const question = t(`services.${serviceKey}.faqs.${faqIndex}.question`);
        const answer = t(`services.${serviceKey}.faqs.${faqIndex}.answer`, { markdown: true });
        if (!question || !answer || question === `services.${serviceKey}.faqs.${faqIndex}.question`) break;
        faqs.push({ question, answer });
        faqIndex++;
    } catch {
        break;
    }
}

// Related services
const relatedServices = services
    .filter((s) => service.relatedServices.includes(s.id))
    .map((s) => {
        const relatedKey = serviceKeyMap[s.id];
        return {
            ...s,
            title: t(`services.${relatedKey}.title`, { markdown: true }),
            description: t(`services.${relatedKey}.description`)
        };
    });

// JSON-LD data
const SITE_URL = 'https://qazuor.com';
const serviceUrl = `${SITE_URL}/${lang}/services/${service.slug}`;

// Map service ID to Schema.org serviceType
const serviceTypeMap: Record<string, string> = {
    'web-apps': 'Web Application Development',
    'landing-pages': 'Web Design',
    'automation-integration': 'IT Consulting',
    'social-media-design': 'Graphic Design',
    'web-optimization': 'SEO Service',
    wordpress: 'Web Development'
};
const serviceType = serviceTypeMap[service.id] || 'Web Development';

// Format price range for JSON-LD
const formatPriceRange = (): string | undefined => {
    const { pricing } = service;
    if (pricing.type === 'consultation') return undefined;
    if (pricing.type === 'from' && pricing.min) {
        return `$${pricing.min}+`;
    }
    if (pricing.type === 'range' && pricing.min && pricing.max) {
        return `$${pricing.min}-$${pricing.max}`;
    }
    return undefined;
};
const priceRange = formatPriceRange();

// Breadcrumbs for JSON-LD
const breadcrumbs = [
    { name: t('nav.home', { markdown: false }), url: '/' },
    { name: t('nav.services', { markdown: false }), url: '/services' },
    { name: pageTitle.replace(/\*\*/g, '') }
];

// Clean service name (remove markdown)
const cleanServiceName = pageTitle.replace(/\*\*/g, '');
const cleanServiceDescription = pageDescription.replace(/\*\*/g, '');
---

<BaseLayout title={pageTitle} description={pageDescription}>
    <!-- Service JSON-LD Structured Data -->
    <ServiceJsonLd
        slot="head"
        lang={lang}
        serviceName={cleanServiceName}
        serviceDescription={cleanServiceDescription}
        serviceType={serviceType}
        serviceUrl={serviceUrl}
        priceRange={priceRange}
        faqs={faqs}
        breadcrumbs={breadcrumbs}
    />

    <!-- Hero Section -->
    <section
        class="relative section overflow-hidden pt-32 pb-20"
        style={`background-color: ${service.themeColor}`}
    >
        <AnimatedGradientBackground />

        <div class="container-custom">
            <div class="max-w-4xl mx-auto text-center">
                <ServiceIcon name={service.iconId} size={64} class="text-primary mb-6" />
                <h1 class="text-5xl md:text-6xl font-bold text-foreground mb-6" set:html={serviceTitle} />
                <p class="text-xl text-foreground-secondary leading-relaxed max-w-3xl mx-auto" set:html={serviceDescription} />
            </div>
        </div>
    </section>

    <!-- Features Section -->
    <section class="relative section py-20 bg-background">
        <div class="container-custom">
            <SectionTitle
                title={t('services.featuresTitle', { markdown: true })}
                subtitle={t('services.featuresSubtitle')}
                size="lg"
            />

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-12">
                {
                    features.map((feature) => (
                        <div class="flex items-start gap-3 p-6 rounded-lg bg-foreground/5 border border-foreground/10 hover:bg-foreground/10 transition-colors">
                            <svg
                                class="w-6 h-6 text-primary flex-shrink-0 mt-0.5"
                                fill="currentColor"
                                viewBox="0 0 20 20"
                            >
                                <path
                                    fill-rule="evenodd"
                                    d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                                    clip-rule="evenodd"
                                />
                            </svg>
                            <span class="text-foreground">{feature}</span>
                        </div>
                    ))
                }
            </div>
        </div>
    </section>

    <!-- Pricing Section -->
    <section class="relative section py-20" style={`background-color: ${service.themeColor}`}>
        <AnimatedGradientBackground />

        <div class="container-custom">
            <SectionTitle
                title={t('services.pricingTitle', { markdown: true })}
                subtitle={t('services.pricingSubtitle')}
                size="lg"
            />

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-12 max-w-5xl mx-auto">
                <!-- Pricing Breakdown -->
                <div class="bg-foreground/5 backdrop-blur-sm rounded-2xl p-8 border border-foreground/10">
                    <h3
                        class="text-2xl font-bold text-foreground mb-6"
                        set:html={t('services.pricingRanges', { markdown: true })}
                    />
                    <div class="space-y-4">
                        {
                            pricingBreakdown.map((item) => (
                                <div class="flex items-center gap-3 text-foreground-secondary">
                                    <svg
                                        class="w-5 h-5 text-primary flex-shrink-0"
                                        fill="currentColor"
                                        viewBox="0 0 20 20"
                                    >
                                        <path
                                            fill-rule="evenodd"
                                            d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                                            clip-rule="evenodd"
                                        />
                                    </svg>
                                    <span set:html={item} />
                                </div>
                            ))
                        }
                    </div>
                </div>

                <!-- Pricing Factors -->
                <div class="bg-foreground/5 backdrop-blur-sm rounded-2xl p-8 border border-foreground/10">
                    <h3
                        class="text-2xl font-bold text-foreground mb-6"
                        set:html={t('services.pricingFactorsTitle', { markdown: true })}
                    />
                    <div class="space-y-4">
                        {
                            pricingFactors.map((factor) => (
                                <div class="flex items-start gap-3 text-foreground-secondary">
                                    <svg
                                        class="w-5 h-5 text-secondary flex-shrink-0 mt-0.5"
                                        fill="none"
                                        stroke="currentColor"
                                        viewBox="0 0 24 24"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"
                                        />
                                    </svg>
                                    <span>{factor}</span>
                                </div>
                            ))
                        }
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- FAQ Section -->
    <section class="relative section py-20 bg-background">
        <div class="container-custom">
            <SectionTitle
                title={t('services.faqTitle', { markdown: true })}
                subtitle={t('services.faqSubtitle')}
                size="lg"
            />

            <div class="max-w-3xl mx-auto mt-12 space-y-4">
                {
                    faqs.map((faq) => (
                        <details class="group bg-foreground/5 rounded-lg border border-foreground/10 overflow-hidden">
                            <summary class="flex items-center justify-between px-6 py-4 cursor-pointer hover:bg-foreground/10 transition-colors">
                                <h3 class="text-lg font-semibold text-foreground pr-4">
                                    {faq.question}
                                </h3>
                                <svg
                                    class="w-5 h-5 text-foreground-secondary group-open:rotate-180 transition-transform flex-shrink-0"
                                    fill="none"
                                    stroke="currentColor"
                                    viewBox="0 0 24 24"
                                >
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M19 9l-7 7-7-7"
                                    />
                                </svg>
                            </summary>
                            <div class="px-6 pb-4 text-foreground-secondary leading-relaxed faq-answer" set:html={faq.answer} />
                        </details>
                    ))
                }
            </div>
        </div>
    </section>

    <!-- Related Services Section -->
    {
        relatedServices.length > 0 && (
            <section
                class="relative section py-20"
                style={`background-color: ${service.themeColor}`}
            >
                <AnimatedGradientBackground />

                <div class="container-custom">
                    <SectionTitle title={t('services.relatedServices.title')} size="lg" />

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-12 max-w-4xl mx-auto">
                        {relatedServices.map((related) => (
                            <a
                                href={`/${lang}/services/${related.slug}`}
                                class="group bg-foreground/5 backdrop-blur-sm rounded-2xl p-6 border border-foreground/10 hover:bg-foreground/10 hover:border-foreground/20 transition-all"
                            >
                                <div class="flex items-start gap-4">
                                    <ServiceIcon name={related.iconId} size={40} class="text-primary" />
                                    <div class="flex-1">
                                        <h3
                                            class="text-xl font-bold text-foreground mb-2 group-hover:text-primary transition-colors"
                                            set:html={related.title}
                                        />
                                        <p class="text-foreground-secondary text-sm">
                                            {related.description}
                                        </p>
                                    </div>
                                    <svg
                                        class="w-5 h-5 text-foreground-secondary group-hover:text-primary group-hover:translate-x-1 transition-all"
                                        fill="none"
                                        stroke="currentColor"
                                        viewBox="0 0 24 24"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M9 5l7 7-7 7"
                                        />
                                    </svg>
                                </div>
                            </a>
                        ))}
                    </div>
                </div>
            </section>
        )
    }

    <!-- CTA Section -->
    <section class="relative section py-20 bg-background">
        <div class="container-custom">
            <div class="max-w-3xl mx-auto text-center bg-foreground/5 backdrop-blur-sm rounded-2xl p-12 border border-foreground/10">
                <h2
                    class="text-3xl font-bold text-foreground mb-4"
                    set:html={t('services.cta.title', { markdown: true })}
                />
                <p
                    class="text-foreground-secondary text-lg mb-8"
                    set:html={t('services.cta.description', { markdown: true })}
                />

                <a
                    href={`/${lang}/?interests=${getInterestsForService(service.id)}#contact`}
                    class="inline-flex items-center px-8 py-4 bg-primary text-white font-semibold rounded-lg hover:bg-primary-dark transition-colors text-lg"
                >
                    <span set:html={t('services.cta.button', { markdown: true })} />
                    <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-3.582 8-8 8a8.959 8.959 0 01-4.906-1.478L3 21l2.478-5.094A8.959 8.959 0 013 12c0-4.418 3.582-8 8-8s8 3.582 8 8z"
                        />
                    </svg>
                </a>

                <div class="flex items-center justify-center gap-2 mt-6 text-foreground-secondary text-sm">
                    <svg class="w-4 h-4 text-green-400" fill="currentColor" viewBox="0 0 20 20">
                        <path
                            fill-rule="evenodd"
                            d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                            clip-rule="evenodd"
                        />
                    </svg>
                    <span set:html={t('services.cta.consultation', { markdown: true })} />
                </div>
            </div>
        </div>
    </section>
</BaseLayout>
