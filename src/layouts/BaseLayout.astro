---
// Import critical fonts and styles
// Note: fonts.css now handles font loading with proper critical/non-critical split
import '../styles/fonts.css';

// Import auto-generated colors
import '../styles/generated-colors.css';

// Astro image optimization
import { getImage } from 'astro:assets';
// View Transitions with Custom GSAP Animation
import { ViewTransitions } from 'astro:transitions';
import photo1 from '@/assets/images/photo1.png';
// Other imports
import AutoAnimateGlobal from '@/components/AutoAnimateGlobal.astro';
import { SmoothScroll } from '@/components/animations/SmoothScroll';
import BuildSearchIndex from '@/components/BuildSearchIndex.astro';
import { CommandPalette } from '@/components/interactive/CommandPalette';
import { ScrollToTop } from '@/components/interactive/ScrollToTop';
import Footer from '@/components/layout/Footer.astro';
import Navigation from '@/components/layout/Navigation.astro';
import SEO from '@/components/layout/SEO.astro';
import ViewTransitionGSAP from '@/components/transitions/ViewTransitionGSAP.astro';
// import PageTransition from '@/components/transitions/PageTransition.astro';
import { languages } from '@/i18n/ui';
import { getLangFromUrl, getRouteFromUrl, getTranslations } from '@/i18n/utils';

interface Props {
    title: string;
    description?: string;
    image?: string;
    imageAlt?: string;
    type?: 'website' | 'article' | 'profile';
    keywords?: string[];
    publishDate?: string;
    modifiedDate?: string;
    articleTags?: string[];
    noindex?: boolean;
    author?: string;
    jobTitle?: string;
    socialLinks?: {
        github?: string;
        linkedin?: string;
        fiverr?: string;
        upwork?: string;
    };
}

const lang = getLangFromUrl(Astro.url);
const t = getTranslations(lang);

// Optimize hero image for LCP (Largest Contentful Paint)
const optimizedPhoto = await getImage({
    src: photo1,
    format: 'webp'
});

const {
    title,
    description = t('home.description'),
    image,
    imageAlt,
    type = 'website',
    keywords = [],
    publishDate,
    modifiedDate,
    articleTags = [],
    noindex = false,
    author,
    jobTitle,
    socialLinks
} = Astro.props;

// Get current route without locale
const route = getRouteFromUrl(Astro.url);

// Generate alternate language links
const locales = Object.keys(languages);
const alternateLinks = locales.map((locale) => {
    const path = `/${locale}${route}`;
    return { locale, path };
});
---

<!doctype html>
<html lang={lang} class="dark">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="generator" content={Astro.generator} />

        <!-- Performance: Preload Critical Resources -->
        <!-- Only preload fonts used above-the-fold (hero section) -->
        <!-- Using crossorigin="anonymous" is required for font preloading -->

        <!-- Inter 400 - Body text (used throughout hero section) -->
        <link
            rel="preload"
            href="/fonts/inter-latin-400-normal.woff2"
            as="font"
            type="font/woff2"
            crossorigin="anonymous"
        />

        <!-- Inter 600 - Headings (h1, h2 in hero) -->
        <link
            rel="preload"
            href="/fonts/inter-latin-600-normal.woff2"
            as="font"
            type="font/woff2"
            crossorigin="anonymous"
        />

        <!-- Inter 700 - Bold emphasis (CTAs and strong text) -->
        <link
            rel="preload"
            href="/fonts/inter-latin-700-normal.woff2"
            as="font"
            type="font/woff2"
            crossorigin="anonymous"
        />

        <!-- Preload LCP image (hero image) with high priority -->
        <!-- Optimized with Astro's getImage() for WebP format -->
        <link
            rel="preload"
            href={optimizedPhoto.src}
            as="image"
            fetchpriority="high"
        />

        <!-- Critical CSS (inlined for fastest LCP) -->
        <!-- Contains ONLY styles needed for above-the-fold hero section -->
        <style is:inline>
            /* CSS Variables (dark mode only - default theme) */
            :root {
                --bg-primary-dark: 256 45% 6%;
                --bg-secondary-dark: 250 30% 10%;
                --text-primary-dark: 240 15% 96%;
                --text-secondary-dark: 240 10% 72%;
                --background: 256 45% 8%;
                --foreground: 240 15% 96%;
                --primary: 215 60% 50%;
            }

            html.dark {
                color-scheme: dark;
            }

            body {
                font-family: "Inter", system-ui, -apple-system, sans-serif;
                background: hsl(var(--background));
                color: hsl(var(--foreground));
                line-height: 1.5;
            }

            .container-custom {
                max-width: 80rem;
                margin-left: auto;
                margin-right: auto;
                padding-left: 1rem;
                padding-right: 1rem;
            }

            @media (min-width: 640px) {
                .container-custom {
                    padding-left: 1.5rem;
                    padding-right: 1.5rem;
                }
            }

            @media (min-width: 1024px) {
                .container-custom {
                    padding-left: 2rem;
                    padding-right: 2rem;
                }
            }

            .hero-section {
                position: relative;
                display: flex;
                justify-content: center;
                overflow: hidden;
                padding-top: 1rem;
            }

            @media (min-width: 1024px) {
                .hero-section {
                    align-items: center;
                    padding-top: 0;
                }
            }

            .gradient-text-hero {
                background: linear-gradient(to right, #2563eb, #a855f7, #7c3aed);
                background-size: 300% 100%;
                background-clip: text;
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                animation: gradient-shift 12s ease infinite;
            }

            html.dark .gradient-text-hero {
                background: linear-gradient(to right, #d8b4fe, #fbcfe8, #93c5fd);
            }

            @keyframes gradient-shift {
                0% {
                    background-position: 0% 50%;
                }
                50% {
                    background-position: 100% 50%;
                }
                100% {
                    background-position: 0% 50%;
                }
            }

            .text-foreground {
                color: hsl(var(--foreground));
            }

            .text-foreground-secondary {
                color: hsl(var(--text-secondary-dark));
            }

            .text-primary {
                color: hsl(var(--primary));
            }

            .font-black {
                font-weight: 900;
            }

            .font-semibold {
                font-weight: 600;
            }

            .font-bold {
                font-weight: 700;
            }

            .hero-element {
                opacity: 1;
            }

            .skip-link {
                position: absolute;
                top: -40px;
                left: 0;
                background: hsl(var(--background));
                color: hsl(var(--foreground));
                padding: 8px;
                text-decoration: none;
                z-index: 100;
            }

            .skip-link:focus {
                top: 0;
            }
        </style>

        <!-- SEO Component -->
        <SEO
            title={title}
            description={description}
            image={image}
            imageAlt={imageAlt}
            type={type}
            keywords={keywords}
            locale={lang}
            publishDate={publishDate}
            modifiedDate={modifiedDate}
            articleTags={articleTags}
            noindex={noindex}
            author={author}
            jobTitle={jobTitle}
            socialLinks={socialLinks}
        />

        <!-- Favicons are automatically injected by astro-favicons integration -->

        <!-- View Transitions (Astro official) -->
        <ViewTransitions />

        <!-- Alternate language links -->
        {
            alternateLinks.map(({ locale, path }) => (
                <link rel="alternate" hreflang={locale} href={`${Astro.site || ''}${path}`} />
            ))
        }

        <!-- Additional head content from pages -->
        <slot name="head" />

        <!-- Fix for View Transitions + GSAP ScrollTrigger conflict -->
        <!-- https://github.com/withastro/astro/issues/12725 -->
        <script is:inline>
            delete window.onscrollend;
        </script>

        <!-- Prevent flash of unstyled content (FOUC) for dark mode -->
        <script is:inline>
            const theme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (theme === 'dark' || (!theme && prefersDark)) {
                document.documentElement.classList.add('dark');
            } else if (theme === 'light') {
                document.documentElement.classList.remove('dark');
            }
        </script>
    </head>
    <body>
        <!-- Skip to main content link for accessibility -->
        <a href="#main-content" class="skip-link">
            {t('aria.skipToContent')}
        </a>

        <!-- AutoAnimate Global -->
        <AutoAnimateGlobal />

        <!-- Smooth Scroll Integration -->
        <SmoothScroll client:only="react" />

        <!-- Build Search Index -->
        <BuildSearchIndex />

        <!-- Command Palette (Ctrl+K) -->
        <CommandPalette
            client:only="react"
            lang={lang}
            ariaLabel={t('aria.closeCommandPalette')}
            placeholder={t('aria.commandPalettePlaceholder')}
        />

        <!-- Scroll to Top Button -->
        <ScrollToTop client:load ariaLabel={t('aria.scrollToTop')} />

        <!-- View Transitions with Custom GSAP Animation -->
        <ViewTransitionGSAP />

        <Navigation />

        <main id="main-content" class="min-h-screen">
            <slot />
        </main>

        <!-- New Footer Component -->
        <Footer lang={lang} />

        <!-- Mermaid Diagram Renderer -->
        <script type="module" is:inline>
            // Mermaid initialization function
            async function initializeMermaid() {
                try {
                    // Try to load mermaid
                    const mermaidModule = await import(
                        'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs'
                    );
                    const mermaid = mermaidModule.default || mermaidModule;

                    // Initialize Mermaid
                    mermaid.initialize({
                        startOnLoad: false,
                        theme: 'dark',
                        themeVariables: {
                            primaryColor: '#8b5cf6',
                            primaryTextColor: '#f3f4f6',
                            primaryBorderColor: '#8b5cf6',
                            lineColor: '#22d3ee',
                            secondaryColor: '#1e293b',
                            tertiaryColor: '#334155',
                            background: '#1e293b',
                            mainBkg: '#1e293b',
                            secondaryBkg: '#334155',
                            textColor: '#f3f4f6',
                            fontSize: '16px',
                            fontFamily: 'Inter, system-ui, sans-serif',
                            edgeLabelBackground: '#1e293b',
                            labelBackground: '#1e293b',
                            labelColor: '#f3f4f6'
                        },
                        flowchart: {
                            curve: 'basis',
                            lineWidth: 3,
                            padding: 20,
                            diagramPadding: 8,
                            htmlLabels: true,
                            rankSpacing: 50,
                            nodeSpacing: 50
                        },
                        securityLevel: 'loose'
                    });

                    // Process mermaid blocks
                    const mermaidBlocks = document.querySelectorAll('pre[data-language="mermaid"]');

                    if (mermaidBlocks.length === 0) return;

                    // First, preserve expressive-code assets from the first block
                    const firstExpressiveContainer = document.querySelector('.expressive-code');
                    let expressiveCodeAssets = null;

                    if (firstExpressiveContainer) {
                        const linkTag = firstExpressiveContainer.querySelector('link[rel="stylesheet"]');
                        const scriptTag = firstExpressiveContainer.querySelector('script[type="module"]');

                        if (linkTag || scriptTag) {
                            expressiveCodeAssets = {
                                link: linkTag?.cloneNode(true),
                                script: scriptTag?.cloneNode(true)
                            };
                        }
                    }

                    mermaidBlocks.forEach((pre, index) => {
                        const expressiveContainer = pre.closest('.expressive-code');
                        const copyButton = expressiveContainer?.querySelector('.copy button[data-code]');
                        let code = copyButton?.getAttribute('data-code') || '';

                        if (!code) return;

                        // Fix expressive-code formatting
                        code = code.replace(/    /g, '\n').replace(/\u007f/g, '\n');
                        code = code.replace(/graph\s+(LR|RL)/gi, 'graph TD');
                        code = code.replace(/flowchart\s+(LR|RL)/gi, 'flowchart TD');

                        // Create mermaid container
                        const container = document.createElement('div');
                        container.className = 'expressive-code mermaid-diagram';

                        // If this is the first mermaid block, preserve the assets
                        if (index === 0 && expressiveCodeAssets) {
                            if (expressiveCodeAssets.link) {
                                container.appendChild(expressiveCodeAssets.link);
                            }
                            if (expressiveCodeAssets.script) {
                                container.appendChild(expressiveCodeAssets.script);
                            }
                        }

                        const figure = document.createElement('figure');
                        figure.className = 'frame';

                        const mermaidDiv = document.createElement('div');
                        mermaidDiv.className = 'mermaid';
                        mermaidDiv.textContent = code;

                        figure.appendChild(mermaidDiv);
                        container.appendChild(figure);

                        if (expressiveContainer) {
                            expressiveContainer.replaceWith(container);
                        } else {
                            pre.replaceWith(container);
                        }
                    });

                    // Render diagrams
                    await mermaid.run();

                    // Style edge labels
                    document.querySelectorAll('.mermaid svg g.edgeLabel').forEach((label) => {
                        const rect = label.querySelector('rect');
                        if (rect) {
                            const currentWidth = parseFloat(rect.getAttribute('width') || '0');
                            const currentHeight = parseFloat(rect.getAttribute('height') || '0');
                            const currentX = parseFloat(rect.getAttribute('x') || '0');
                            const currentY = parseFloat(rect.getAttribute('y') || '0');

                            const padding = 8;
                            rect.setAttribute('width', String(currentWidth + padding * 2));
                            rect.setAttribute('height', String(currentHeight + padding * 2));
                            rect.setAttribute('x', String(currentX - padding));
                            rect.setAttribute('y', String(currentY - padding));
                            rect.setAttribute('rx', '4');
                            rect.setAttribute('ry', '4');
                            rect.setAttribute('fill', '#1e293b');
                            rect.setAttribute('stroke', '#8b5cf6');
                            rect.setAttribute('stroke-width', '1');
                        }
                    });
                } catch (error) {
                    console.error('Mermaid failed to load:', error);
                }
            }

            // Initialize on initial page load
            document.addEventListener('DOMContentLoaded', initializeMermaid);

            // Re-initialize after View Transitions navigation
            document.addEventListener('astro:page-load', initializeMermaid);
        </script>

        {/* Analytics and scripts can be added here */}
    </body>
</html>

<style is:global>
    @import '../styles/global.css';
</style>
