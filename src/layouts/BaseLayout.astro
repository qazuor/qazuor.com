---
// Import fonts first
import '@fontsource/inter/400.css';
import '@fontsource/inter/500.css';
import '@fontsource/inter/600.css';
import '@fontsource/inter/700.css';
import '@fontsource/inter/800.css';
import '@fontsource/inter/900.css';
import '@fontsource/jetbrains-mono/400.css';
import '@fontsource/jetbrains-mono/500.css';
import '@fontsource/jetbrains-mono/600.css';
import '@fontsource/jetbrains-mono/700.css';

// Import all additional fonts
import '../styles/fonts.css';

// Other imports
import { CommandPalette, ScrollToTop, SmoothScroll } from '../components';
import Navigation from '../components/Navigation.astro';
import SEO from '../components/SEO.astro';
import { contact } from '../data';
import { languages } from '../i18n/ui';
import { getLangFromUrl, getRouteFromUrl, getTranslations } from '../i18n/utils';
import githubIcon from '../icons/social/github.svg?raw';
import twitterIcon from '../icons/social/twitter.svg?raw';

interface Props {
  title: string;
  description?: string;
  image?: string;
  imageAlt?: string;
  type?: 'website' | 'article' | 'profile';
  keywords?: string[];
  publishDate?: string;
  modifiedDate?: string;
  articleTags?: string[];
  noindex?: boolean;
  author?: string;
  jobTitle?: string;
  socialLinks?: {
    github?: string;
    twitter?: string;
    linkedin?: string;
  };
}

const lang = getLangFromUrl(Astro.url);
const t = getTranslations(lang);

const {
  title,
  description = t('home.description'),
  image,
  imageAlt,
  type = 'website',
  keywords = [],
  publishDate,
  modifiedDate,
  articleTags = [],
  noindex = false,
  author,
  jobTitle,
  socialLinks,
} = Astro.props;
const currentYear = new Date().getFullYear();

// Get current route without locale
const route = getRouteFromUrl(Astro.url);

// Generate alternate language links
const locales = Object.keys(languages);
const alternateLinks = locales.map((locale) => {
  const path = `/${locale}${route}`;
  return { locale, path };
});
---

<!doctype html>
<html lang={lang} class="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content={Astro.generator} />

    <!-- SEO Component -->
    <SEO
      title={title}
      description={description}
      image={image}
      imageAlt={imageAlt}
      type={type}
      keywords={keywords}
      locale={lang}
      publishDate={publishDate}
      modifiedDate={modifiedDate}
      articleTags={articleTags}
      noindex={noindex}
      author={author}
      jobTitle={jobTitle}
      socialLinks={socialLinks}
    />

    <!-- Favicons -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png" />
    <link rel="icon" type="image/png" sizes="512x512" href="/android-chrome-512x512.png" />
    <link rel="manifest" href="/site.webmanifest" />

    <!-- Alternate language links -->
    {
      alternateLinks.map(({ locale, path }) => (
        <link rel="alternate" hreflang={locale} href={`${Astro.site || ''}${path}`} />
      ))
    }

    <!-- Prevent flash of unstyled content (FOUC) for dark mode -->
    <script is:inline>
      const theme = localStorage.getItem('theme');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      if (theme === 'dark' || (!theme && prefersDark)) {
        document.documentElement.classList.add('dark');
      } else if (theme === 'light') {
        document.documentElement.classList.remove('dark');
      }
    </script>
  </head>
  <body>
    <!-- Smooth Scroll Integration -->
    <SmoothScroll client:only="react" />

    <!-- Command Palette (Ctrl+K) -->
    <CommandPalette
      client:only="react"
      lang={lang}
      ariaLabel={t('aria.closeCommandPalette')}
      placeholder={t('aria.commandPalettePlaceholder')}
      socialLinks={{
        github: contact.social.github,
        twitter: contact.social.twitter,
        linkedin: contact.social.linkedin,
      }}
    />

    <!-- Scroll to Top Button -->
    <ScrollToTop client:load ariaLabel={t('aria.scrollToTop')} />

    <Navigation />

    <main class="min-h-screen">
      <slot />
    </main>

    <footer class="bg-background-secondary border-t border-foreground/10">
      <div class="container-custom py-8">
        <div class="flex flex-col md:flex-row justify-between items-center gap-4">
          <p class="text-sm text-foreground-secondary">
            Â© {currentYear} qazuor.com. {t('footer.rights')}.
          </p>
          <div class="flex gap-4">
            <a
              href={contact.social.github}
              target="_blank"
              rel="noopener noreferrer"
              class="text-foreground-secondary hover:text-foreground transition-colors duration-base"
              aria-label={t('aria.github')}
              set:html={githubIcon}
            />
            <a
              href="https://twitter.com/qazuor"
              target="_blank"
              rel="noopener noreferrer"
              class="text-foreground-secondary hover:text-foreground transition-colors duration-base"
              aria-label={t('aria.twitter')}
              set:html={twitterIcon}
            />
          </div>
        </div>
      </div>
    </footer>

    <!-- Mermaid Diagram Renderer -->
    <script type="module" is:inline>
      import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';

      // Initialize Mermaid with a single theme that works in both modes
      mermaid.initialize({
        startOnLoad: false,
        theme: 'dark',
        themeVariables: {
          primaryColor: '#8b5cf6',
          primaryTextColor: '#f3f4f6',
          primaryBorderColor: '#8b5cf6',
          lineColor: '#22d3ee',
          secondaryColor: '#1e293b',
          tertiaryColor: '#334155',
          background: '#1e293b',
          mainBkg: '#1e293b',
          secondaryBkg: '#334155',
          textColor: '#f3f4f6',
          fontSize: '16px',
          fontFamily: 'Inter, system-ui, sans-serif',
          // Edge label styling
          edgeLabelBackground: '#1e293b',
          labelBackground: '#1e293b',
          labelColor: '#f3f4f6',
        },
        flowchart: {
          curve: 'basis',
          lineWidth: 3,
          padding: 20,
          diagramPadding: 8,
          htmlLabels: true,
          rankSpacing: 50,
          nodeSpacing: 50,
        },
        securityLevel: 'loose',
      });

      // Process and render mermaid diagrams
      document.addEventListener('DOMContentLoaded', () => {
        // First, preserve expressive-code CSS/JS if present
        const firstExpressiveCode = document.querySelector('.expressive-code');
        let expressiveCodeAssets = null;

        if (firstExpressiveCode) {
          // Extract link and script tags from the first expressive-code block
          const linkTag = firstExpressiveCode.querySelector('link[rel="stylesheet"]');
          const scriptTag = firstExpressiveCode.querySelector('script[type="module"]');

          if (linkTag || scriptTag) {
            expressiveCodeAssets = {
              link: linkTag?.cloneNode(true),
              script: scriptTag?.cloneNode(true),
            };
          }
        }

        const mermaidBlocks = document.querySelectorAll('pre[data-language="mermaid"]');

        mermaidBlocks.forEach((pre, index) => {
          // Get the parent expressive-code container
          const expressiveContainer = pre.closest('.expressive-code');

          const copyButton = expressiveContainer?.querySelector('.copy button[data-code]');
          let code = copyButton?.getAttribute('data-code') || '';

          if (!code) {
            console.error('Mermaid: Could not find code for diagram');
            return;
          }

          // Fix: expressive-code replaces newlines with 4 spaces
          code = code.replace(/    /g, '\n').replace(/\u007f/g, '\n');

          // Force vertical orientation (Top-Down) for all diagrams
          // Replace horizontal orientations (LR, RL) with TD (Top-Down)
          code = code.replace(/graph\s+(LR|RL)/gi, 'graph TD');
          code = code.replace(/flowchart\s+(LR|RL)/gi, 'flowchart TD');

          // Create mermaid container with same structure as expressive-code
          const container = document.createElement('div');
          container.className = 'expressive-code mermaid-diagram';

          // If this is the first mermaid block and we have assets, preserve them
          if (index === 0 && expressiveCodeAssets) {
            if (expressiveCodeAssets.link) {
              container.appendChild(expressiveCodeAssets.link);
            }
            if (expressiveCodeAssets.script) {
              container.appendChild(expressiveCodeAssets.script);
            }
          }

          const figure = document.createElement('figure');
          figure.className = 'frame';

          const mermaidDiv = document.createElement('div');
          mermaidDiv.className = 'mermaid';
          mermaidDiv.textContent = code;

          figure.appendChild(mermaidDiv);
          container.appendChild(figure);

          // Replace the expressive-code container
          if (expressiveContainer) {
            expressiveContainer.replaceWith(container);
          } else {
            pre.replaceWith(container);
          }
        });

        // Render all diagrams
        mermaid.run().then(() => {
          // After rendering, add padding to edge labels
          document.querySelectorAll('.mermaid svg g.edgeLabel').forEach((label) => {
            const rect = label.querySelector('rect');
            const text = label.querySelector('text');

            if (rect && text) {
              // Get current dimensions
              const currentWidth = parseFloat(rect.getAttribute('width') || 0);
              const currentHeight = parseFloat(rect.getAttribute('height') || 0);
              const currentX = parseFloat(rect.getAttribute('x') || 0);
              const currentY = parseFloat(rect.getAttribute('y') || 0);

              // Add padding (8px on each side = 16px total)
              const padding = 8;
              rect.setAttribute('width', currentWidth + padding * 2);
              rect.setAttribute('height', currentHeight + padding * 2);
              rect.setAttribute('x', currentX - padding);
              rect.setAttribute('y', currentY - padding);

              // Add rounded corners and styling
              rect.setAttribute('rx', '4');
              rect.setAttribute('ry', '4');
              rect.setAttribute('fill', '#1e293b');
              rect.setAttribute('stroke', '#8b5cf6');
              rect.setAttribute('stroke-width', '1');
            }
          });
        });
      });
    </script>
    
    <!-- Smooth scroll for anchor links -->
    <script src="/src/scripts/smoothScroll.js" type="module"></script>
  </body>
</html>

<style is:global>
  @import '../styles/global.css';
</style>
