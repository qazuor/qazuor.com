---
import { normalizeTrailingSlash } from '@reunmedia/astro-normalize-trailing-slash';
import { getLangFromUrl, getTranslations, translatePath } from '../../i18n/utils';
import { CommandButton } from '../interactive/CommandButton';
import { LanguageSelector } from '../interactive/LanguageSelector';
import { ThemeToggle } from '../interactive/ThemeToggle';

const lang = getLangFromUrl(Astro.url);
const t = getTranslations(lang);
const currentPath = Astro.url.pathname;

// Check if we're on the home page for navigation logic
const isHomePage =
    currentPath === translatePath('/', lang) || currentPath === `/${lang}` || currentPath === `/${lang}/`;

const navItems = [
    { href: `${translatePath('/', lang)}#about`, label: t('nav.about') },
    { href: `${translatePath('/', lang)}#skills`, label: t('nav.skills') },
    { href: `${translatePath('/', lang)}#projects`, label: t('nav.projects') },
    {
        href: isHomePage ? `${translatePath('/', lang)}#blog` : translatePath('/blog', lang),
        label: t('nav.blog')
    },
    { href: `${translatePath('/', lang)}#services`, label: t('nav.services') },
    { href: `${translatePath('/', lang)}#testimonials`, label: t('nav.testimonials') },
    { href: translatePath('/tools', lang), label: t('nav.tools') },
    { href: `${translatePath('/', lang)}#contact`, label: t('nav.contact') }
];

const isActive = (href: string) => {
    // Handle home page anchor links - don't mark as active server-side
    // Active state will be handled by JavaScript based on scroll position
    if (href.includes('#')) {
        return false; // Let JavaScript handle active state for anchor links
    }

    // Handle regular page links
    if (href === translatePath('/', lang)) {
        return currentPath === href || currentPath === `/${lang}` || currentPath === `/${lang}/`;
    }

    return currentPath.startsWith(href);
};
---

<nav class="glass sticky top-0 z-50 border-b mobile-nav-hidden" id="main-nav">
    <div class="container-custom">
        <div class="flex justify-between items-center h-14">
            <!-- Logo with Avatar -->
            <a
                href={translatePath('/#hero', lang)}
                class="logo flex items-center gap-3 hover:scale-105 transition-transform duration-base"
            >
                <div
                    class="w-8 h-8 rounded-full overflow-hidden border-2 border-primary/20 hover:border-primary/50 transition-colors"
                >
                    <img src="/avatar.png" alt="qazuor avatar" class="w-full h-full object-cover" loading="eager" />
                </div>
                <span class="text-xl font-bold gradient-text">qazuor</span>
            </a>

            <!-- Desktop Navigation -->
            <div class="hidden md:flex items-center gap-8">
                {
                    navItems.map((item) => (
                        <a
                            href={item.href.includes('#') ? item.href : normalizeTrailingSlash(item.href)}
                            class={`nav-link text-xs font-medium transition-all duration-base relative group ${
                                isActive(item.href) ? 'text-primary' : 'text-foreground-secondary hover:text-foreground'
                            }`}
                            data-is-anchor={item.href.includes('#') ? 'true' : 'false'}
                            data-is-home-page={isHomePage ? 'true' : 'false'}
                        >
                            {item.label}
                            {/* Underline animation */}
                            <span
                                class={`absolute -bottom-1 left-0 h-0.5 bg-gradient-to-r from-primary to-secondary transition-all duration-base ${
                                    isActive(item.href) ? 'w-full' : 'w-0 group-hover:w-full'
                                }`}
                            />
                        </a>
                    ))
                }
            </div>

            <!-- Actions -->
            <div class="hidden md:flex items-center gap-2">
                <CommandButton ariaLabel={t('aria.openCommandPalette')} client:load />
                <LanguageSelector currentLocale={lang} client:load />
                <ThemeToggle ariaLabel={t('aria.toggleTheme')} client:load />
            </div>

            <!-- Mobile menu button -->
            <button
                id="mobile-menu-button"
                class="md:hidden p-1.5 rounded-lg text-foreground-secondary hover:bg-foreground/5 transition-colors duration-base"
                aria-label={t('aria.toggleMenu')}
            >
                <svg id="menu-icon" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"
                    ></path>
                </svg>
                <svg id="close-icon" class="w-5 h-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"
                    ></path>
                </svg>
            </button>
        </div>

        <!-- Mobile Navigation -->
        <div id="mobile-menu" class="hidden md:hidden pb-4 space-y-2">
            {
                navItems.map((item) => (
                    <a
                        href={normalizeTrailingSlash(item.href)}
                        class={`nav-link-mobile block px-4 py-3 text-xs font-medium transition-all duration-base ${
                            isActive(item.href)
                                ? 'bg-primary/10 text-primary'
                                : 'text-foreground-secondary hover:bg-foreground/5 hover:text-foreground'
                        }`}
                        data-is-anchor={item.href.includes('#') ? 'true' : 'false'}
                        data-is-home-page={isHomePage ? 'true' : 'false'}
                    >
                        {item.label}
                    </a>
                ))
            }
            <div class="flex items-center gap-2 px-4 pt-2 border-t border-foreground/10">
                <CommandButton ariaLabel={t('aria.openCommandPalette')} client:load />
                <LanguageSelector currentLocale={lang} client:load />
                <ThemeToggle client:load />
            </div>
        </div>
    </div>
</nav>

<script>
    // Mobile menu toggle
    const button = document.getElementById('mobile-menu-button');
    const menu = document.getElementById('mobile-menu');
    const menuIcon = document.getElementById('menu-icon');
    const closeIcon = document.getElementById('close-icon');

    button?.addEventListener('click', () => {
        const isHidden = menu?.classList.contains('hidden');
        if (isHidden) {
            menu?.classList.remove('hidden');
            menuIcon?.classList.add('hidden');
            closeIcon?.classList.remove('hidden');
        } else {
            menu?.classList.add('hidden');
            menuIcon?.classList.remove('hidden');
            closeIcon?.classList.add('hidden');
        }
    });

    // Check if we're on home page
    function isHomePage() {
        const path = window.location.pathname;
        return path === '/' || path === '/en' || path === '/es' || path === '/en/' || path === '/es/';
    }

    // Smooth scroll functionality
    function smoothScrollTo(targetY: number, duration = 1200): void {
        const startY = window.pageYOffset;
        const distance = targetY - startY;
        let startTime: number | null = null;

        function animation(currentTime: number): void {
            if (startTime === null) startTime = currentTime;
            const timeElapsed = currentTime - startTime;
            const progress = Math.min(timeElapsed / duration, 1);

            const ease =
                progress < 0.5
                    ? 4 * progress * progress * progress
                    : (progress - 1) * (2 * progress - 2) * (2 * progress - 2) + 1;

            window.scrollTo(0, startY + distance * ease);

            if (progress < 1) {
                requestAnimationFrame(animation);
            }
        }
        requestAnimationFrame(animation);
    }

    // Mobile navigation hide/show on scroll
    function setupMobileNavigation() {
        const nav = document.getElementById('main-nav');
        let scrollTimeout: NodeJS.Timeout | undefined;

        function updateNavVisibility() {
            const currentScrollY = window.scrollY;
            const isDesktop = window.innerWidth >= 768; // md breakpoint

            if (isDesktop) {
                // Always show on desktop, remove mobile classes
                nav?.classList.remove('mobile-nav-hidden', 'mobile-nav-slide-up', 'mobile-nav-slide-down');
                return;
            }

            // Mobile behavior: hide only when at absolute top (scroll 0)
            if (currentScrollY === 0) {
                // Hide when at top with slide up animation
                nav?.classList.remove('mobile-nav-slide-down');
                nav?.classList.add('mobile-nav-slide-up');
                // After animation completes, hide completely
                setTimeout(() => {
                    if (window.scrollY === 0) {
                        nav?.classList.add('mobile-nav-hidden');
                    }
                }, 300);
            } else {
                // Show when scrolling down from top with slide down animation
                if (nav?.classList.contains('mobile-nav-hidden')) {
                    nav?.classList.remove('mobile-nav-hidden', 'mobile-nav-slide-up');
                    nav?.classList.add('mobile-nav-slide-down');
                }
            }
        }

        // Handle scroll with throttling
        function handleScroll() {
            if (scrollTimeout) clearTimeout(scrollTimeout);
            scrollTimeout = setTimeout(updateNavVisibility, 10);
        }

        // Handle resize
        function handleResize() {
            updateNavVisibility();
        }

        // Initial setup
        updateNavVisibility();

        // Event listeners
        window.addEventListener('scroll', handleScroll, { passive: true });
        window.addEventListener('resize', handleResize);
    }

    // Handle scroll-based navigation highlighting
    function setupScrollNavigation() {
        if (!isHomePage()) return;

        const sections = document.querySelectorAll('section[id]');
        const navLinks = document.querySelectorAll('.nav-link[data-is-anchor="true"]');
        const mobileNavLinks = document.querySelectorAll('.nav-link-mobile[data-is-anchor="true"]');

        if (sections.length === 0) return;

        // Function to update active link
        function updateActiveLink(activeId: string): void {
            // Update desktop links
            navLinks.forEach((link) => {
                const href = link.getAttribute('href') || '';
                const isActive = href.endsWith(`#${activeId}`);
                const underline = link.querySelector('span');

                if (isActive) {
                    link.classList.remove('text-foreground-secondary');
                    link.classList.add('text-primary');
                    underline?.classList.remove('w-0');
                    underline?.classList.add('w-full');
                } else {
                    link.classList.remove('text-primary');
                    link.classList.add('text-foreground-secondary');
                    underline?.classList.remove('w-full');
                    underline?.classList.add('w-0');
                }
            });

            // Update mobile links
            mobileNavLinks.forEach((link) => {
                const href = link.getAttribute('href') || '';
                const isActive = href.endsWith(`#${activeId}`);

                if (isActive) {
                    link.classList.remove('text-foreground-secondary');
                    link.classList.add('text-primary', 'bg-primary/10');
                } else {
                    link.classList.remove('text-primary', 'bg-primary/10');
                    link.classList.add('text-foreground-secondary');
                }
            });
        }

        // Intersection Observer for scroll detection
        const observerOptions = {
            root: null,
            rootMargin: '-20% 0px -80% 0px',
            threshold: 0
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach((entry) => {
                if (entry.isIntersecting) {
                    updateActiveLink(entry.target.id);
                }
            });
        }, observerOptions);

        sections.forEach((section) => {
            observer.observe(section);
        });

        // Handle scroll to top (clear active states)
        window.addEventListener('scroll', () => {
            if (window.pageYOffset < 100) {
                navLinks.forEach((link) => {
                    link.classList.remove('text-primary');
                    link.classList.add('text-foreground-secondary');
                    const underline = link.querySelector('span');
                    underline?.classList.remove('w-full');
                    underline?.classList.add('w-0');
                });
                mobileNavLinks.forEach((link) => {
                    link.classList.remove('text-primary', 'bg-primary/10');
                    link.classList.add('text-foreground-secondary');
                });
            }
        });
    }

    // Handle smooth scroll clicks
    function setupSmoothScroll() {
        const anchorLinks = document.querySelectorAll('a[href*="#"]');

        anchorLinks.forEach((link) => {
            link.addEventListener('click', (e) => {
                const href = link.getAttribute('href') || '';

                if (href.includes('#') && isHomePage()) {
                    const url = new URL(href, window.location.origin);
                    const currentPath = window.location.pathname;

                    if (href.startsWith('#') || url.pathname === currentPath) {
                        e.preventDefault();
                        const targetId = url.hash.substring(1);
                        const targetElement = document.getElementById(targetId);

                        if (targetElement) {
                            if (!menu?.classList.contains('hidden')) {
                                menu?.classList.add('hidden');
                                menuIcon?.classList.remove('hidden');
                                closeIcon?.classList.add('hidden');
                            }

                            const header = document.querySelector('nav');
                            const headerHeight = header ? header.offsetHeight : 80;
                            const elementPosition = targetElement.getBoundingClientRect().top;
                            const offsetPosition = elementPosition + window.pageYOffset - headerHeight;

                            smoothScrollTo(offsetPosition);
                        }
                    }
                }
            });
        });
    }

    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
        setupMobileNavigation();
        setupScrollNavigation();
        setupSmoothScroll();
    });
</script>

<style>
    /* Mobile navigation hide/show styles */
    @media (max-width: 767px) {
        .mobile-nav-hidden {
            display: none !important;
        }

        /* Slide down animation - navbar appears */
        .mobile-nav-slide-down {
            animation: slideDown 0.3s ease-out forwards;
        }

        /* Slide up animation - navbar disappears */
        .mobile-nav-slide-up {
            animation: slideUp 0.3s ease-in forwards;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                transform: translateY(0);
                opacity: 1;
            }
            to {
                transform: translateY(-100%);
                opacity: 0;
            }
        }
    }
</style>
