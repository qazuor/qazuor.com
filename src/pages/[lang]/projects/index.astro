---
import { getImage } from 'astro:assets';
import type { CollectionEntry } from 'astro:content';
import { getCollection } from 'astro:content';
import type { ImageMetadata } from 'astro';
import { ProjectCard } from '@/components/cards/ProjectCard';
import { ProjectFiltersManager } from '@/components/sections/ProjectFiltersManager';
import AnimatedGradientBackground from '@/components/ui/AnimatedGradientBackground.astro';
import SecondaryTitle from '@/components/ui/SecondaryTitle.astro';
import SectionTitle from '@/components/ui/SectionTitle.astro';
import { sectionsColors } from '@/data';
import { languages } from '@/i18n/ui';
import { getLangFromUrl, getTranslations } from '@/i18n/utils';
import BaseLayout from '@/layouts/BaseLayout.astro';

export function getStaticPaths() {
    return Object.keys(languages).map((lang) => ({
        params: { lang }
    }));
}

const lang = getLangFromUrl(Astro.url);
const t = getTranslations(lang);

// Load Content Collections
const allProjects = await getCollection('projects');

// Sort projects: featured first, then by order field, then by date
const sortedProjects = await Promise.all(
    allProjects
        .sort((a: CollectionEntry<'projects'>, b: CollectionEntry<'projects'>) => {
            // Featured projects come first
            const aFeatured = a.data.featured || false;
            const bFeatured = b.data.featured || false;
            if (aFeatured !== bFeatured) {
                return bFeatured ? 1 : -1;
            }
            // Then by order
            if (a.data.order !== b.data.order) {
                return a.data.order - b.data.order;
            }
            // Finally by date
            return b.data.publishDate.getTime() - a.data.publishDate.getTime();
        })
        .map(async (project: CollectionEntry<'projects'>) => {
            const processedImages = await Promise.all(
                project.data.images.map(async (img: ImageMetadata) => {
                    const optimizedImg = await getImage({ src: img });
                    return optimizedImg.src;
                })
            );
            return {
                title: project.data.title,
                description: project.data.description,
                slug: project.data.slug || project.slug,
                category: project.data.category as 'open-source' | 'commercial' | 'client',
                technologies: project.data.technologies,
                images: processedImages,
                featured: project.data.featured || false,
                order: project.data.order
            };
        })
);

// Group projects by category
const projectsByCategory = {
    'open-source': sortedProjects.filter((p) => p.category === 'open-source'),
    commercial: sortedProjects.filter((p) => p.category === 'commercial'),
    client: sortedProjects.filter((p) => p.category === 'client')
};

// Translations
const pageTitle = `${t('projects.title')} - qazuor.com`;
const translations = {
    title: t('projects.title', { markdown: true }),
    subtitle: t('projects.subtitle', { markdown: true }),
    noResults: t('projects.noResults')
};

const filterTranslations = {
    filterButton: t('projects.filters.filterButton'),
    searchPlaceholder: t('projects.filters.searchPlaceholder'),
    selectAll: t('projects.filters.selectAll'),
    clearAll: t('projects.filters.clearAll'),
    activeFilters: t('projects.filters.activeFilters'),
    activeFiltersLabel: t('projects.filters.activeFiltersLabel'),
    moreFilters: t('projects.filters.moreFilters'),
    clearFilters: t('projects.filters.clearFilters'),
    noResults: t('projects.filters.noResults')
};

const categoryTitles = {
    'open-source': t('projects.categoryTitles.openSource'),
    commercial: t('projects.categoryTitles.commercial'),
    client: t('projects.categoryTitles.client')
};

const cardTranslations = {
    viewProject: t('projects.card.viewProject'),
    categories: {
        openSource: t('projects.card.categories.openSource'),
        commercial: t('projects.card.categories.commercial'),
        client: t('projects.card.categories.client')
    },
    moreTechnologies: t('projects.card.moreTechnologies')
};
---

<BaseLayout title={pageTitle}>
	<section class="relative min-h-screen overflow-hidden" style={`background-color: ${sectionsColors.projects}`}>
		<!-- Animated Gradient Background -->
		<AnimatedGradientBackground />

		<div class="container-custom py-16 relative z-10">
			<!-- Section Title -->
			<SectionTitle title={translations.title} subtitle={translations.subtitle} />

			<!-- Filter Section with React Component -->
			<ProjectFiltersManager
				client:only="react"
				filterTranslations={filterTranslations}
			/>

			<!-- Categories Container -->
			<div id="categories-container">
			{
				Object.entries(projectsByCategory).map(([category, projects]) => {
					if (projects.length === 0) return null;

					return (
						<div class="mb-16 category-section" data-category={category}>
							<div class="mb-8 flex items-center gap-3">
								<span class="w-2 h-8 bg-primary rounded-full" />
								<SecondaryTitle
									text={categoryTitles[category as keyof typeof categoryTitles]}
									element="h2"
									size="xl"
									showHtml={false}
								/>
								<span class="category-count text-lg font-normal text-foreground-secondary">
									({projects.length})
								</span>
							</div>

							<div class="projects-grid flex flex-wrap -mx-3">
								{projects.map((project) => (
									<div
										class="project-card w-full md:w-1/2 lg:w-1/3 px-3 mb-6"
										data-technologies={JSON.stringify(project.technologies)}
									>
										<ProjectCard
											client:load
											title={project.title}
											description={project.description}
											technologies={project.technologies}
											images={project.images}
											slug={project.slug}
											variant="list"
											lang={lang}
											category={project.category}
											featured={project.featured}
											translations={cardTranslations}
										/>
									</div>
								))}
							</div>
						</div>
					);
				})
			}
			</div>

			<!-- Empty State -->
			<div id="empty-state" class="hidden text-center py-16">
				<svg
					class="w-24 h-24 mx-auto mb-4 text-foreground-secondary opacity-50"
					fill="none"
					stroke="currentColor"
					viewBox="0 0 24 24"
				>
					<path
						stroke-linecap="round"
						stroke-linejoin="round"
						stroke-width="1.5"
						d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
					></path>
				</svg>
				<p class="text-foreground-secondary text-lg">{translations.noResults}</p>
			</div>
		</div>
	</section>
</BaseLayout>
