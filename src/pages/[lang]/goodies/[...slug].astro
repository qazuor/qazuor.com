---
import type { CollectionEntry } from 'astro:content';
import { getCollection } from 'astro:content';
import AnimatedGradientBackground from '@/components/ui/AnimatedGradientBackground.astro';
import { sectionsColors } from '@/data/colors';
import { languages } from '@/i18n/ui';
import { getLangFromUrl, getTranslations, translatePath } from '@/i18n/utils';
import BaseLayout from '@/layouts/BaseLayout.astro';

export async function getStaticPaths() {
    const tools = await getCollection('tools');
    const paths: Array<{
        params: { lang: string; slug: string };
        props: { tool: CollectionEntry<'tools'> };
    }> = [];

    // Generate paths for each language
    const langs = Object.keys(languages);

    langs.forEach((lang: string) => {
        tools.forEach((tool: CollectionEntry<'tools'>) => {
            paths.push({
                params: {
                    lang,
                    slug: tool.slug
                },
                props: { tool }
            });
        });
    });

    return paths;
}

const { tool } = Astro.props;
const lang = getLangFromUrl(Astro.url);
const t = getTranslations(lang);
const { Content } = await tool.render();

const title = tool.data.title;
const description = tool.data.description;

const difficultyColors = {
    beginner: 'text-green-500 bg-green-500/10 border-green-500/20',
    intermediate: 'text-yellow-500 bg-yellow-500/10 border-yellow-500/20',
    advanced: 'text-red-500 bg-red-500/10 border-red-500/20'
};

const goodiesUrl = translatePath('/goodies', lang);
---

<BaseLayout title={title} description={description}>
    <div class="relative section overflow-hidden pt-32 pb-20" style={`background-color: ${sectionsColors.goodies}`}>
        <AnimatedGradientBackground />

        <article class="container-custom">
            <!-- Back Navigation -->
            <div class="mb-8">
                <a
                    href={goodiesUrl}
                    class="inline-flex items-center gap-2 text-foreground-secondary hover:text-primary transition-colors"
                >
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"
                        ></path>
                    </svg>
                    Back to Goodies
                </a>
            </div>

            <!-- Tool Header -->
            <header class="mb-12">
                <div class="flex flex-wrap items-start justify-between gap-6 mb-6">
                    <div class="flex-1 min-w-0">
                        <h1 class="text-xl md:text-2xl font-bold mb-4 leading-tight">
                            <span class="gradient-text">{tool.data.title}</span>
                        </h1>
                        <p class="text-sm md:text-base text-foreground-secondary leading-relaxed">
                            {tool.data.description}
                        </p>
                    </div>

                    <!-- Demo Button -->
                    <div class="flex-shrink-0">
                        {
                            tool.data.demo ? (
                                <button
                                    id="tryDemo"
                                    class="inline-flex items-center gap-2 px-6 py-3 bg-primary text-primary-foreground rounded-lg font-medium hover:bg-primary/90 transition-colors"
                                >
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M14.828 14.828a4 4 0 01-5.656 0M9 10h1m4 0h1m-6 4h.01M19 10a9 9 0 11-18 0 9 9 0 0118 0z"
                                        />
                                    </svg>
                                    {t('tools.tryDemo')}
                                </button>
                            ) : (
                                <span class="inline-flex items-center gap-2 px-6 py-3 bg-foreground/10 text-foreground-secondary rounded-lg font-medium cursor-not-allowed">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                                        />
                                    </svg>
                                    {t('tools.comingSoon')}
                                </span>
                            )
                        }
                    </div>
                </div>

                <!-- Meta Information -->
                <div class="flex flex-wrap items-center gap-4">
                    <span
                        class="inline-flex items-center px-4 py-2 rounded-full bg-primary/10 text-primary border border-primary/20 font-medium"
                    >
                        {tool.data.category}
                    </span>
                    <span
                        class={`inline-flex items-center px-4 py-2 rounded-full border font-medium ${difficultyColors[tool.data.difficulty as keyof typeof difficultyColors]}`}
                    >
                        {t(`tools.difficulty.${tool.data.difficulty}`)}
                    </span>
                    <span
                        class="inline-flex items-center px-4 py-2 rounded-full bg-foreground/5 text-foreground-secondary text-sm"
                    >
                        Updated {tool.data.updatedAt.toLocaleDateString()}
                    </span>
                </div>

                <!-- Tags -->
                <div class="flex flex-wrap gap-2 mt-4">
                    {
                        tool.data.tags.map((tag: string) => (
                            <span class="inline-flex items-center px-3 py-1 text-sm rounded-md bg-foreground/5 text-foreground-secondary">
                                #{tag}
                            </span>
                        ))
                    }
                </div>
            </header>

            <!-- Tool Demo/Placeholder -->
            <div class="mb-12">
                {
                    tool.data.demo ? (
                        <div id="toolDemo" class="hidden">
                            <div class="bg-card border border-foreground/10 rounded-lg p-8 mb-6">
                                <h3 class="text-xl font-semibold mb-4">Interactive Demo</h3>
                                <div class="bg-background rounded-lg p-6 border border-foreground/10">
                                    {/* Demo content will be loaded here */}
                                    <div class="text-center py-12 text-foreground-secondary">
                                        <svg
                                            class="w-16 h-16 mx-auto mb-4 opacity-50"
                                            fill="none"
                                            stroke="currentColor"
                                            viewBox="0 0 24 24"
                                        >
                                            <path
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                stroke-width="1"
                                                d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 7.172V5L8 4z"
                                            />
                                        </svg>
                                        <p>Demo component will be loaded here</p>
                                        <p class="text-sm mt-2">Click "Try Demo" to activate the interactive tool</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    ) : (
                        <div class="bg-card border border-foreground/10 rounded-lg p-8 mb-6">
                            <div class="text-center py-12 text-foreground-secondary">
                                <svg
                                    class="w-16 h-16 mx-auto mb-4 opacity-50"
                                    fill="none"
                                    stroke="currentColor"
                                    viewBox="0 0 24 24"
                                >
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="1"
                                        d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                                    />
                                </svg>
                                <h3 class="text-xl font-semibold mb-2">Coming Soon</h3>
                                <p>This tool is currently in development</p>
                            </div>
                        </div>
                    )
                }
            </div>

            <!-- Tool Documentation -->
            <div class="content-prose">
                <Content />
            </div>
        </div>
    </article>
</BaseLayout>

<script>
    function initToolDemo() {
        const tryDemoButton = document.getElementById('tryDemo');
        const toolDemo = document.getElementById('toolDemo');

        if (tryDemoButton && toolDemo) {
            tryDemoButton.addEventListener('click', () => {
                toolDemo.classList.toggle('hidden');
                toolDemo.scrollIntoView({ behavior: 'smooth', block: 'start' });
            });
        }
    }

    // Initialize on initial page load
    document.addEventListener('DOMContentLoaded', initToolDemo);

    // Re-initialize after View Transitions navigation
    document.addEventListener('astro:page-load', initToolDemo);
</script>
