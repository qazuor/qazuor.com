---
/**
 * PerformanceBadge Component
 *
 * Displays Lighthouse metrics in the footer.
 * Shows shared scores (A11y, BP, SEO) once, and Performance scores per device.
 * Metrics are auto-generated from PageSpeed Insights API during build.
 *
 * @example
 * <PerformanceBadge translations={translations} />
 */

import lighthouseMetrics from '@/data/lighthouse-metrics.json';

interface PerformanceMetrics {
    performance: {
        lcp: string;
        cls: string;
        fcp: string;
        tbt: string;
        si: string;
        score: string;
    };
    accessibility: {
        score: string;
    };
    bestPractices: {
        score: string;
    };
    seo: {
        score: string;
    };
}

interface Props {
    /** Translations */
    translations?: {
        title: string;
        desktop: string;
        mobile: string;
        performance: string;
        accessibility: string;
        bestPractices: string;
        seo: string;
        lcp: string;
        cls: string;
        fcp: string;
        autoGenerated: string;
        tooltips: {
            performance: string;
            accessibility: string;
            bestPractices: string;
            seo: string;
            lcp: string;
            cls: string;
            fcp: string;
        };
    };
}

// Get metrics from auto-generated JSON file
const desktop: PerformanceMetrics = lighthouseMetrics.desktop as PerformanceMetrics;
const mobile: PerformanceMetrics = lighthouseMetrics.mobile as PerformanceMetrics;

// Format the date for display (YYYY-MM format)
const lastUpdatedDate = new Date(lighthouseMetrics.lastUpdated);
const lastUpdated = `${lastUpdatedDate.getFullYear()}-${String(lastUpdatedDate.getMonth() + 1).padStart(2, '0')}`;

// Check if metrics are from PageSpeed Insights (auto-generated)
const isAutoGenerated = lighthouseMetrics.source === 'pagespeed-insights';

const {
    translations = {
        title: 'Lighthouse Scores',
        desktop: 'Desktop',
        mobile: 'Mobile',
        performance: 'Perf',
        accessibility: 'A11y',
        bestPractices: 'BP',
        seo: 'SEO',
        lcp: 'LCP',
        cls: 'CLS',
        fcp: 'FCP',
        autoGenerated: 'PageSpeed · auto-generated on build',
        tooltips: {
            performance: 'Performance Score',
            accessibility: 'Accessibility Score',
            bestPractices: 'Best Practices Score',
            seo: 'SEO Score',
            lcp: 'Largest Contentful Paint',
            cls: 'Cumulative Layout Shift',
            fcp: 'First Contentful Paint'
        }
    }
} = Astro.props;
---

<div class="performance-badge text-xs">
    <!-- Header with icon and title -->
    <div class="flex items-center gap-1.5 text-foreground-muted mb-1">
        <svg
            class="w-3.5 h-3.5 text-primary"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
        >
            <path d="M13 10V3L4 14h7v7l9-11h-7z"></path>
        </svg>
        <a
            href="https://pagespeed.web.dev/analysis?url=https%3A%2F%2Fqazuor.com"
            target="_blank"
            rel="noopener noreferrer"
            class="font-medium hover:text-primary transition-colors"
        >
            {translations.title}
        </a>
    </div>

    <!-- Source info: date + auto-generated note -->
    <div class="text-[9px] text-foreground-muted/50 mb-1.5">
        {lastUpdated} · {isAutoGenerated ? translations.autoGenerated : 'manual'}
    </div>

    <!-- Two-column layout: Shared scores | Performance by device -->
    <div class="flex gap-6 text-[10px]">
        <!-- Left: Shared Scores (A11y, BP, SEO) -->
        <div class="flex flex-col gap-0.5">
            <span class="metric-item text-foreground-muted" data-tooltip={translations.tooltips.accessibility} data-tooltip-position="top">{translations.accessibility} <span class="text-primary font-mono">{desktop.accessibility.score}</span></span>
            <span class="metric-item text-foreground-muted" data-tooltip={translations.tooltips.bestPractices} data-tooltip-position="top">{translations.bestPractices} <span class="text-primary font-mono">{desktop.bestPractices.score}</span></span>
            <span class="metric-item text-foreground-muted" data-tooltip={translations.tooltips.seo} data-tooltip-position="top">{translations.seo} <span class="text-primary font-mono">{desktop.seo.score}</span></span>
        </div>

        <!-- Right: Performance by device with Web Vitals -->
        <div class="border-l border-foreground-muted/10 pl-4">
            <div class="grid grid-cols-[auto_1fr_1fr_1fr_1fr] gap-x-2 gap-y-0.5">
                <!-- Desktop Row -->
                <span class="text-foreground-muted/70">{translations.desktop}</span>
                <span class="metric-item text-foreground-muted" data-tooltip={translations.tooltips.performance} data-tooltip-position="top">{translations.performance} <span class="text-primary font-mono font-semibold">{desktop.performance.score}</span></span>
                <span class="metric-item text-foreground-muted/80" data-tooltip={translations.tooltips.lcp} data-tooltip-position="top">{translations.lcp} <span class="text-primary/80 font-mono">{desktop.performance.lcp}</span></span>
                <span class="metric-item text-foreground-muted/80" data-tooltip={translations.tooltips.fcp} data-tooltip-position="top">{translations.fcp} <span class="text-primary/80 font-mono">{desktop.performance.fcp}</span></span>
                <span class="metric-item text-foreground-muted/80" data-tooltip={translations.tooltips.cls} data-tooltip-position="top">{translations.cls} <span class="text-primary/80 font-mono">{desktop.performance.cls}</span></span>

                <!-- Mobile Row -->
                <span class="text-foreground-muted/70">{translations.mobile}</span>
                <span class="metric-item text-foreground-muted" data-tooltip={translations.tooltips.performance} data-tooltip-position="top">{translations.performance} <span class="text-primary font-mono font-semibold">{mobile.performance.score}</span></span>
                <span class="metric-item text-foreground-muted/80" data-tooltip={translations.tooltips.lcp} data-tooltip-position="top">{translations.lcp} <span class="text-primary/80 font-mono">{mobile.performance.lcp}</span></span>
                <span class="metric-item text-foreground-muted/80" data-tooltip={translations.tooltips.fcp} data-tooltip-position="top">{translations.fcp} <span class="text-primary/80 font-mono">{mobile.performance.fcp}</span></span>
                <span class="metric-item text-foreground-muted/80" data-tooltip={translations.tooltips.cls} data-tooltip-position="top">{translations.cls} <span class="text-primary/80 font-mono">{mobile.performance.cls}</span></span>
            </div>
        </div>
    </div>
</div>

<style>
    /* Metric item base */
    .metric-item {
        position: relative;
        cursor: help;
    }

    /* Tooltip arrow */
    .metric-item[data-tooltip]::before {
        content: "";
        position: absolute;
        top: -6px;
        left: 50%;
        transform: translateX(-50%);
        border-width: 4px 6px 0 6px;
        border-style: solid;
        z-index: 100;
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: none;
    }

    /* Tooltip text */
    .metric-item[data-tooltip]::after {
        content: attr(data-tooltip);
        position: absolute;
        left: 50%;
        top: -6px;
        transform: translateX(-50%) translateY(-100%);
        text-align: center;
        padding: 6px 10px;
        font-size: 11px;
        min-width: 80px;
        border-radius: 6px;
        pointer-events: none;
        z-index: 100;
        opacity: 0;
        transition: opacity 0.3s ease;
        white-space: nowrap;
        font-weight: 500;
    }

    /* Theme-specific tooltip colors - Dark theme */
    :global(html.dark) .metric-item[data-tooltip]::before {
        border-color: rgb(55 65 81) transparent transparent transparent; /* gray-700 */
    }

    :global(html.dark) .metric-item[data-tooltip]::after {
        background: rgb(55 65 81); /* gray-700 */
        color: rgb(229 231 235); /* gray-200 */
    }

    /* Theme-specific tooltip colors - Light theme */
    :global(html:not(.dark)) .metric-item[data-tooltip]::before {
        border-color: rgb(31 41 55) transparent transparent transparent; /* gray-800 */
    }

    :global(html:not(.dark)) .metric-item[data-tooltip]::after {
        background: rgb(31 41 55); /* gray-800 */
        color: rgb(243 244 246); /* gray-100 */
    }

    /* Show tooltip on hover */
    .metric-item[data-tooltip]:hover::after,
    .metric-item[data-tooltip]:hover::before {
        opacity: 1;
    }
</style>
