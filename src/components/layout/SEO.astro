---
import { rgbToHex, themeColors } from '@/config/colorHelpers';
import { contact } from '@/data';

/**
 * SEO Component
 *
 * Comprehensive SEO optimization including:
 * - Open Graph tags
 * - JSON-LD structured data (Article, Person, WebSite)
 * - Breadcrumbs JSON-LD for navigation context
 * - Canonical URLs
 * - Meta keywords
 * - LLM optimization (ai:* meta tags)
 */

export interface SEOProps {
    title: string;
    description: string;
    canonical?: string;
    image?: string;
    imageAlt?: string;
    imageWidth?: number;
    imageHeight?: number;
    type?: 'website' | 'article' | 'profile';
    keywords?: string[];
    author?: string;
    publishDate?: string;
    modifiedDate?: string;
    locale?: string;
    articleTags?: string[];
    noindex?: boolean;
    nofollow?: boolean;
    breadcrumbs?: Array<{ name: string; url: string }>;
    jobTitle?: string;
    twitterHandle?: string;
    socialLinks?: {
        github?: string;
        linkedin?: string;
        fiverr?: string;
        upwork?: string;
    };
}

const {
    title,
    description,
    canonical,
    image,
    imageAlt = 'qazuor - Full-Stack Developer',
    imageWidth = 1200,
    imageHeight = 630,
    type = 'website',
    keywords = [],
    author = 'qazuor',
    publishDate,
    modifiedDate,
    locale = 'en',
    articleTags = [],
    noindex = false,
    nofollow = false,
    breadcrumbs,
    jobTitle = 'Full-Stack Developer',
    twitterHandle,
    socialLinks = {
        github: contact.social.github,
        linkedin: contact.social.linkedin,
        fiverr: contact.social.fiverr,
        upwork: contact.social.upwork
    }
} = Astro.props;

// Generate dynamic OG image path based on current URL
// For /en/ -> /en/og.png, for /en/blog/my-post -> /en/blog/my-post/og.png
function getDefaultOgImagePath(pathname: string): string {
    // Remove trailing slash if present
    const cleanPath = pathname.endsWith('/') ? pathname.slice(0, -1) : pathname;

    // If it's the root of a language (e.g., /en, /es), use /[lang]/og.png
    if (/^\/[a-z]{2}$/.test(cleanPath)) {
        return `${cleanPath}/og.png`;
    }

    // For other pages, append /og.png to the path
    return `${cleanPath}/og.png`;
}

// Use provided image or generate path dynamically
const ogImagePath = image || getDefaultOgImagePath(Astro.url.pathname);

// Determine image type from extension
const imageExtension = ogImagePath.split('.').pop()?.toLowerCase();
const imageType =
    imageExtension === 'png'
        ? 'image/png'
        : imageExtension === 'jpg' || imageExtension === 'jpeg'
          ? 'image/jpeg'
          : 'image/png';

// Get the full URL for the current page
const currentURL = new URL(Astro.url.pathname, Astro.site);
const canonicalURL = canonical ? new URL(canonical, Astro.site) : currentURL;

// Full image URL for social media
const imageURL = new URL(ogImagePath, Astro.site);

// Site configuration
const siteName = 'qazuor.com';
const siteTagline = 'Full Stack Developer';

// Build full page title with site branding
const fullTitle = `${title} | ${siteName} - ${siteTagline}`;

// Map locale to OpenGraph format (e.g., 'en' -> 'en_US', 'es' -> 'es_ES')
const ogLocaleMap: Record<string, string> = {
    en: 'en_US',
    es: 'es_ES'
};
const ogLocale = ogLocaleMap[locale] || `${locale}_${locale.toUpperCase()}`;
const ogLocaleAlternates = Object.values(ogLocaleMap).filter((l) => l !== ogLocale);

// Robots meta
const robotsContent = `${noindex ? 'noindex' : 'index'}, ${nofollow ? 'nofollow' : 'follow'}`;

// JSON-LD structured data
const jsonLd = {
    '@context': 'https://schema.org',
    '@type': type === 'article' ? 'Article' : type === 'profile' ? 'Person' : 'WebSite',
    name: type === 'article' ? title : siteName,
    headline: title,
    description: description,
    url: canonicalURL.href,
    image: imageURL.href,
    ...(type === 'article' && {
        author: {
            '@type': 'Person',
            name: author,
            url: Astro.site?.href
        },
        publisher: {
            '@type': 'Person',
            name: author
        },
        datePublished: publishDate,
        dateModified: modifiedDate || publishDate,
        keywords: articleTags.join(', ')
    }),
    ...(type === 'profile' && {
        '@type': 'Person',
        name: author,
        jobTitle: jobTitle,
        url: Astro.site?.href,
        sameAs: [socialLinks.github, socialLinks.linkedin, socialLinks.fiverr, socialLinks.upwork].filter(Boolean)
    })
};

// Breadcrumbs JSON-LD (optional, great for SEO and AI understanding)
const breadcrumbsJsonLd =
    breadcrumbs && breadcrumbs.length > 0
        ? {
              '@context': 'https://schema.org',
              '@type': 'BreadcrumbList',
              itemListElement: breadcrumbs.map((crumb: { name: string; url: string }, index: number) => ({
                  '@type': 'ListItem',
                  position: index + 1,
                  name: crumb.name,
                  item: new URL(crumb.url, Astro.site).href
              }))
          }
        : null;
---

<!-- Document Title -->
<title>{fullTitle}</title>

<!-- Primary Meta Tags -->
<meta name="title" content={fullTitle} />
<meta name="description" content={description} />
{keywords.length > 0 && <meta name="keywords" content={keywords.join(', ')} />}
<meta name="author" content={author} />
<meta name="robots" content={robotsContent} />
<link rel="canonical" href={canonicalURL.href} />

<!-- Open Graph / Facebook -->
<meta property="og:type" content={type} />
<meta property="og:url" content={canonicalURL.href} />
<meta property="og:title" content={fullTitle} />
<meta property="og:description" content={description} />
<meta property="og:image" content={imageURL.href} />
<meta property="og:image:secure_url" content={imageURL.href} />
<meta property="og:image:type" content={imageType} />
<meta property="og:image:width" content={String(imageWidth)} />
<meta property="og:image:height" content={String(imageHeight)} />
<meta property="og:image:alt" content={imageAlt} />
<meta property="og:site_name" content={siteName} />
<meta property="og:locale" content={ogLocale} />
{ogLocaleAlternates.map((altLocale) => (
    <meta property="og:locale:alternate" content={altLocale} />
))}

<!-- Twitter Card -->
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:url" content={canonicalURL.href} />
<meta name="twitter:title" content={fullTitle} />
<meta name="twitter:description" content={description} />
<meta name="twitter:image" content={imageURL.href} />
<meta name="twitter:image:alt" content={imageAlt} />
{twitterHandle && <meta name="twitter:site" content={twitterHandle} />}
{twitterHandle && <meta name="twitter:creator" content={twitterHandle} />}

<!-- Article specific tags -->
{
    type === 'article' && publishDate && (
        <>
            <meta property="article:published_time" content={publishDate} />
            {modifiedDate && <meta property="article:modified_time" content={modifiedDate} />}
            <meta property="article:author" content={author} />
            {articleTags.map((tag: string) => (
                <meta property="article:tag" content={tag} />
            ))}
        </>
    )
}

<!-- Additional SEO -->
<meta name="format-detection" content="telephone=no" />
<meta name="theme-color" content={rgbToHex(themeColors.primary)} />

<!-- LLM Optimization - Semantic markup for AI understanding -->
<meta name="ai:summary" content={description} />
<meta name="ai:content-type" content={type} />
{keywords.length > 0 && <meta name="ai:keywords" content={keywords.join(', ')} />}

<!-- JSON-LD Structured Data -->
<script type="application/ld+json" is:inline set:html={JSON.stringify(jsonLd)} />

<!-- Breadcrumbs JSON-LD (if provided) -->
{breadcrumbsJsonLd && <script type="application/ld+json" is:inline set:html={JSON.stringify(breadcrumbsJsonLd)} />}
