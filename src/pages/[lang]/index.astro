---
import { getCollection } from 'astro:content';
import AboutSection from '../../components/AboutSection.astro';
import BlogSection from '../../components/BlogSection.astro';
import { Contact } from '../../components/Contact';
import HeroSection from '../../components/HeroSection.astro';
import ProjectsSection from '../../components/ProjectsSection.astro';
import SkillsSection from '../../components/SkillsSection.astro';
import TestimonialsSection from '../../components/TestimonialsSection.astro';
import { contact } from '../../data';
import { languages } from '../../i18n/ui';
import { getLangFromUrl, getTranslations } from '../../i18n/utils';
import BaseLayout from '../../layouts/BaseLayout.astro';

export function getStaticPaths() {
  return Object.keys(languages).map((lang) => ({
    params: { lang },
  }));
}

const lang = getLangFromUrl(Astro.url);
const t = getTranslations(lang);

const title = t('seo.title');
const description = t('home.description');

// SEO keywords - definidos directamente ya que las traducciones no manejan bien arrays
const seoKeywords =
  lang === 'es'
    ? [
        'Desarrollador Full-Stack',
        'React',
        'TypeScript',
        'Desarrollo Web',
        'UI/UX',
        'JavaScript',
        'Node.js',
        'Astro',
        'TailwindCSS',
        'Portafolio',
      ]
    : [
        'Full-Stack Developer',
        'React',
        'TypeScript',
        'Web Development',
        'UI/UX',
        'JavaScript',
        'Node.js',
        'Astro',
        'TailwindCSS',
        'Portfolio',
      ];

// Load Content Collections
const allProjects = await getCollection('projects');
const allBlogPosts = await getCollection('blog');
const allTestimonials = await getCollection('testimonials');

// Sort projects by order field, then by date
const sortedProjects = allProjects
  .sort((a, b) => {
    if (a.data.order !== b.data.order) {
      return a.data.order - b.data.order;
    }
    return b.data.publishDate.getTime() - a.data.publishDate.getTime();
  })
  .map((project) => ({
    title: project.data.title,
    description: project.data.description,
    tags: project.data.tags,
    image: project.data.image,
    demoUrl: project.data.demoUrl,
    codeUrl: project.data.codeUrl,
    featured: project.data.featured,
  }));

// Sort blog posts by date (newest first) and filter out drafts
const sortedBlogPosts = allBlogPosts
  .filter((post) => !post.data.draft)
  .sort((a, b) => b.data.publishDate.getTime() - a.data.publishDate.getTime())
  .map((post) => ({
    title: post.data.title,
    excerpt: post.data.excerpt,
    date: post.data.publishDate.toISOString().split('T')[0],
    readTime: post.data.readTime,
    tags: post.data.tags,
    slug: `/${lang}/blog/${post.slug}`,
  }));

// Sort testimonials by order and date
const sortedTestimonials = allTestimonials
  .sort((a, b) => {
    if (a.data.order !== b.data.order) {
      return a.data.order - b.data.order;
    }
    return b.data.date.getTime() - a.data.date.getTime();
  })
  .map((testimonial) => ({
    name: testimonial.data.name,
    role: testimonial.data.role,
    company: testimonial.data.company,
    content: testimonial.data.content,
    avatar: testimonial.data.avatar,
    linkedinUrl: testimonial.data.linkedinUrl,
    twitterUrl: testimonial.data.twitterUrl,
    source: testimonial.data.source,
  }));

// Translations for components
const heroTranslations = {
  iMadeText: t('home.hero.iMadeText'),
  viewProjects: t('home.hero.viewProjects'),
  getInTouch: t('home.hero.getInTouch'),
  scroll: t('home.hero.scroll'),
};

const heroAriaLabels = {
  github: t('aria.github'),
  twitter: t('aria.twitter'),
  linkedin: t('aria.linkedin'),
};

const aboutTranslations = {
  title: t('about.title'),
  subtitle: t('about.subtitle'),
  connect: t('about.connect'),
};

const skillsTranslations = {
  title: t('skills.title'),
  subtitle: t('skills.subtitle'),
  categoryTitles: {
    frontend: t('skills.categories.frontend'),
    backend: t('skills.categories.backend'),
    tools: t('skills.categories.tools'),
  },
};

const projectsTranslations = {
  title: t('projects.title'),
  subtitle: t('projects.subtitle'),
  noProjects: t('projects.noProjects'),
  filterAll: t('projects.filterAll'),
};

const projectCardTranslations = {
  demo: t('projects.viewDemo'),
  code: t('projects.viewCode'),
  featured: t('projects.featured'),
};

const blogTranslations = {
  title: t('blog.title'),
  subtitle: t('blog.subtitle'),
  viewAll: t('blog.viewAll'),
  noArticles: t('blog.noArticles'),
  readMore: t('blog.readMore'),
  readTime: t('blog.readTime'),
};

const contactTranslations = {
  title: t('contact.title'),
  subtitle: t('contact.subtitle'),
  form: {
    name: t('contact.form.name'),
    email: t('contact.form.email'),
    subject: t('contact.form.subject'),
    message: t('contact.form.message'),
    send: t('contact.form.send'),
    sending: t('contact.form.sending'),
  },
  placeholders: {
    name: t('contact.placeholders.name'),
    email: t('contact.placeholders.email'),
    subject: t('contact.placeholders.subject'),
    message: t('contact.placeholders.message'),
  },
  errors: {
    nameRequired: t('contact.errors.nameRequired'),
    emailRequired: t('contact.errors.emailRequired'),
    emailInvalid: t('contact.errors.emailInvalid'),
    subjectRequired: t('contact.errors.subjectRequired'),
    messageRequired: t('contact.errors.messageRequired'),
    messageMinLength: t('contact.errors.messageMinLength'),
  },
  success: t('contact.success'),
  error: t('contact.error'),
};

const testimonialsTranslations = {
  title: t('testimonials.title'),
  subtitle: t('testimonials.subtitle'),
  noTestimonials: t('testimonials.noTestimonials'),
  readMore: t('testimonials.readMore'),
  readLess: t('testimonials.readLess'),
  viewProfile: t('testimonials.viewProfile'),
};
---

<BaseLayout
  title={title}
  description={description}
  imageAlt={t('seo.imageAlt')}
  type="profile"
  keywords={seoKeywords}
  author={t('profile.name')}
  jobTitle={t('profile.role')}
  socialLinks={{
    github: contact.social.github,
    twitter: contact.social.twitter,
    linkedin: contact.social.linkedin,
  }}
>
  <!-- Hero Section -->
  <HeroSection
    name={t('profile.name')}
    roles={[
      t('home.iMade.webapps'),
      t('home.iMade.interfaces'),
      t('home.iMade.solutions'),
      t('home.iMade.experiences'),
    ]}
    subtitle={t('home.hero.subtitle')}
    translations={heroTranslations}
    ariaLabels={heroAriaLabels}
  />

  <!-- About Section -->
  <AboutSection
    name={t('profile.name')}
    role={t('roles.fullstack')}
    location={contact.location}
    experience={t('profile.experience')}
    email={contact.email}
    availability={t('about.availability')}
    bio={t('about.bio')}
    translations={aboutTranslations}
  />

  <!-- Skills Section -->
  <SkillsSection translations={skillsTranslations} />

  <!-- Projects Section -->
  <ProjectsSection
    projects={sortedProjects}
    translations={projectsTranslations}
    cardTranslations={projectCardTranslations}
  />

  <!-- Blog Section -->
  <BlogSection posts={sortedBlogPosts} translations={blogTranslations} lang={lang} />

  <!-- Testimonials Section -->
  <TestimonialsSection testimonials={sortedTestimonials} translations={testimonialsTranslations} />

  <!-- Contact Section -->
  <Contact client:load translations={contactTranslations} />
</BaseLayout>
