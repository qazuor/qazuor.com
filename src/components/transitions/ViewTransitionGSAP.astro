---
/**
 * ViewTransitionGSAP Component - Production Implementation
 *
 * Integrates Astro View Transitions with custom GSAP animations.
 * Maintains the exact design and timing of the original PageTransition.astro
 * but fixes script execution issues by leveraging Astro's built-in system.
 *
 * Features:
 * - Black overlay slides up from bottom with rounded wave border
 * - Page title appears with fade-in and slide-up animation
 * - DOM swap happens invisibly behind overlay
 * - Overlay slides up and out revealing new page
 * - All scripts re-execute automatically via View Transitions
 *
 * Technical:
 * - Uses event.swap override for full timing control
 * - Uses transition:persist to maintain overlay across navigations
 * - Identical animation to original (0.6s + 0.4s + 0.3s = 1.3s total)
 */
import SectionTitle from '@/components/ui/SectionTitle.astro';
---

<!-- Transition overlay container with transition:persist -->
<div
    id="page-transition-overlay"
    transition:persist="page-transition-overlay"
    class="page-transition-overlay"
    aria-hidden="true"
>
    <!-- Wave border at top -->
    <div class="wave-top">
        <svg class="w-full h-32 md:h-40" viewBox="0 0 1200 120" preserveAspectRatio="none">
            <path
                d="M0,120 L0,0 C150,80 300,30 450,60 C600,90 750,40 900,70 C1050,100 1150,50 1200,0 L1200,120 Z"
                fill="#000"
                fill-opacity="0.3"
            >
                <animate
                    attributeName="d"
                    dur="10s"
                    repeatCount="indefinite"
                    values="
                        M0,120 L0,0 C150,80 300,30 450,60 C600,90 750,40 900,70 C1050,100 1150,50 1200,0 L1200,120 Z;
                        M0,120 L0,40 C150,20 300,70 450,30 C600,50 750,80 900,40 C1050,60 1150,90 1200,40 L1200,120 Z;
                        M0,120 L0,20 C150,60 300,10 450,50 C600,30 750,70 900,50 C1050,80 1150,60 1200,20 L1200,120 Z;
                        M0,120 L0,0 C150,80 300,30 450,60 C600,90 750,40 900,70 C1050,100 1150,50 1200,0 L1200,120 Z
                    "
                ></animate>
            </path>
            <path
                d="M0,120 L0,20 C200,70 400,30 600,60 C800,90 1000,40 1200,20 L1200,120 Z"
                fill="#000"
                fill-opacity="0.5"
            >
                <animate
                    attributeName="d"
                    dur="8s"
                    repeatCount="indefinite"
                    values="
                        M0,120 L0,20 C200,70 400,30 600,60 C800,90 1000,40 1200,20 L1200,120 Z;
                        M0,120 L0,50 C200,30 400,70 600,40 C800,20 1000,80 1200,50 L1200,120 Z;
                        M0,120 L0,35 C200,55 400,20 600,50 C800,45 1000,65 1200,35 L1200,120 Z;
                        M0,120 L0,20 C200,70 400,30 600,60 C800,90 1000,40 1200,20 L1200,120 Z
                    "
                ></animate>
            </path>
            <path
                d="M0,120 L0,40 C120,60 240,35 360,50 C480,65 600,40 720,55 C840,70 960,45 1080,60 C1150,70 1180,50 1200,40 L1200,120 Z"
                fill="#000"
            >
                <animate
                    attributeName="d"
                    dur="6s"
                    repeatCount="indefinite"
                    values="
                        M0,120 L0,40 C120,60 240,35 360,50 C480,65 600,40 720,55 C840,70 960,45 1080,60 C1150,70 1180,50 1200,40 L1200,120 Z;
                        M0,120 L0,60 C120,35 240,60 360,40 C480,50 600,65 720,45 C840,55 960,70 1080,50 C1150,55 1180,70 1200,60 L1200,120 Z;
                        M0,120 L0,50 C120,45 240,50 360,35 C480,55 600,50 720,40 C840,60 960,55 1080,45 C1150,60 1180,55 1200,50 L1200,120 Z;
                        M0,120 L0,40 C120,60 240,35 360,50 C480,65 600,40 720,55 C840,70 960,45 1080,60 C1150,70 1180,50 1200,40 L1200,120 Z
                    "
                ></animate>
            </path>
        </svg>
    </div>

    <!-- Title in center -->
    <div
        id="page-transition-title"
        transition:persist="page-transition-title"
        class="page-transition-title"
    >
        <SectionTitle title="" size="2xl" showGradient={true} customElement="h1" />
    </div>

    <!-- Wave border at bottom -->
    <div class="wave-bottom">
        <svg class="w-full h-32 md:h-40" viewBox="0 0 1200 120" preserveAspectRatio="none">
            <path
                d="M0,0 L0,120 C150,40 300,90 450,60 C600,30 750,80 900,50 C1050,20 1150,70 1200,120 L1200,0 Z"
                fill="#000"
                fill-opacity="0.3"
            >
                <animate
                    attributeName="d"
                    dur="10s"
                    repeatCount="indefinite"
                    values="
                        M0,0 L0,120 C150,40 300,90 450,60 C600,30 750,80 900,50 C1050,20 1150,70 1200,120 L1200,0 Z;
                        M0,0 L0,80 C150,100 300,50 450,90 C600,70 750,40 900,80 C1050,60 1150,30 1200,80 L1200,0 Z;
                        M0,0 L0,100 C150,60 300,110 450,70 C600,50 750,100 900,60 C1050,40 1150,90 1200,100 L1200,0 Z;
                        M0,0 L0,120 C150,40 300,90 450,60 C600,30 750,80 900,50 C1050,20 1150,70 1200,120 L1200,0 Z
                    "
                ></animate>
            </path>
            <path
                d="M0,0 L0,100 C200,50 400,90 600,70 C800,40 1000,80 1200,100 L1200,0 Z"
                fill="#000"
                fill-opacity="0.5"
            >
                <animate
                    attributeName="d"
                    dur="8s"
                    repeatCount="indefinite"
                    values="
                        M0,0 L0,100 C200,50 400,90 600,70 C800,40 1000,80 1200,100 L1200,0 Z;
                        M0,0 L0,70 C200,90 400,50 600,80 C800,70 1000,40 1200,70 L1200,0 Z;
                        M0,0 L0,85 C200,65 400,100 600,60 C800,55 1000,95 1200,85 L1200,0 Z;
                        M0,0 L0,100 C200,50 400,90 600,70 C800,40 1000,80 1200,100 L1200,0 Z
                    "
                ></animate>
            </path>
            <path
                d="M0,0 L0,80 C120,60 240,85 360,70 C480,55 600,80 720,65 C840,50 960,75 1080,60 C1150,50 1180,70 1200,80 L1200,0 Z"
                fill="#000"
            >
                <animate
                    attributeName="d"
                    dur="6s"
                    repeatCount="indefinite"
                    values="
                        M0,0 L0,80 C120,60 240,85 360,70 C480,55 600,80 720,65 C840,50 960,75 1080,60 C1150,50 1180,70 1200,80 L1200,0 Z;
                        M0,0 L0,60 C120,85 240,60 360,80 C480,70 600,55 720,75 C840,65 960,50 1080,70 C1150,65 1180,50 1200,60 L1200,0 Z;
                        M0,0 L0,70 C120,75 240,70 360,85 C480,65 600,70 720,80 C840,60 960,65 1080,75 C1150,60 1180,65 1200,70 L1200,0 Z;
                        M0,0 L0,80 C120,60 240,85 360,70 C480,55 600,80 720,65 C840,50 960,75 1080,60 C1150,50 1180,70 1200,80 L1200,0 Z
                    "
                ></animate>
            </path>
        </svg>
    </div>
</div>

<style>
    /* Overlay container - initially hidden below viewport and invisible */
    .page-transition-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: #000;
        z-index: 9999;
        pointer-events: none;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        transform: translateY(115%);
        will-change: transform;
        overflow: visible;
        visibility: hidden; /* Hide from accessibility tree when not in use */
    }

    /* Wave at top - positioned at the edge of the overlay */
    .wave-top {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        z-index: 1;
        transform: translateY(-100%);
    }

    /* Wave at bottom - positioned at the edge of the overlay */
    .wave-bottom {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        z-index: 1;
        transform: translateY(100%);
    }

    /* Page title styling - wrapper for SectionTitle component */
    .page-transition-title {
        opacity: 0;
        transform: translateY(20px);
        padding: 0 2rem;
        max-width: 90%;
        will-change: opacity, transform;
        z-index: 10;
        position: relative;
    }

    /* Override SectionTitle styles for transition overlay */
    .page-transition-title :global(.section-title) {
        margin-bottom: 0;
    }

    .page-transition-title :global(.gradient-text-section) {
        background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 50%, #ec4899 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
</style>

<style is:global>
    /* Disable default View Transitions animations */
    ::view-transition-old(root),
    ::view-transition-new(root) {
        animation: none !important;
        mix-blend-mode: normal;
    }

    /* Make view transition instant */
    ::view-transition-group(root) {
        animation-duration: 0s !important;
    }
</style>

<script>
    import { gsap } from 'gsap';

    // Translations for page titles (same as current system)
    const translations = {
        en: {
            home: 'Home',
            blog: 'Blog',
            projects: 'Projects',
            services: 'Services',
            tools: 'Tools',
            about: 'About',
            skills: 'Skills',
            testimonials: 'Testimonials',
            contact: 'Contact'
        },
        es: {
            home: 'Inicio',
            blog: 'Blog',
            projects: 'Proyectos',
            services: 'Servicios',
            tools: 'Herramientas',
            about: 'Acerca de',
            skills: 'Habilidades',
            testimonials: 'Testimonios',
            contact: 'Contacto'
        }
    };

    // Animation configuration (identical to original)
    const TRANSITION_DURATION = 1; // Overlay slide duration
    const TITLE_DELAY = 0; // Title appears early while overlay slides
    const PAUSE_DURATION = 0.1; // Brief pause at peak
    const EASE = 'power4.inOut'; // Smooth easing

    // DOM elements
    const overlay = document.getElementById('page-transition-overlay')!;
    const titleElement = document.getElementById('page-transition-title')!;

    // Timeline for entrance animation (shared between hooks)
    let entranceTimeline: gsap.core.Timeline | null = null;

    /**
     * Normalize pathname by removing trailing slash for comparison
     */
    function normalizePathname(pathname: string): string {
        return pathname.endsWith('/') && pathname.length > 1 ? pathname.slice(0, -1) : pathname;
    }

    /**
     * Get page title from URL
     */
    function getPageTitle(url: URL): string {
        const pathSegments = url.pathname.split('/').filter(Boolean);
        const locale = pathSegments[0] === 'en' || pathSegments[0] === 'es' ? pathSegments[0] : 'en';
        const t = translations[locale];

        // Handle hash navigation
        if (url.hash) {
            let hashText = url.hash.substring(1);
            if (hashText === 'hero') hashText = 'home';
            const translationKey = hashText.toLowerCase() as keyof typeof t;
            return t[translationKey] || hashText;
        }

        // Handle project pages
        if (pathSegments.length >= 3 && pathSegments[1] === 'projects') {
            return t.projects;
        }

        // Default page title
        const pageSegment = pathSegments.length > 1 ? pathSegments[pathSegments.length - 1] : 'home';
        const translationKey = pageSegment.toLowerCase() as keyof typeof t;
        return t[translationKey] || pageSegment;
    }

    /**
     * HOOK 1: Before preparation - Start entrance animation IMMEDIATELY
     * This fires as soon as user clicks a link (before fetch)
     */
    document.addEventListener('astro:before-preparation', ((event: any) => {
        const currentUrl = new URL(window.location.href);
        const newUrl = new URL(event.to);

        // Skip animation if pathname doesn't change (same-page hash navigation)
        // When pathname is the same, Astro only scrolls and doesn't trigger swap
        // This prevents the animation from getting stuck
        // Normalize pathnames to ignore trailing slashes
        const currentPath = normalizePathname(currentUrl.pathname);
        const newPath = normalizePathname(newUrl.pathname);
        const isSamePage = currentPath === newPath;

        if (isSamePage) {
            // Prevent Astro from handling this navigation with View Transitions
            // Let Navigation.astro handle the smooth scroll instead
            event.preventDefault();
            return;
        }

        const pageTitle = getPageTitle(newUrl);

        // Update the SectionTitle component text
        const gradientTextElement = titleElement.querySelector('.gradient-text-section');
        if (gradientTextElement) {
            gradientTextElement.textContent = pageTitle;
        }

        // Start entrance animation immediately (no delay!)
        entranceTimeline = gsap.timeline();

        // Make overlay visible first
        entranceTimeline.set(overlay, { visibility: 'visible' });

        // Overlay slides up from bottom
        entranceTimeline.to(overlay, {
            y: 0,
            duration: TRANSITION_DURATION,
            ease: EASE
        });

        // Title fades in and slides up after overlay starts
        entranceTimeline.to(
            titleElement,
            {
                opacity: 1,
                y: 0,
                duration: 0.4,
                ease: EASE
            },
            `+=${TITLE_DELAY}`
        );

        // Pause at top
        entranceTimeline.to({}, { duration: PAUSE_DURATION });
    }) as EventListener);

    /**
     * MANUAL HASH NAVIGATION HANDLER
     * Astro doesn't trigger before-preparation for same-page hash links,
     * so we need to handle them manually
     *
     * NOTE: This handler is intentionally removed to prevent conflicts with
     * Navigation.astro's smooth scroll implementation which includes header offset.
     * Same-page hash navigation is now handled by Navigation.astro exclusively.
     */

    /**
     * HOOK 2: Before swap - Wait for entrance, swap, then exit
     */
    document.addEventListener('astro:before-swap', ((event: any) => {
        const originalSwap = event.swap;

        event.swap = async () => {
            // STEP 1: Wait for entrance animation to complete
            if (entranceTimeline) {
                // Check if timeline is already complete (can happen with hash navigation)
                if (entranceTimeline.progress() !== 1) {
                    await new Promise<void>((resolve) => {
                        entranceTimeline!.eventCallback('onComplete', () => resolve());
                    });
                }
                entranceTimeline = null;
            }

            // STEP 2: Perform DOM swap (invisible behind overlay)
            await originalSwap();

            // STEP 3: Animate OUT (reveals new content)
            const tlOut = gsap.timeline();

            // Title fades out and slides up
            tlOut.to(titleElement, {
                opacity: 0,
                y: -20,
                duration: 0.3,
                ease: EASE
            });

            // Overlay slides up out of view
            tlOut.to(
                overlay,
                {
                    y: '-115%',
                    duration: TRANSITION_DURATION,
                    ease: EASE
                },
                '-=0.1' // Slight overlap
            );

            // Reset for next transition
            tlOut.set(overlay, { y: '115%', visibility: 'hidden' });
            tlOut.set(titleElement, { opacity: 0, y: 20 });

            // Wait for exit animation
            await new Promise<void>((resolve) => {
                tlOut.eventCallback('onComplete', () => resolve());
            });
        };
    }) as EventListener);
</script>
