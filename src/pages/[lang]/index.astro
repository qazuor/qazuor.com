---
import { getCollection } from 'astro:content';
import { Hero } from '../../components/Hero';
import { About } from '../../components/About';
import { Skills } from '../../components/Skills';
import { Projects } from '../../components/Projects';
import { Blog } from '../../components/Blog';
import { Contact } from '../../components/Contact';
import { languages } from '../../i18n/ui';
import { getLangFromUrl, getTranslations } from '../../i18n/utils';
import BaseLayout from '../../layouts/BaseLayout.astro';

export function getStaticPaths() {
  return Object.keys(languages).map((lang) => ({
    params: { lang },
  }));
}

const lang = getLangFromUrl(Astro.url);
const t = getTranslations(lang);

const title = 'qazuor - Full-Stack Developer';
const description = 'Building beautiful, performant, and accessible web experiences';

// Load Content Collections
const allProjects = await getCollection('projects');
const allBlogPosts = await getCollection('blog');

// Sort projects by order field, then by date
const sortedProjects = allProjects
  .sort((a, b) => {
    if (a.data.order !== b.data.order) {
      return a.data.order - b.data.order;
    }
    return b.data.publishDate.getTime() - a.data.publishDate.getTime();
  })
  .map((project) => ({
    title: project.data.title,
    description: project.data.description,
    tags: project.data.tags,
    image: project.data.image,
    demoUrl: project.data.demoUrl,
    codeUrl: project.data.codeUrl,
    featured: project.data.featured,
  }));

// Sort blog posts by date (newest first) and filter out drafts
const sortedBlogPosts = allBlogPosts
  .filter((post) => !post.data.draft)
  .sort((a, b) => b.data.publishDate.getTime() - a.data.publishDate.getTime())
  .map((post) => ({
    title: post.data.title,
    excerpt: post.data.excerpt,
    date: post.data.publishDate.toISOString().split('T')[0],
    readTime: post.data.readTime,
    tags: post.data.tags,
    slug: `/${lang}/blog/${post.slug}`,
  }));

// Translations for components
const heroTranslations = {
  viewProjects: t('home.hero.viewProjects'),
  getInTouch: t('home.hero.getInTouch'),
  scroll: t('home.hero.scroll'),
};

const aboutTranslations = {
  title: t('about.title'),
  subtitle: t('about.subtitle'),
  connect: t('about.connect'),
};

const skillsTranslations = {
  title: t('skills.title'),
  subtitle: t('skills.subtitle'),
  categoryTitles: {
    frontend: t('skills.categories.frontend'),
    backend: t('skills.categories.backend'),
    tools: t('skills.categories.tools'),
  },
};

const projectsTranslations = {
  title: t('projects.title'),
  subtitle: t('projects.subtitle'),
  noProjects: t('projects.noProjects'),
  filterAll: t('projects.filterAll'),
};

const projectCardTranslations = {
  demo: t('projects.viewDemo'),
  code: t('projects.viewCode'),
  featured: t('projects.featured'),
};

const blogTranslations = {
  title: t('blog.title'),
  subtitle: t('blog.subtitle'),
  viewAll: t('blog.viewAll'),
  noArticles: t('blog.noArticles'),
  readMore: t('blog.readMore'),
};

const blogCardTranslations = {
  readMore: t('blog.readMore'),
};

const contactTranslations = {
  title: t('contact.title'),
  subtitle: t('contact.subtitle'),
  form: {
    name: t('contact.form.name'),
    email: t('contact.form.email'),
    subject: t('contact.form.subject'),
    message: t('contact.form.message'),
    send: t('contact.form.send'),
    sending: t('contact.form.sending'),
  },
  placeholders: {
    name: t('contact.placeholders.name'),
    email: t('contact.placeholders.email'),
    subject: t('contact.placeholders.subject'),
    message: t('contact.placeholders.message'),
  },
  errors: {
    nameRequired: t('contact.errors.nameRequired'),
    emailRequired: t('contact.errors.emailRequired'),
    emailInvalid: t('contact.errors.emailInvalid'),
    subjectRequired: t('contact.errors.subjectRequired'),
    messageRequired: t('contact.errors.messageRequired'),
    messageMinLength: t('contact.errors.messageMinLength'),
  },
  success: t('contact.success'),
  error: t('contact.error'),
};
---

<BaseLayout title={title} description={description}>
  <!-- Hero Section -->
  <Hero
    client:load
    name="qazuor"
    roles={[
      t('home.roles.fullstack'),
      t('home.roles.react'),
      t('home.roles.uiux'),
      t('home.roles.solver'),
    ]}
    subtitle={t('home.hero.subtitle')}
    translations={heroTranslations}
  />

  <!-- About Section -->
  <About
    client:load
    name="qazuor"
    role={t('home.roles.fullstack')}
    location="Remote"
    experience="5+ years"
    email="hello@qazuor.com"
    availability={t('about.availability')}
    bio={t('about.bio')}
    translations={aboutTranslations}
  />

  <!-- Skills Section -->
  <Skills client:load translations={skillsTranslations} />

  <!-- Projects Section -->
  <Projects client:idle projects={sortedProjects} translations={projectsTranslations} cardTranslations={projectCardTranslations} />

  <!-- Blog Section - Static Rendering -->
  <section class="section bg-background-secondary">
    <div class="container-custom">
      {/* Section Title */}
      <div class="section-title mb-12 text-center">
        <h2 class="text-3xl md:text-4xl font-bold mb-4">
          <span class="gradient-text">{blogTranslations.title}</span>
        </h2>
        <p class="text-foreground-secondary text-lg">{blogTranslations.subtitle}</p>
      </div>

      {/* Blog Grid */}
      <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6 mb-12">
        {sortedBlogPosts.slice(0, 3).map((post) => (
          <article class="blog-card card-hover group p-6">
            {/* Header */}
            <div class="flex items-center gap-4 mb-4 text-sm text-foreground-muted">
              <time datetime={post.date} class="flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width={2}
                    d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
                  />
                </svg>
                {new Date(post.date).toLocaleDateString(lang === 'es' ? 'es-ES' : 'en-US', {
                  year: 'numeric',
                  month: 'short',
                  day: 'numeric',
                })}
              </time>
              <span>â€¢</span>
              <span class="flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width={2}
                    d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                  />
                </svg>
                {post.readTime.match(/\d+/)?.[0]} {t('blog.readTime')}
              </span>
            </div>

            {/* Title */}
            <h3 class="text-xl font-bold mb-3 text-foreground group-hover:text-primary transition-colors duration-300">
              <a href={post.slug} class="hover:underline">
                {post.title}
              </a>
            </h3>

            {/* Excerpt */}
            <p class="text-foreground-secondary text-sm mb-4 line-clamp-3">{post.excerpt}</p>

            {/* Tags */}
            <div class="flex flex-wrap gap-2 mb-4">
              {post.tags.map((tag) => (
                <span
                  class="px-3 py-1 text-xs font-medium bg-foreground/5 text-foreground-secondary rounded-full border border-foreground/10 hover:border-primary hover:text-primary transition-colors duration-300"
                >
                  #{tag}
                </span>
              ))}
            </div>

            {/* Read more link */}
            <a
              href={post.slug}
              class="inline-flex items-center text-primary hover:text-primary-600 font-medium transition-colors duration-300 group/link"
            >
              {blogCardTranslations.readMore}
              <svg
                class="w-4 h-4 ml-1 group-hover/link:translate-x-1 transition-transform duration-300"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width={2} d="M9 5l7 7-7 7" />
              </svg>
            </a>
          </article>
        ))}
      </div>

      {/* View All Button */}
      {sortedBlogPosts.length > 3 && (
        <div class="text-center">
          <a
            href={`/${lang}/blog`}
            class="inline-flex items-center gap-2 px-6 py-3 bg-primary text-white rounded-lg hover:bg-primary-600 transition-colors duration-300 font-medium shadow-glow-primary"
          >
            {blogTranslations.viewAll}
            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width={2}
                d="M17 8l4 4m0 0l-4 4m4-4H3"
              />
            </svg>
          </a>
        </div>
      )}

      {/* Empty State */}
      {sortedBlogPosts.length === 0 && (
        <div class="text-center py-12">
          <svg
            class="w-16 h-16 mx-auto mb-4 text-foreground-muted"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width={2}
              d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
            />
          </svg>
          <p class="text-foreground-secondary text-lg">{blogTranslations.noArticles}</p>
        </div>
      )}
    </div>
  </section>

  <!-- Contact Section -->
  <Contact client:load translations={contactTranslations} />
</BaseLayout>
