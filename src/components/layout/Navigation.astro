---
import type { CollectionEntry } from 'astro:content';
import { getCollection } from 'astro:content';
import { normalizeTrailingSlash } from '@reunmedia/astro-normalize-trailing-slash';
import { CommandButton } from '@/components/interactive/CommandButton';
import { GoodiesDropdown } from '@/components/interactive/GoodiesDropdown';
import { LanguageSelector } from '@/components/interactive/LanguageSelector';
import { ServicesDropdown } from '@/components/interactive/ServicesDropdown';
import { ThemeToggle } from '@/components/interactive/ThemeToggle';
import ServiceIcon from '@/components/ui/ServiceIcon.astro';
import { services } from '@/data/services';
import { getLangFromUrl, getTranslations, translatePath } from '@/i18n/utils';

const lang = getLangFromUrl(Astro.url);
const t = getTranslations(lang);
const currentPath = Astro.url.pathname;

// Get all goodies collections for dropdown
const allTools = await getCollection('tools');
const allSnippets = await getCollection('snippets');
const allCssTricks = await getCollection('css-tricks');
const allUsefulLinks = await getCollection('useful-links');

// Sort and prepare tools (max 4)
const toolsForDropdown = allTools
    .sort((a: CollectionEntry<'tools'>, b: CollectionEntry<'tools'>) => {
        if (a.data.featured && !b.data.featured) return -1;
        if (!a.data.featured && b.data.featured) return 1;
        return b.data.createdAt.getTime() - a.data.createdAt.getTime();
    })
    .slice(0, 4)
    .map((tool: CollectionEntry<'tools'>) => ({
        slug: tool.slug,
        title: tool.data.title,
        iconType: tool.data.icon,
        externalUrl: tool.data.siteUrl
    }));

// Sort and prepare snippets (max 4)
const snippetsForDropdown = allSnippets
    .sort((a: CollectionEntry<'snippets'>, b: CollectionEntry<'snippets'>) => {
        if (a.data.featured && !b.data.featured) return -1;
        if (!a.data.featured && b.data.featured) return 1;
        return b.data.createdAt.getTime() - a.data.createdAt.getTime();
    })
    .slice(0, 4)
    .map((snippet: CollectionEntry<'snippets'>) => ({
        slug: snippet.slug,
        title: snippet.data.title,
        iconType: snippet.data.language as string
    }));

// Sort and prepare CSS tricks (max 4)
const cssTricksForDropdown = allCssTricks
    .sort((a: CollectionEntry<'css-tricks'>, b: CollectionEntry<'css-tricks'>) => {
        if (a.data.featured && !b.data.featured) return -1;
        if (!a.data.featured && b.data.featured) return 1;
        return b.data.createdAt.getTime() - a.data.createdAt.getTime();
    })
    .slice(0, 4)
    .map((trick: CollectionEntry<'css-tricks'>) => ({
        slug: trick.slug,
        title: trick.data.title,
        iconType: 'css' as const
    }));

// Sort and prepare useful links (max 4)
const usefulLinksForDropdown = allUsefulLinks
    .sort((a: CollectionEntry<'useful-links'>, b: CollectionEntry<'useful-links'>) => {
        if (a.data.featured && !b.data.featured) return -1;
        if (!a.data.featured && b.data.featured) return 1;
        return a.data.order - b.data.order;
    })
    .slice(0, 4)
    .map((link: CollectionEntry<'useful-links'>) => ({
        slug: link.id,
        title: link.data.name,
        iconType: link.data.category as string
    }));

// Build goodies categories for dropdown
const goodiesCategories = [
    {
        id: 'tools' as const,
        title: t('goodies.categories.tools'),
        items: toolsForDropdown,
        viewAllLabel: t('goodies.dropdown.viewAllTools'),
        viewAllHref: `/${lang}/goodies/tools`
    },
    {
        id: 'snippets' as const,
        title: t('goodies.categories.snippets'),
        items: snippetsForDropdown,
        viewAllLabel: t('goodies.dropdown.viewAllSnippets'),
        viewAllHref: `/${lang}/goodies/snippets`
    },
    {
        id: 'css-tricks' as const,
        title: t('goodies.categories.cssTricks'),
        items: cssTricksForDropdown,
        viewAllLabel: t('goodies.dropdown.viewAllCssTricks'),
        viewAllHref: `/${lang}/goodies/css-tricks`
    },
    {
        id: 'useful-links' as const,
        title: t('goodies.categories.usefulLinks'),
        items: usefulLinksForDropdown,
        viewAllLabel: t('goodies.dropdown.viewAllLinks'),
        viewAllHref: `/${lang}/goodies/useful-links`
    }
];

// Helper function to format nav labels as HTML tags
const formatAsTag = (label: string) => `<${label.toLowerCase()} />`;

// Services dropdown translations (clean markdown syntax)
const servicesDropdownTranslations = {
    webApps: t('services.webApps.title', { markdown: false }).replace(/\*\*/g, ''),
    landingPages: t('services.landingPages.title', { markdown: false }).replace(/\*\*/g, ''),
    automation: t('services.automation.title', { markdown: false }).replace(/\*\*/g, ''),
    socialDesign: t('services.socialDesign.title', { markdown: false }).replace(/\*\*/g, ''),
    headerTitle: t('services.dropdown.headerTitle'),
    headerDescription: t('services.dropdown.headerDescription'),
    viewAllLabel: t('services.dropdown.viewAll')
};

// Goodies dropdown translations
const goodiesDropdownTranslations = {
    headerTitle: t('goodies.dropdown.headerTitle'),
    headerDescription: t('goodies.dropdown.headerDescription'),
    viewAllLabel: t('goodies.dropdown.viewAll')
};

// Check if we're on the home page for navigation logic
const isHomePage =
    currentPath === translatePath('/', lang) || currentPath === `/${lang}` || currentPath === `/${lang}/`;

const navItems = [
    { href: `${translatePath('/', lang)}#about`, label: formatAsTag(t('nav.about')) },
    { href: `${translatePath('/', lang)}#skills`, label: formatAsTag(t('nav.skills')) },
    { href: `${translatePath('/', lang)}#projects`, label: formatAsTag(t('nav.projects')) },
    {
        href: isHomePage ? `${translatePath('/', lang)}#blog` : translatePath('/blog', lang),
        label: formatAsTag(t('nav.blog'))
    },
    { href: translatePath('/services', lang), label: formatAsTag(t('nav.services')) },
    { href: `${translatePath('/', lang)}#testimonials`, label: formatAsTag(t('nav.testimonials')) },
    { href: translatePath('/goodies', lang), label: formatAsTag(t('nav.tools')) },
    { href: `${translatePath('/', lang)}#contact`, label: formatAsTag(t('nav.contact')) }
];

const isActive = (href: string) => {
    // Handle home page anchor links - don't mark as active server-side
    // Active state will be handled by JavaScript based on scroll position
    if (href.includes('#')) {
        return false; // Let JavaScript handle active state for anchor links
    }

    // Handle regular page links
    if (href === translatePath('/', lang)) {
        return currentPath === href || currentPath === `/${lang}` || currentPath === `/${lang}/`;
    }

    return currentPath.startsWith(href);
};
---

<nav class="glass fixed top-0 left-0 right-0 z-[500] border-b nav-visible" id="main-nav">
    <div class="container-custom relative">
        <div class="flex justify-between items-center h-14">
            <!-- Logo with Avatar -->
            <a
                href={translatePath('/#hero', lang)}
                class="logo flex items-center gap-3 hover:scale-105 transition-transform duration-base"
            >
                <div
                    class="w-8 h-8 rounded-full overflow-hidden border-2 border-primary/20 hover:border-primary/50 transition-colors"
                >
                    <img src="/avatar.png" alt="qazuor avatar" class="w-full h-full object-cover" loading="eager" />
                </div>
                <span class="text-lg font-bold gradient-text font-mono whitespace-nowrap">~/qazuor</span>
            </a>

            <!-- Desktop Navigation Links (hidden below 768px) -->
            <div class="hidden md:flex items-center gap-5">
                {
                    navItems.map((item) => {
                        // Use dropdown for services
                        if (item.href.includes('/services')) {
                            return (
                                <ServicesDropdown
                                    client:load
                                    currentLocale={lang}
                                    currentPath={currentPath}
                                    allServicesLabel={item.label}
                                    translations={servicesDropdownTranslations}
                                />
                            );
                        }

                        // Use dropdown for goodies
                        if (item.href.includes('/goodies')) {
                            return (
                                <GoodiesDropdown
                                    client:load
                                    currentLocale={lang}
                                    currentPath={currentPath}
                                    triggerLabel={item.label}
                                    categories={goodiesCategories}
                                    translations={goodiesDropdownTranslations}
                                />
                            );
                        }

                        // Regular link for other items
                        return (
                            <a
                                href={item.href.includes('#') ? item.href : normalizeTrailingSlash(item.href)}
                                class={`nav-link text-[0.65rem] font-medium font-mono whitespace-nowrap transition-all duration-base relative group ${
                                    isActive(item.href) ? 'text-primary' : 'text-foreground-secondary hover:text-foreground'
                                }`}
                                data-is-anchor={item.href.includes('#') ? 'true' : 'false'}
                                data-is-home-page={isHomePage ? 'true' : 'false'}
                            >
                                {item.label}
                                {/* Underline animation */}
                                <span
                                    class={`absolute -bottom-1 left-0 h-0.5 bg-gradient-to-r from-primary to-secondary transition-all duration-base ${
                                        isActive(item.href) ? 'w-full' : 'w-0 group-hover:w-full'
                                    }`}
                                />
                            </a>
                        );
                    })
                }
            </div>

            <!-- Actions: Desktop (1400px+) - All visible, separate -->
            <div class="hidden min-[1400px]:flex items-center gap-2">
                <CommandButton ariaLabel={t('aria.openCommandPalette')} client:load />
                <LanguageSelector currentLocale={lang} client:load />
                <ThemeToggle ariaLabel={t('aria.toggleTheme')} client:load />
            </div>

            <!-- Actions: Large (1200-1399px) - Language compact mode -->
            <div class="hidden min-[1200px]:flex min-[1400px]:hidden items-center gap-2">
                <CommandButton ariaLabel={t('aria.openCommandPalette')} client:load />
                <LanguageSelector currentLocale={lang} compact client:load />
                <ThemeToggle ariaLabel={t('aria.toggleTheme')} client:load />
            </div>

            <!-- Actions: Medium (768-1199px) - Only links visible, actions in hamburger -->
            <button
                id="actions-menu-button"
                class="hidden md:flex min-[1200px]:hidden p-1.5 rounded-lg text-foreground-secondary hover:bg-foreground/5 transition-colors duration-base"
                aria-label={t('aria.toggleActionsMenu')}
            >
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"
                    ></path>
                </svg>
            </button>

            <!-- Mobile menu button (< 768px) - Everything in hamburger -->
            <button
                id="mobile-menu-button"
                class="md:hidden p-1.5 rounded-lg text-foreground-secondary hover:bg-foreground/5 transition-colors duration-base"
                aria-label={t('aria.toggleMenu')}
            >
                <svg id="menu-icon" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"
                    ></path>
                </svg>
                <svg id="close-icon" class="w-5 h-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"
                    ></path>
                </svg>
            </button>
        </div>

        <!-- Actions Menu (768-1199px: only actions, no links) - Floating Overlay -->
        <div
            id="actions-menu"
            class="hidden absolute top-full right-0 mt-2 w-64 rounded-lg bg-card border border-border shadow-lg z-50"
        >
            <div class="flex items-center gap-2 p-4">
                <CommandButton ariaLabel={t('aria.openCommandPalette')} client:load />
                <LanguageSelector currentLocale={lang} client:load />
                <ThemeToggle ariaLabel={t('aria.toggleTheme')} client:load />
            </div>
        </div>

        <!-- Mobile Menu (< 768px: links + actions) - Floating Overlay -->
        <div
            id="mobile-menu"
            class="hidden md:hidden absolute top-full left-0 right-0 mt-2 mx-4 rounded-lg bg-card border border-border shadow-lg z-50 max-h-[calc(100vh-5rem)] overflow-y-auto"
        >
            <div class="py-2 space-y-1">
                {
                    navItems.map((item) => {
                        // Services with collapsible submenu
                        if (item.href.includes('/services')) {
                            return (
                                <div>
                                    {/* Main Services Toggle Button */}
                                    <button
                                        type="button"
                                        id="services-toggle"
                                        class={`nav-link-mobile w-full flex items-center justify-between px-4 py-3 text-[0.65rem] font-medium font-mono whitespace-nowrap transition-all duration-base ${
                                            isActive(item.href)
                                                ? 'bg-primary/10 text-primary'
                                                : 'text-foreground-secondary hover:bg-foreground/5 hover:text-foreground'
                                        }`}
                                    >
                                        <span>{item.label}</span>
                                        <svg
                                            id="services-arrow"
                                            class="w-4 h-4 transition-transform duration-200"
                                            fill="none"
                                            viewBox="0 0 24 24"
                                            stroke="currentColor"
                                        >
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                                        </svg>
                                    </button>
                                    {/* Services Submenu - Hidden by default */}
                                    <div id="services-submenu" class="hidden pl-4 space-y-1 overflow-hidden">
                                        {services.map((service) => {
                                            const serviceLabel = servicesDropdownTranslations[
                                                service.id === 'web-apps' ? 'webApps' :
                                                service.id === 'landing-pages' ? 'landingPages' :
                                                service.id === 'automation-integration' ? 'automation' :
                                                'socialDesign'
                                            ];
                                            return (
                                                <a
                                                    href={`/${lang}/services/${service.slug}`}
                                                    class="nav-link-mobile block px-4 py-2 text-[0.65rem] text-foreground-secondary hover:bg-foreground/5 hover:text-foreground transition-all duration-base rounded-lg"
                                                >
                                                    <ServiceIcon name={service.iconId} size={14} class="mr-2 inline" />
                                                    {serviceLabel}
                                                </a>
                                            );
                                        })}
                                    </div>
                                </div>
                            );
                        }

                        // Regular links for other items
                        return (
                            <a
                                href={normalizeTrailingSlash(item.href)}
                                class={`nav-link-mobile block px-4 py-3 text-[0.65rem] font-medium font-mono whitespace-nowrap transition-all duration-base ${
                                    isActive(item.href)
                                        ? 'bg-primary/10 text-primary'
                                        : 'text-foreground-secondary hover:bg-foreground/5 hover:text-foreground'
                                }`}
                                data-is-anchor={item.href.includes('#') ? 'true' : 'false'}
                                data-is-home-page={isHomePage ? 'true' : 'false'}
                            >
                                {item.label}
                            </a>
                        );
                    })
                }
            </div>
            <div class="flex items-center gap-2 p-4 border-t border-foreground/10">
                <CommandButton ariaLabel={t('aria.openCommandPalette')} client:load />
                <LanguageSelector currentLocale={lang} client:load />
                <ThemeToggle ariaLabel={t('aria.toggleTheme')} client:load />
            </div>
        </div>
    </div>
</nav>

<!-- Backdrop for mobile menu -->
<div id="menu-backdrop" class="hidden fixed inset-0 bg-background/80 backdrop-blur-sm z-40"></div>

<script>
    // Helper functions for menu state management
    function closeMobileMenu() {
        const mobileMenu = document.getElementById('mobile-menu');
        const menuIcon = document.getElementById('menu-icon');
        const closeIcon = document.getElementById('close-icon');
        const backdrop = document.getElementById('menu-backdrop');

        mobileMenu?.classList.add('hidden');
        menuIcon?.classList.remove('hidden');
        closeIcon?.classList.add('hidden');
        backdrop?.classList.add('hidden');
    }

    function openMobileMenu() {
        const mobileMenu = document.getElementById('mobile-menu');
        const menuIcon = document.getElementById('menu-icon');
        const closeIcon = document.getElementById('close-icon');
        const backdrop = document.getElementById('menu-backdrop');

        mobileMenu?.classList.remove('hidden');
        menuIcon?.classList.add('hidden');
        closeIcon?.classList.remove('hidden');
        backdrop?.classList.remove('hidden');
    }

    function closeActionsMenu() {
        const actionsMenu = document.getElementById('actions-menu');
        actionsMenu?.classList.add('hidden');
    }

    function openActionsMenu() {
        const actionsMenu = document.getElementById('actions-menu');
        actionsMenu?.classList.remove('hidden');
    }

    // Event delegation - single listener for ALL menu interactions
    // This persists across View Transitions without needing to re-register
    document.addEventListener('click', (e) => {
        const target = e.target as HTMLElement;

        // Mobile menu button toggle
        if (target.closest('#mobile-menu-button')) {
            const mobileMenu = document.getElementById('mobile-menu');
            const isHidden = mobileMenu?.classList.contains('hidden');
            if (isHidden) {
                openMobileMenu();
            } else {
                closeMobileMenu();
            }
            return;
        }

        // Actions menu button toggle
        if (target.closest('#actions-menu-button')) {
            const actionsMenu = document.getElementById('actions-menu');
            const isHidden = actionsMenu?.classList.contains('hidden');
            if (isHidden) {
                openActionsMenu();
            } else {
                closeActionsMenu();
            }
            return;
        }

        // Backdrop click - close mobile menu
        if (target.closest('#menu-backdrop')) {
            closeMobileMenu();
            return;
        }

        // Services submenu toggle in mobile menu
        if (target.closest('#services-toggle')) {
            const servicesSubmenu = document.getElementById('services-submenu');
            const servicesArrow = document.getElementById('services-arrow');
            const isHidden = servicesSubmenu?.classList.contains('hidden');
            if (isHidden) {
                servicesSubmenu?.classList.remove('hidden');
                servicesArrow?.classList.add('rotate-90');
            } else {
                servicesSubmenu?.classList.add('hidden');
                servicesArrow?.classList.remove('rotate-90');
            }
            return;
        }

        // Close actions menu when clicking outside
        const actionsMenu = document.getElementById('actions-menu');
        const actionsButton = document.getElementById('actions-menu-button');
        if (
            actionsMenu &&
            !actionsMenu.contains(target) &&
            actionsButton &&
            !actionsButton.contains(target)
        ) {
            closeActionsMenu();
        }
    });

    // Close menus when clicking on navigation links or interactive elements
    // Using event delegation so this persists across View Transitions
    document.addEventListener('click', (e) => {
        const target = e.target as HTMLElement;

        // Close mobile menu when clicking any link inside it
        const mobileMenu = document.getElementById('mobile-menu');
        if (mobileMenu && target.closest('#mobile-menu a')) {
            closeMobileMenu();
            return;
        }

        // Close menus when clicking interactive elements in the actions area
        const clickedButton = target.closest('button');
        const isLanguageSelector = target.closest('.language-selector');
        const isSvgClick = target.tagName === 'svg' || target.tagName === 'SVG' || target.closest('svg');

        if (clickedButton || isLanguageSelector || isSvgClick) {
            const mobileMenuActions = mobileMenu?.querySelector('.flex.items-center.gap-2.p-4');
            const actionsMenu = document.getElementById('actions-menu');
            const actionsMenuContent = actionsMenu?.querySelector('.flex.items-center.gap-2.p-4');

            // Check if the click is inside mobile menu actions
            if (mobileMenuActions?.contains(target) || target.closest('#mobile-menu .flex.items-center.gap-2.p-4')) {
                setTimeout(closeMobileMenu, 150);
            }

            // Check if the click is inside actions menu
            if (actionsMenuContent?.contains(target) || target.closest('#actions-menu .flex.items-center.gap-2.p-4')) {
                setTimeout(closeActionsMenu, 150);
            }
        }
    });

    // Check if we're on home page
    function isHomePage() {
        const path = window.location.pathname;
        return path === '/' || path === '/en' || path === '/es' || path === '/en/' || path === '/es/';
    }

    // Smooth scroll functionality
    function smoothScrollTo(targetY: number, duration = 1200, onComplete?: () => void): void {
        const startY = window.pageYOffset;
        const distance = targetY - startY;
        let startTime: number | null = null;

        function animation(currentTime: number): void {
            if (startTime === null) startTime = currentTime;
            const timeElapsed = currentTime - startTime;
            const progress = Math.min(timeElapsed / duration, 1);

            const ease =
                progress < 0.5
                    ? 4 * progress * progress * progress
                    : (progress - 1) * (2 * progress - 2) * (2 * progress - 2) + 1;

            window.scrollTo(0, startY + distance * ease);

            if (progress < 1) {
                requestAnimationFrame(animation);
            } else if (onComplete) {
                onComplete();
            }
        }
        requestAnimationFrame(animation);
    }

    // Navigation hide/show on scroll (all breakpoints including mobile)
    // Use a global flag to prevent duplicate listeners
    let navScrollListenerAttached = false;
    let lastScrollY = 0;
    let scrollTimeout: ReturnType<typeof setTimeout> | undefined;
    const SCROLL_THRESHOLD = 50;
    const BOTTOM_THRESHOLD_PERCENT = 95;

    function getScrollPercent(): number {
        const scrollTop = window.scrollY || window.pageYOffset || document.documentElement.scrollTop;
        const docHeight = document.documentElement.scrollHeight - window.innerHeight;
        if (docHeight <= 0) return 0;
        return (scrollTop / docHeight) * 100;
    }

    function showNav() {
        const nav = document.getElementById('main-nav');
        if (!nav) return;
        nav.classList.remove('nav-hidden', 'nav-slide-up');
        nav.classList.add('nav-visible', 'nav-slide-down');
    }

    function hideNav() {
        const nav = document.getElementById('main-nav');
        if (!nav) return;
        // Don't hide if we're near the bottom
        if (getScrollPercent() >= BOTTOM_THRESHOLD_PERCENT) return;
        // Don't hide if mobile menu is open
        const mobileMenu = document.getElementById('mobile-menu');
        if (mobileMenu && !mobileMenu.classList.contains('hidden')) return;

        nav.classList.remove('nav-visible', 'nav-slide-down');
        nav.classList.add('nav-slide-up');
        // After animation completes, add hidden class
        setTimeout(() => {
            const currentScroll = window.scrollY || window.pageYOffset || document.documentElement.scrollTop;
            if (getScrollPercent() < BOTTOM_THRESHOLD_PERCENT && currentScroll > SCROLL_THRESHOLD) {
                const navEl = document.getElementById('main-nav');
                navEl?.classList.add('nav-hidden');
            }
        }, 300);
    }

    function updateNavVisibility() {
        const currentScrollY = window.scrollY || window.pageYOffset || document.documentElement.scrollTop;
        const scrollPercent = getScrollPercent();
        const isScrollingDown = currentScrollY > lastScrollY;
        const isScrollingUp = currentScrollY < lastScrollY;

        // Always show when near bottom of page
        if (scrollPercent >= BOTTOM_THRESHOLD_PERCENT) {
            showNav();
            lastScrollY = currentScrollY;
            return;
        }

        // Show at top of page
        if (currentScrollY <= SCROLL_THRESHOLD) {
            showNav();
            lastScrollY = currentScrollY;
            return;
        }

        // Scrolling down - hide (need significant movement to trigger)
        if (isScrollingDown && currentScrollY > SCROLL_THRESHOLD && (currentScrollY - lastScrollY) > 5) {
            hideNav();
        }

        // Scrolling up - show (need significant movement to trigger)
        if (isScrollingUp && (lastScrollY - currentScrollY) > 5) {
            showNav();
        }

        lastScrollY = currentScrollY;
    }

    // Handle scroll with throttling
    function handleNavScroll() {
        if (scrollTimeout) clearTimeout(scrollTimeout);
        scrollTimeout = setTimeout(updateNavVisibility, 10);
    }

    function setupNavigation() {
        // Only attach listener once
        if (navScrollListenerAttached) {
            // Just reset state and update visibility
            lastScrollY = window.scrollY || window.pageYOffset || document.documentElement.scrollTop;
            updateNavVisibility();
            return;
        }

        // Initial setup
        lastScrollY = window.scrollY || window.pageYOffset || document.documentElement.scrollTop;
        updateNavVisibility();

        // Event listeners - use both scroll and touchmove for better mobile support
        window.addEventListener('scroll', handleNavScroll, { passive: true });

        navScrollListenerAttached = true;
    }

    // Handle scroll-based navigation highlighting
    function setupScrollNavigation() {
        if (!isHomePage()) return;

        const sections = document.querySelectorAll('section[id]');
        const navLinks = document.querySelectorAll('.nav-link[data-is-anchor="true"]');
        const mobileNavLinks = document.querySelectorAll('.nav-link-mobile[data-is-anchor="true"]');

        if (sections.length === 0) return;

        // Function to update active link
        function updateActiveLink(activeId: string): void {
            // Update desktop links
            navLinks.forEach((link) => {
                const href = link.getAttribute('href') || '';
                const isActive = href.endsWith(`#${activeId}`);
                const underline = link.querySelector('span');

                if (isActive) {
                    link.classList.remove('text-foreground-secondary');
                    link.classList.add('text-primary');
                    underline?.classList.remove('w-0');
                    underline?.classList.add('w-full');
                } else {
                    link.classList.remove('text-primary');
                    link.classList.add('text-foreground-secondary');
                    underline?.classList.remove('w-full');
                    underline?.classList.add('w-0');
                }
            });

            // Update mobile links
            mobileNavLinks.forEach((link) => {
                const href = link.getAttribute('href') || '';
                const isActive = href.endsWith(`#${activeId}`);

                if (isActive) {
                    link.classList.remove('text-foreground-secondary');
                    link.classList.add('text-primary', 'bg-primary/10');
                } else {
                    link.classList.remove('text-primary', 'bg-primary/10');
                    link.classList.add('text-foreground-secondary');
                }
            });
        }

        // Intersection Observer for scroll detection
        const observerOptions = {
            root: null,
            rootMargin: '-20% 0px -80% 0px',
            threshold: 0
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach((entry) => {
                if (entry.isIntersecting) {
                    updateActiveLink(entry.target.id);
                }
            });
        }, observerOptions);

        sections.forEach((section) => {
            observer.observe(section);
        });

        // Handle scroll to top (clear active states)
        window.addEventListener('scroll', () => {
            if (window.pageYOffset < 100) {
                navLinks.forEach((link) => {
                    link.classList.remove('text-primary');
                    link.classList.add('text-foreground-secondary');
                    const underline = link.querySelector('span');
                    underline?.classList.remove('w-full');
                    underline?.classList.add('w-0');
                });
                mobileNavLinks.forEach((link) => {
                    link.classList.remove('text-primary', 'bg-primary/10');
                    link.classList.add('text-foreground-secondary');
                });
            }
        });
    }

    // Smooth scroll click handler using event delegation
    // Uses CAPTURE phase to intercept clicks BEFORE they bubble
    // This ensures we can prevent default behavior before the browser processes the hash
    document.addEventListener('click', (e) => {
        const target = e.target as HTMLElement;
        const link = target.closest('a[href*="#"]') as HTMLAnchorElement;

        if (!link) return;

        const href = link.getAttribute('href') || '';
        if (!href.includes('#')) return;

        // Only handle on home page
        if (!isHomePage()) return;

        try {
            const url = new URL(href, window.location.origin);
            const currentPath = window.location.pathname;

            // Normalize paths (remove trailing slashes)
            const normalizePath = (p: string) => p.endsWith('/') && p.length > 1 ? p.slice(0, -1) : p;
            const isSamePath = normalizePath(url.pathname) === normalizePath(currentPath);

            // Only handle same-page hash navigation
            if (isSamePath && url.hash) {
                const targetId = url.hash.substring(1);
                const targetElement = document.getElementById(targetId);

                if (targetElement) {
                    // CRITICAL: Prevent default IMMEDIATELY in capture phase
                    // This stops the browser from processing the hash before our scroll
                    e.preventDefault();
                    e.stopPropagation();

                    // Close menus if open
                    closeMobileMenu();
                    closeActionsMenu();

                    const header = document.querySelector('nav');
                    const headerHeight = header ? header.offsetHeight : 80;
                    const elementPosition = targetElement.getBoundingClientRect().top;
                    const offsetPosition = elementPosition + window.pageYOffset - headerHeight;

                    // Execute smooth scroll FIRST, then update URL when complete
                    // This prevents the browser from doing instant scroll
                    smoothScrollTo(offsetPosition, 1200, () => {
                        // Update URL without triggering scroll (after animation completes)
                        if (window.history?.replaceState) {
                            window.history.replaceState(null, '', url.href);
                        }
                    });
                }
            }
        } catch (err) {
            // Invalid URL, ignore
            console.error('[Navigation] Invalid URL in smooth scroll handler:', err);
        }
    }, true); // CAPTURE PHASE - intercepts event before it bubbles

    // Initialize navigation functions
    function initNavigation(): undefined {
        setupNavigation();
        setupScrollNavigation();
        return undefined;
    }

    // Use lifecycle manager if available, otherwise fallback to direct events
    import('@/lib/lifecycle').then(({ onPageLoad }) => {
        onPageLoad('navigation', initNavigation);
    }).catch(() => {
        // Fallback if lifecycle manager not available
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initNavigation);
        } else {
            initNavigation();
        }
        document.addEventListener('astro:page-load', initNavigation);
    });
</script>

<style>
    /* Navigation hide/show styles - all breakpoints */
    #main-nav {
        transition: transform 0.3s ease, opacity 0.3s ease;
    }

    .nav-visible {
        transform: translateY(0);
        opacity: 1;
    }

    .nav-hidden {
        transform: translateY(-100%);
        opacity: 0;
        pointer-events: none;
    }

    /* Slide down animation - navbar appears */
    .nav-slide-down {
        animation: navSlideDown 0.3s ease-out forwards;
    }

    /* Slide up animation - navbar disappears */
    .nav-slide-up {
        animation: navSlideUp 0.3s ease-in forwards;
    }

    @keyframes navSlideDown {
        from {
            transform: translateY(-100%);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    @keyframes navSlideUp {
        from {
            transform: translateY(0);
            opacity: 1;
        }
        to {
            transform: translateY(-100%);
            opacity: 0;
        }
    }
</style>
