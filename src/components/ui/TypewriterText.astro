---
/**
 * TypewriterText - Pure CSS typewriter animation
 *
 * CSS-only implementation - NO JavaScript DOM mutations.
 * All texts are rendered in DOM and animated with CSS.
 * Keyframes are generated dynamically based on text count.
 */

interface Props {
    texts: string[];
    class?: string;
    /** Duration each text is shown in seconds (default: 4) */
    cycleDuration?: number;
}

const { texts, class: className = '', cycleDuration = 4 } = Astro.props;

const totalTexts = texts.length;
const totalDuration = cycleDuration * totalTexts;

// Calculate keyframe percentages for each text
const slotPercent = 100 / totalTexts;

// Within each slot:
// - 0-20%: typing (width grows)
// - 20-80%: visible (full width)
// - 80-95%: deleting (width shrinks)
// - 95-100%: gap
const typeEnd = slotPercent * 0.2;
const visibleEnd = slotPercent * 0.8;
const deleteEnd = slotPercent * 0.95;
---

<span
    class:list={['typewriter', className]}
    style={`--total-duration: ${totalDuration}s;`}
>
    <span class="typewriter-wrapper">
        {texts.map((text, index) => (
            <span
                class={`typewriter-text typewriter-text-${index}`}
                aria-hidden={index > 0 ? "true" : undefined}
            >
                <span class="typewriter-content" set:html={text} />
                <span class="typewriter-cursor" aria-hidden="true">|</span>
            </span>
        ))}
    </span>
</span>

<style>
    .typewriter {
        display: inline-flex;
        align-items: baseline;
    }

    .typewriter-wrapper {
        position: relative;
        display: inline-grid;
    }

    .typewriter-text {
        grid-area: 1 / 1;
        display: inline-flex;
        overflow: hidden;
        white-space: nowrap;
        font-family: 'Courier New', Courier, monospace;
        color: hsl(var(--primary));
        width: 0;
    }

    .typewriter-content {
        display: inline-block;
    }

    .typewriter-cursor {
        animation: blink 0.5s step-end infinite;
        font-weight: 900;
        opacity: 1;
        flex-shrink: 0;
    }

    @keyframes blink {
        0%, 100% { opacity: 1; }
        50% { opacity: 0; }
    }

    /* Light mode: darker primary for better contrast */
    :global(html:not(.dark)) .typewriter-text {
        color: hsl(205, 100%, 20%);
    }

    /* Respect reduced motion preferences */
    @media (prefers-reduced-motion: reduce) {
        .typewriter-text {
            animation: none !important;
            width: auto;
        }

        .typewriter-text:not(:first-child) {
            display: none;
        }

        .typewriter-cursor {
            animation: none;
        }
    }
</style>

{/* Generate individual keyframes for each text */}
<style set:html={texts.map((_, index) => {
    const startPercent = index * slotPercent;

    const p1 = startPercent + typeEnd;
    const p2 = startPercent + visibleEnd;
    const p3 = startPercent + deleteEnd;
    const p4 = (index + 1) * slotPercent;

    return `
        .typewriter-text-${index} {
            animation: typewriter-${index} var(--total-duration) steps(15, end) infinite;
        }

        @keyframes typewriter-${index} {
            0%${startPercent > 0 ? `, ${startPercent.toFixed(1)}%` : ''} { width: 0; }
            ${p1.toFixed(1)}%, ${p2.toFixed(1)}% { width: 100%; }
            ${p3.toFixed(1)}%, ${p4.toFixed(1)}%${index === texts.length - 1 ? ', 100%' : ''} { width: 0; }
        }
    `;
}).join('\n')} />
