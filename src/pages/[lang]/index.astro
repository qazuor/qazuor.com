---
import { getImage } from 'astro:assets';
import type { CollectionEntry } from 'astro:content';
import { getCollection } from 'astro:content';
import type { ImageMetadata } from 'astro';
import { Contact } from '@/components/forms/Contact';
import AboutSection from '@/components/sections/AboutSection.astro';
import BlogSection from '@/components/sections/BlogSection.astro';
import HeroSection from '@/components/sections/HeroSection.astro';
import ProjectsFeaturedSection from '@/components/sections/ProjectsFeaturedSection.astro';
import SkillsSection from '@/components/sections/SkillsSection.astro';
import TestimonialsSection from '@/components/sections/TestimonialsSection.astro';
import DiagonalDivider from '@/components/ui/dividers/DiagonalDivider.astro';
import WaveDivider from '@/components/ui/dividers/WaveDivider.astro';
import ZigzagDivider from '@/components/ui/dividers/ZigZagDivider.astro';
import { contact, sectionsColors } from '@/data';
import { languages } from '@/i18n/ui';
import { getLangFromUrl, getTranslations } from '@/i18n/utils';
import BaseLayout from '@/layouts/BaseLayout.astro';
import { getProjectSlug } from '@/utils/projects';

export function getStaticPaths() {
    return Object.keys(languages).map((lang) => ({
        params: { lang }
    }));
}

const lang = getLangFromUrl(Astro.url);
const t = getTranslations(lang);

// SEO Translations
const seoTranslations = {
    title: t('seo.title', { markdown: true }),
    description: t('home.description', { markdown: true }),
    imageAlt: t('seo.imageAlt', { markdown: true })
};

// SEO keywords - definidos directamente ya que las traducciones no manejan bien arrays
const seoKeywords =
    lang === 'es'
        ? [
              'Desarrollador Full-Stack',
              'React',
              'TypeScript',
              'Desarrollo Web',
              'UI/UX',
              'JavaScript',
              'Node.js',
              'Astro',
              'TailwindCSS',
              'Portafolio'
          ]
        : [
              'Full-Stack Developer',
              'React',
              'TypeScript',
              'Web Development',
              'UI/UX',
              'JavaScript',
              'Node.js',
              'Astro',
              'TailwindCSS',
              'Portfolio'
          ];

// Load Content Collections - filter projects by language
const allProjects = await getCollection('projects', (entry: CollectionEntry<'projects'>) => {
    return entry.data.lang === lang;
});
const allBlogPosts = await getCollection('blog');
const allTestimonials = await getCollection('testimonials');

// Sort projects by order field, then by date
const sortedProjects = await Promise.all(
    allProjects
        .sort((a: CollectionEntry<'projects'>, b: CollectionEntry<'projects'>) => {
            if (a.data.order !== b.data.order) {
                return a.data.order - b.data.order;
            }
            return b.data.publishDate.getTime() - a.data.publishDate.getTime();
        })
        .map(async (project: CollectionEntry<'projects'>) => {
            const processedImages = await Promise.all(
                project.data.images.map(async (img: ImageMetadata) => {
                    // Optimize with specific dimensions for project cards (16:9 aspect ratio)
                    const optimizedImg = await getImage({
                        src: img,
                        width: 800,
                        height: 450,
                        format: 'webp'
                    });
                    return {
                        src: optimizedImg.src,
                        width: 800,
                        height: 450
                    };
                })
            );
            const cleanSlug = getProjectSlug(project);
            return {
                title: project.data.title,
                description: project.data.description,
                slug: cleanSlug,
                technologies: project.data.technologies,
                images: processedImages,
                featured: project.data.featured,
                order: project.data.order
            };
        })
);

// Sort blog posts by date (newest first) and filter out drafts
const sortedBlogPosts = allBlogPosts
    .filter((post: CollectionEntry<'blog'>) => !post.data.draft)
    .sort(
        (a: CollectionEntry<'blog'>, b: CollectionEntry<'blog'>) =>
            b.data.publishDate.getTime() - a.data.publishDate.getTime()
    )
    .map((post: CollectionEntry<'blog'>) => ({
        title: post.data.title,
        excerpt: post.data.excerpt,
        date: post.data.publishDate.toISOString().split('T')[0],
        readTime: post.data.readTime,
        tags: post.data.tags,
        slug: `/${lang}/blog/${post.slug}`
    }));

// Sort testimonials by order and date, and optimize avatar images
const sortedTestimonialsRaw = allTestimonials.sort(
    (a: CollectionEntry<'testimonials'>, b: CollectionEntry<'testimonials'>) => {
        if (a.data.order !== b.data.order) {
            return a.data.order - b.data.order;
        }
        return b.data.date.getTime() - a.data.date.getTime();
    }
);

// Process testimonials with optimized avatar images
const sortedTestimonials = await Promise.all(
    sortedTestimonialsRaw.map(async (testimonial: CollectionEntry<'testimonials'>) => {
        let optimizedAvatar: string | undefined;

        // Optimize avatar image if available (ImageMetadata from content collection)
        if (testimonial.data.avatar) {
            try {
                const img = await getImage({
                    src: testimonial.data.avatar as ImageMetadata,
                    width: 96,
                    height: 96,
                    format: 'webp'
                });
                optimizedAvatar = img.src;
            } catch (error) {
                console.warn(`Failed to optimize avatar for ${testimonial.data.name}:`, error);
            }
        }

        return {
            name: testimonial.data.name,
            role: testimonial.data.role,
            company: testimonial.data.company,
            content: testimonial.data.content,
            avatar: optimizedAvatar,
            avatarUrl: testimonial.data.avatarUrl,
            linkedinUrl: testimonial.data.linkedinUrl,
            source: testimonial.data.source
        };
    })
);

// Translations for components
const heroTranslations = {
    iBuildText: t('home.hero.iBuildText', { markdown: true }),
    viewProjects: t('home.hero.viewProjects', { markdown: true }),
    getInTouch: t('home.hero.getInTouch', { markdown: true }),
    downloadResume: t('home.hero.downloadResume', { markdown: true }),
    scroll: t('home.hero.scroll', { markdown: true })
};

const heroAriaLabels = {
    github: t('aria.github'),
    linkedin: t('aria.linkedin'),
    fiverr: t('aria.fiverr'),
    upwork: t('aria.upwork'),
    whatsapp: t('aria.whatsapp'),
    mail: t('aria.mail'),
    buymeacoffee: t('aria.buymeacoffee')
};

const aboutTranslations = {
    title: t('about.title', { markdown: true }),
    subtitle: t('about.subtitle', { markdown: true }),
    storyTitle: t('about.storyTitle', { markdown: true }),
    storyParagraph1: t('about.storyParagraph1', { markdown: true }),
    storyParagraph2: t('about.storyParagraph2', { markdown: true }),
    storyParagraph3: t('about.storyParagraph3', { markdown: true }),
    storySummary: t('about.storySummary', { markdown: true }),
    ctaButton: t('about.ctaButton', { markdown: true }),
    connect: t('about.connect', { markdown: true }),
    workTogether: t('about.workTogether', { markdown: true }),
    timeline: {
        beginning: {
            title: t('about.timeline.beginning.title', { markdown: true }),
            description: t('about.timeline.beginning.description', { markdown: true })
        },
        present: {
            description: t('about.timeline.present.description', { markdown: true })
        }
    }
};

const skillsTranslations = {
    title: t('skills.title', { markdown: true }),
    subtitle: t('skills.subtitle', { markdown: true }),
    description: t('skills.description', { markdown: true }),
    categoryTitles: {
        technicalSkills: t('skills.categories.technicalSkills', { markdown: true }),
        humanCreativeSkills: t('skills.categories.humanCreativeSkills', { markdown: true })
    },
    skillItems: {
        // Soft Skills
        adaptability: t('skills.items.adaptability'),
        positiveAttitude: t('skills.items.positiveAttitude'),
        communication: t('skills.items.communication'),
        flexibility: t('skills.items.flexibility'),
        analyticalThinking: t('skills.items.analyticalThinking'),
        teamwork: t('skills.items.teamwork'),
        decisionMaking: t('skills.items.decisionMaking'),
        creativity: t('skills.items.creativity'),
        problemSolving: t('skills.items.problemSolving'),
        curiosity: t('skills.items.curiosity'),
        // Creative Skills
        graphicDesign: t('skills.items.graphicDesign'),
        branding: t('skills.items.branding'),
        imageEditing: t('skills.items.imageEditing'),
        // Technical Other Skills
        webPerformance: t('skills.items.webPerformance'),
        webAccessibility: t('skills.items.webAccessibility'),
        automation: t('skills.items.automation'),
        seo: t('skills.items.seo')
    },
    skillDescriptions: {
        graphicDesignDescription: t('skills.descriptions.graphicDesignDescription'),
        brandingDescription: t('skills.descriptions.brandingDescription'),
        imageEditingDescription: t('skills.descriptions.imageEditingDescription'),
        webPerformanceDescription: t('skills.descriptions.webPerformanceDescription'),
        webAccessibilityDescription: t('skills.descriptions.webAccessibilityDescription'),
        automationDescription: t('skills.descriptions.automationDescription'),
        seoDescription: t('skills.descriptions.seoDescription')
    },
    languages: {
        title: t('skills.languages.title'),
        native: t('skills.languages.native'),
        writtenOnly: t('skills.languages.writtenOnly')
    }
};

const projectsTranslations = {
    title: t('projects.title', { markdown: true }),
    subtitle: t('projects.subtitle', { markdown: true }),
    description: t('projects.description', { markdown: true }),
    viewAll: t('projects.viewAll', { markdown: true })
};

const blogTranslations = {
    title: t('blog.title', { markdown: true }),
    subtitle: t('blog.subtitle', { markdown: true }),
    description: t('blog.description', { markdown: true }),
    viewAll: t('blog.viewAll', { markdown: true }),
    noArticles: t('blog.noArticles', { markdown: true }),
    readMore: t('blog.readMore', { markdown: true }),
    readTime: t('blog.readTime', { markdown: true })
};

const contactTranslations = {
    title: t('contact.title', { markdown: true }),
    subtitle: t('contact.subtitle', { markdown: true }),
    description: t('contact.description', { markdown: true }),
    info: {
        title: t('contact.info.title', { markdown: true }),
        description: t('contact.info.description', { markdown: true }),
        email: t('contact.info.email', { markdown: true }),
        phone: t('contact.info.phone', { markdown: true }),
        location: t('contact.info.location', { markdown: true }),
        orConnect: t('contact.info.orConnect', { markdown: true })
    },
    form: {
        name: t('contact.form.name', { markdown: true }),
        email: t('contact.form.email', { markdown: true }),
        company: t('contact.form.company', { markdown: true }),
        subject: t('contact.form.subject', { markdown: true }),
        interest: t('contact.form.interest', { markdown: true }),
        message: t('contact.form.message', { markdown: true }),
        charCount: t('contact.form.charCount', { markdown: true }),
        send: t('contact.form.send', { markdown: true }),
        sending: t('contact.form.sending', { markdown: true })
    },
    placeholders: {
        name: t('contact.placeholders.name'),
        email: t('contact.placeholders.email'),
        company: t('contact.placeholders.company'),
        subject: t('contact.placeholders.subject'),
        message: t('contact.placeholders.message')
    },
    interests: {
        websiteDesign: t('contact.interests.websiteDesign', { markdown: true }),
        branding: t('contact.interests.branding', { markdown: true }),
        webDevelopment: t('contact.interests.webDevelopment', { markdown: true }),
        logoDesign: t('contact.interests.logoDesign', { markdown: true }),
        appDevelopment: t('contact.interests.appDevelopment', { markdown: true }),
        automation: t('contact.interests.automation', { markdown: true }),
        remote: t('contact.interests.remote', { markdown: true }),
        fulltime: t('contact.interests.fulltime', { markdown: true }),
        contractor: t('contact.interests.contractor', { markdown: true })
    },
    errors: {
        nameRequired: t('contact.errors.nameRequired', { markdown: true }),
        emailRequired: t('contact.errors.emailRequired', { markdown: true }),
        emailInvalid: t('contact.errors.emailInvalid', { markdown: true }),
        subjectRequired: t('contact.errors.subjectRequired', { markdown: true }),
        messageRequired: t('contact.errors.messageRequired', { markdown: true }),
        messageMinLength: t('contact.errors.messageMinLength', { markdown: true })
    },
    success: t('contact.success', { markdown: true }),
    error: t('contact.error', { markdown: true })
};

const contactAriaLabels = {
    github: t('aria.github'),
    linkedin: t('aria.linkedin'),
    whatsapp: t('aria.whatsapp'),
    mail: t('aria.mail')
};

const testimonialsTranslations = {
    title: t('testimonials.title', { markdown: true }),
    subtitle: t('testimonials.subtitle', { markdown: true }),
    description: t('testimonials.description', { markdown: true }),
    noTestimonials: t('testimonials.noTestimonials', { markdown: true }),
    readMore: t('testimonials.readMore', { markdown: true }),
    readLess: t('testimonials.readLess', { markdown: true }),
    viewProfile: t('testimonials.viewProfile', { markdown: true }),
    viewMore: t('testimonials.viewMore', { markdown: true })
};

// Profile translations
const profileTranslations = {
    name: t('profile.name', { markdown: true }),
    role: t('profile.role', { markdown: true })
};

// Hero content translations
const heroContentTranslations = {
    iBuild: [
        t('home.iBuild.webapps', { markdown: true }),
        t('home.iBuild.interfaces', { markdown: true }),
        t('home.iBuild.solutions', { markdown: true }),
        t('home.iBuild.experiences', { markdown: true }),
        t('home.iBuild.uis', { markdown: true }),
        t('home.iBuild.tools', { markdown: true })
    ],
    roles: [
        t('home.roles.fullstack', { markdown: true }),
        t('home.roles.frontend', { markdown: true }),
        t('home.roles.designer', { markdown: true })
    ],
    subtitle: t('home.hero.subtitle', { markdown: true })
};

// Colors are now imported from data module
---

<BaseLayout
    title={seoTranslations.title}
    description={seoTranslations.description}
    imageAlt={seoTranslations.imageAlt}
    type="profile"
    keywords={seoKeywords}
    author={profileTranslations.name}
    jobTitle={profileTranslations.role}
    socialLinks={{
        github: contact.social.github,
        linkedin: contact.social.linkedin,
        fiverr: contact.social.fiverr,
        upwork: contact.social.upwork
    }}
>
    <!-- Hero Section (background with gradients) -->
    <div class="relative">
        <HeroSection
            primaryColor={sectionsColors.hero}
            name={profileTranslations.name}
            iBuild={heroContentTranslations.iBuild}
            roles={heroContentTranslations.roles}
            subtitle={heroContentTranslations.subtitle}
            translations={heroTranslations}
            ariaLabels={heroAriaLabels}
            heroAvatarAlt={t('imageAlt.heroAvatar')}
        />
        <WaveDivider transition="hero-to-about" />
    </div>

    <!-- About Section with purple gradient background -->
    <div class="relative">
        <AboutSection primaryColor={sectionsColors.about} lang={lang} translations={aboutTranslations} />
        <DiagonalDivider direction="mixed" transition="about-to-skills" />
    </div>

    <!-- Skills Section with indigo gradient background -->
    <div class="relative">
        <SkillsSection primaryColor={sectionsColors.skills} translations={skillsTranslations} />
        <WaveDivider transition="skills-to-projects" />
    </div>

    <!-- Projects Section with blue gradient background -->
    <div class="relative">
        <ProjectsFeaturedSection
            primaryColor={sectionsColors.projects}
            projects={sortedProjects}
            translations={projectsTranslations}
            lang={lang}
        />
        <DiagonalDivider direction="right" transition="projects-to-blog" />
    </div>

    <!-- Blog Section with cyan gradient background -->
    <div class="relative">
        <BlogSection
            primaryColor={sectionsColors.blog}
            posts={sortedBlogPosts}
            translations={blogTranslations}
            lang={lang}
        />
        <DiagonalDivider direction="left" transition="blog-to-testimonials" />
    </div>

    <!-- Testimonials Section with purple gradient background -->
    <div class="relative">
        <TestimonialsSection
            primaryColor={sectionsColors.testimonials}
            testimonials={sortedTestimonials}
            translations={testimonialsTranslations}
        />
        <ZigzagDivider transition="testimonials-to-contact" />
    </div>

    <!-- Contact Section with gradient background -->
    <div
        class="relative section section-contact overflow-hidden"
        style={`background-color: ${sectionsColors.contact}`}
    >
        <!-- Animated Gradient Background (rendered from Astro) -->
        <div class="absolute inset-0" style="top: 200px">
            <div
                class="absolute inset-0 bg-gradient-to-br from-primary via-secondary to-accent rounded-lg blur-3xl"
                style="animation: pulse 4s ease-in-out infinite; opacity: 0.6;"
            >
            </div>
        </div>
        <Contact
            client:visible
            contactData={{
                email: contact.email,
                phone: contact.phone,
                location: contact.location,
                social: {
                    github: contact.social.github,
                    linkedin: contact.social.linkedin,
                    whatsapp: contact.social.whatsapp,
                    mail: contact.social.mail
                }
            }}
            translations={contactTranslations}
            ariaLabels={contactAriaLabels}
        />
        <DiagonalDivider direction="left" transition="contact-to-footer" />
    </div>
</BaseLayout>
