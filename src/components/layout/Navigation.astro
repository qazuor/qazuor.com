---
import { normalizeTrailingSlash } from '@reunmedia/astro-normalize-trailing-slash';
import { CommandButton } from '@/components/interactive/CommandButton';
import { LanguageSelector } from '@/components/interactive/LanguageSelector';
import { ServicesDropdown } from '@/components/interactive/ServicesDropdown';
import { ThemeToggle } from '@/components/interactive/ThemeToggle';
import { services } from '@/data/services';
import { getLangFromUrl, getTranslations, translatePath } from '@/i18n/utils';

const lang = getLangFromUrl(Astro.url);
const t = getTranslations(lang);
const currentPath = Astro.url.pathname;

// Helper function to format nav labels as HTML tags
const formatAsTag = (label: string) => `<${label.toLowerCase()} />`;

// Services dropdown translations (clean markdown syntax)
const servicesDropdownTranslations = {
    webApps: t('services.webApps.title', { markdown: false }).replace(/\*\*/g, ''),
    landingPages: t('services.landingPages.title', { markdown: false }).replace(/\*\*/g, ''),
    automation: t('services.automation.title', { markdown: false }).replace(/\*\*/g, ''),
    socialDesign: t('services.socialDesign.title', { markdown: false }).replace(/\*\*/g, '')
};

// Check if we're on the home page for navigation logic
const isHomePage =
    currentPath === translatePath('/', lang) || currentPath === `/${lang}` || currentPath === `/${lang}/`;

const navItems = [
    { href: `${translatePath('/', lang)}#about`, label: formatAsTag(t('nav.about')) },
    { href: `${translatePath('/', lang)}#skills`, label: formatAsTag(t('nav.skills')) },
    { href: `${translatePath('/', lang)}#projects`, label: formatAsTag(t('nav.projects')) },
    {
        href: isHomePage ? `${translatePath('/', lang)}#blog` : translatePath('/blog', lang),
        label: formatAsTag(t('nav.blog'))
    },
    { href: translatePath('/services', lang), label: formatAsTag(t('nav.services')) },
    { href: `${translatePath('/', lang)}#testimonials`, label: formatAsTag(t('nav.testimonials')) },
    { href: translatePath('/tools', lang), label: formatAsTag(t('nav.tools')) },
    { href: `${translatePath('/', lang)}#contact`, label: formatAsTag(t('nav.contact')) }
];

const isActive = (href: string) => {
    // Handle home page anchor links - don't mark as active server-side
    // Active state will be handled by JavaScript based on scroll position
    if (href.includes('#')) {
        return false; // Let JavaScript handle active state for anchor links
    }

    // Handle regular page links
    if (href === translatePath('/', lang)) {
        return currentPath === href || currentPath === `/${lang}` || currentPath === `/${lang}/`;
    }

    return currentPath.startsWith(href);
};
---

<nav class="glass sticky top-0 z-[500] border-b" id="main-nav">
    <div class="container-custom relative">
        <div class="flex justify-between items-center h-14">
            <!-- Logo with Avatar -->
            <a
                href={translatePath('/#hero', lang)}
                class="logo flex items-center gap-3 hover:scale-105 transition-transform duration-base"
            >
                <div
                    class="w-8 h-8 rounded-full overflow-hidden border-2 border-primary/20 hover:border-primary/50 transition-colors"
                >
                    <img src="/avatar.png" alt="qazuor avatar" class="w-full h-full object-cover" loading="eager" />
                </div>
                <span class="text-lg font-bold gradient-text font-mono whitespace-nowrap">~/qazuor</span>
            </a>

            <!-- Desktop Navigation Links (hidden below 768px) -->
            <div class="hidden md:flex items-center gap-5">
                {
                    navItems.map((item) => {
                        // Use dropdown for services
                        if (item.href.includes('/services')) {
                            return (
                                <ServicesDropdown
                                    client:load
                                    currentLocale={lang}
                                    currentPath={currentPath}
                                    allServicesLabel={item.label}
                                    translations={servicesDropdownTranslations}
                                />
                            );
                        }

                        // Regular link for other items
                        return (
                            <a
                                href={item.href.includes('#') ? item.href : normalizeTrailingSlash(item.href)}
                                class={`nav-link text-[0.65rem] font-medium font-mono whitespace-nowrap transition-all duration-base relative group ${
                                    isActive(item.href) ? 'text-primary' : 'text-foreground-secondary hover:text-foreground'
                                }`}
                                data-is-anchor={item.href.includes('#') ? 'true' : 'false'}
                                data-is-home-page={isHomePage ? 'true' : 'false'}
                            >
                                {item.label}
                                {/* Underline animation */}
                                <span
                                    class={`absolute -bottom-1 left-0 h-0.5 bg-gradient-to-r from-primary to-secondary transition-all duration-base ${
                                        isActive(item.href) ? 'w-full' : 'w-0 group-hover:w-full'
                                    }`}
                                />
                            </a>
                        );
                    })
                }
            </div>

            <!-- Actions: Desktop (1400px+) - All visible, separate -->
            <div class="hidden min-[1400px]:flex items-center gap-2">
                <CommandButton ariaLabel={t('aria.openCommandPalette')} client:load />
                <LanguageSelector currentLocale={lang} client:load />
                <ThemeToggle ariaLabel={t('aria.toggleTheme')} client:load />
            </div>

            <!-- Actions: Large (1200-1399px) - Language compact mode -->
            <div class="hidden min-[1200px]:flex min-[1400px]:hidden items-center gap-2">
                <CommandButton ariaLabel={t('aria.openCommandPalette')} client:load />
                <LanguageSelector currentLocale={lang} compact client:load />
                <ThemeToggle ariaLabel={t('aria.toggleTheme')} client:load />
            </div>

            <!-- Actions: Medium (768-1199px) - Only links visible, actions in hamburger -->
            <button
                id="actions-menu-button"
                class="hidden md:flex min-[1200px]:hidden p-1.5 rounded-lg text-foreground-secondary hover:bg-foreground/5 transition-colors duration-base"
                aria-label={t('aria.toggleActionsMenu')}
            >
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"
                    ></path>
                </svg>
            </button>

            <!-- Mobile menu button (< 768px) - Everything in hamburger -->
            <button
                id="mobile-menu-button"
                class="md:hidden p-1.5 rounded-lg text-foreground-secondary hover:bg-foreground/5 transition-colors duration-base"
                aria-label={t('aria.toggleMenu')}
            >
                <svg id="menu-icon" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"
                    ></path>
                </svg>
                <svg id="close-icon" class="w-5 h-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"
                    ></path>
                </svg>
            </button>
        </div>

        <!-- Actions Menu (768-1199px: only actions, no links) - Floating Overlay -->
        <div
            id="actions-menu"
            class="hidden absolute top-full right-0 mt-2 w-64 rounded-lg bg-card border border-border shadow-lg z-50"
        >
            <div class="flex items-center gap-2 p-4">
                <CommandButton ariaLabel={t('aria.openCommandPalette')} client:load />
                <LanguageSelector currentLocale={lang} client:load />
                <ThemeToggle ariaLabel={t('aria.toggleTheme')} client:load />
            </div>
        </div>

        <!-- Mobile Menu (< 768px: links + actions) - Floating Overlay -->
        <div
            id="mobile-menu"
            class="hidden md:hidden absolute top-full left-0 right-0 mt-2 mx-4 rounded-lg bg-card border border-border shadow-lg z-50 max-h-[calc(100vh-5rem)] overflow-y-auto"
        >
            <div class="py-2 space-y-1">
                {
                    navItems.map((item) => {
                        // Services with collapsible submenu
                        if (item.href.includes('/services')) {
                            return (
                                <div>
                                    {/* Main Services Toggle Button */}
                                    <button
                                        type="button"
                                        id="services-toggle"
                                        class={`nav-link-mobile w-full flex items-center justify-between px-4 py-3 text-[0.65rem] font-medium font-mono whitespace-nowrap transition-all duration-base ${
                                            isActive(item.href)
                                                ? 'bg-primary/10 text-primary'
                                                : 'text-foreground-secondary hover:bg-foreground/5 hover:text-foreground'
                                        }`}
                                    >
                                        <span>{item.label}</span>
                                        <svg
                                            id="services-arrow"
                                            class="w-4 h-4 transition-transform duration-200"
                                            fill="none"
                                            viewBox="0 0 24 24"
                                            stroke="currentColor"
                                        >
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                                        </svg>
                                    </button>
                                    {/* Services Submenu - Hidden by default */}
                                    <div id="services-submenu" class="hidden pl-4 space-y-1 overflow-hidden">
                                        {services.map((service) => {
                                            const serviceLabel = servicesDropdownTranslations[
                                                service.id === 'web-apps' ? 'webApps' :
                                                service.id === 'landing-pages' ? 'landingPages' :
                                                service.id === 'automation-integration' ? 'automation' :
                                                'socialDesign'
                                            ];
                                            return (
                                                <a
                                                    href={`/${lang}/services/${service.slug}`}
                                                    class="nav-link-mobile block px-4 py-2 text-[0.65rem] text-foreground-secondary hover:bg-foreground/5 hover:text-foreground transition-all duration-base rounded-lg"
                                                >
                                                    <span class="mr-2">{service.icon}</span>
                                                    {serviceLabel}
                                                </a>
                                            );
                                        })}
                                    </div>
                                </div>
                            );
                        }

                        // Regular links for other items
                        return (
                            <a
                                href={normalizeTrailingSlash(item.href)}
                                class={`nav-link-mobile block px-4 py-3 text-[0.65rem] font-medium font-mono whitespace-nowrap transition-all duration-base ${
                                    isActive(item.href)
                                        ? 'bg-primary/10 text-primary'
                                        : 'text-foreground-secondary hover:bg-foreground/5 hover:text-foreground'
                                }`}
                                data-is-anchor={item.href.includes('#') ? 'true' : 'false'}
                                data-is-home-page={isHomePage ? 'true' : 'false'}
                            >
                                {item.label}
                            </a>
                        );
                    })
                }
            </div>
            <div class="flex items-center gap-2 p-4 border-t border-foreground/10">
                <CommandButton ariaLabel={t('aria.openCommandPalette')} client:load />
                <LanguageSelector currentLocale={lang} client:load />
                <ThemeToggle ariaLabel={t('aria.toggleTheme')} client:load />
            </div>
        </div>
    </div>
</nav>

<!-- Backdrop for mobile menu -->
<div id="menu-backdrop" class="hidden fixed inset-0 bg-background/80 backdrop-blur-sm z-40"></div>

<script>
    // Mobile menu toggle (< 768px)
    const mobileButton = document.getElementById('mobile-menu-button');
    const mobileMenu = document.getElementById('mobile-menu');
    const menuIcon = document.getElementById('menu-icon');
    const closeIcon = document.getElementById('close-icon');
    const backdrop = document.getElementById('menu-backdrop');

    function closeMobileMenu() {
        mobileMenu?.classList.add('hidden');
        menuIcon?.classList.remove('hidden');
        closeIcon?.classList.add('hidden');
        backdrop?.classList.add('hidden');
    }

    function openMobileMenu() {
        mobileMenu?.classList.remove('hidden');
        menuIcon?.classList.add('hidden');
        closeIcon?.classList.remove('hidden');
        backdrop?.classList.remove('hidden');
    }

    mobileButton?.addEventListener('click', () => {
        const isHidden = mobileMenu?.classList.contains('hidden');
        if (isHidden) {
            openMobileMenu();
        } else {
            closeMobileMenu();
        }
    });

    // Actions menu toggle (768-1199px)
    const actionsButton = document.getElementById('actions-menu-button');
    const actionsMenu = document.getElementById('actions-menu');

    function closeActionsMenu() {
        actionsMenu?.classList.add('hidden');
    }

    function openActionsMenu() {
        actionsMenu?.classList.remove('hidden');
    }

    actionsButton?.addEventListener('click', () => {
        const isHidden = actionsMenu?.classList.contains('hidden');
        if (isHidden) {
            openActionsMenu();
        } else {
            closeActionsMenu();
        }
    });

    // Close menus when clicking backdrop
    backdrop?.addEventListener('click', () => {
        closeMobileMenu();
    });

    // Close menus when clicking outside
    document.addEventListener('click', (e) => {
        const target = e.target as Node;

        // Close actions menu if clicking outside
        if (
            actionsMenu &&
            !actionsMenu.contains(target) &&
            actionsButton &&
            !actionsButton.contains(target)
        ) {
            closeActionsMenu();
        }
    });

    // Services submenu toggle in mobile menu
    const servicesToggle = document.getElementById('services-toggle');
    const servicesSubmenu = document.getElementById('services-submenu');
    const servicesArrow = document.getElementById('services-arrow');

    servicesToggle?.addEventListener('click', () => {
        const isHidden = servicesSubmenu?.classList.contains('hidden');
        if (isHidden) {
            servicesSubmenu?.classList.remove('hidden');
            servicesArrow?.classList.add('rotate-90');
        } else {
            servicesSubmenu?.classList.add('hidden');
            servicesArrow?.classList.remove('rotate-90');
        }
    });

    // Close menus when clicking on any navigation link or interactive element
    function setupMenuClosing() {
        // Close mobile menu when clicking any link inside it
        const mobileMenuLinks = mobileMenu?.querySelectorAll('a');
        mobileMenuLinks?.forEach((link) => {
            link.addEventListener('click', () => {
                closeMobileMenu();
            });
        });

        // Close menus when clicking on interactive elements in the actions area
        // Use event delegation since React components hydrate after DOM load
        const closeOnInteraction = (menu: HTMLElement | null, closeFunc: () => void) => {
            if (!menu) return;

            menu.addEventListener('click', (e) => {
                const target = e.target as HTMLElement;

                // Check if it's a button or inside a language selector
                // Also check parent elements since SVG clicks bubble up
                const clickedButton = target.closest('button');
                const isLanguageSelector = target.closest('.language-selector');
                const isSvgClick = target.tagName === 'svg' || target.tagName === 'SVG' || target.closest('svg');

                // Close menu if clicking on interactive elements
                if (clickedButton || isLanguageSelector || isSvgClick) {
                    // Give the component time to execute its action
                    setTimeout(closeFunc, 150);
                }
            });
        };

        // Get the action containers inside menus
        const mobileMenuActions = mobileMenu?.querySelector('.flex.items-center.gap-2.p-4');
        const actionsMenuContent = actionsMenu?.querySelector('.flex.items-center.gap-2.p-4');

        closeOnInteraction(mobileMenuActions as HTMLElement, closeMobileMenu);
        closeOnInteraction(actionsMenuContent as HTMLElement, closeActionsMenu);
    }

    // Setup after DOM is loaded
    document.addEventListener('DOMContentLoaded', setupMenuClosing);

    // Also setup after a delay to catch hydrated React components
    setTimeout(setupMenuClosing, 500);

    // Check if we're on home page
    function isHomePage() {
        const path = window.location.pathname;
        return path === '/' || path === '/en' || path === '/es' || path === '/en/' || path === '/es/';
    }

    // Smooth scroll functionality
    function smoothScrollTo(targetY: number, duration = 1200): void {
        const startY = window.pageYOffset;
        const distance = targetY - startY;
        let startTime: number | null = null;

        function animation(currentTime: number): void {
            if (startTime === null) startTime = currentTime;
            const timeElapsed = currentTime - startTime;
            const progress = Math.min(timeElapsed / duration, 1);

            const ease =
                progress < 0.5
                    ? 4 * progress * progress * progress
                    : (progress - 1) * (2 * progress - 2) * (2 * progress - 2) + 1;

            window.scrollTo(0, startY + distance * ease);

            if (progress < 1) {
                requestAnimationFrame(animation);
            }
        }
        requestAnimationFrame(animation);
    }

    // Mobile navigation hide/show on scroll
    function setupMobileNavigation() {
        const nav = document.getElementById('main-nav');
        let lastScrollY = 0;
        let scrollTimeout: ReturnType<typeof setTimeout> | undefined;
        const SCROLL_THRESHOLD = 100;

        function updateNavVisibility() {
            const currentScrollY = window.scrollY;
            const isDesktop = window.innerWidth >= 768; // md breakpoint

            if (isDesktop) {
                // Always show on desktop, remove mobile classes
                nav?.classList.remove('mobile-nav-hidden', 'mobile-nav-slide-up', 'mobile-nav-slide-down');
                lastScrollY = currentScrollY;
                return;
            }

            const isScrollingDown = currentScrollY > lastScrollY;
            const isScrollingUp = currentScrollY < lastScrollY;

            // Mobile behavior: show at top, hide when scrolling down, show when scrolling up
            if (currentScrollY === 0) {
                // Show when at top with slide down animation
                nav?.classList.remove('mobile-nav-hidden', 'mobile-nav-slide-up');
                nav?.classList.add('mobile-nav-slide-down');
            } else if (isScrollingDown && currentScrollY > SCROLL_THRESHOLD) {
                // Hide when scrolling down past threshold
                if (!nav?.classList.contains('mobile-nav-hidden')) {
                    nav?.classList.remove('mobile-nav-slide-down');
                    nav?.classList.add('mobile-nav-slide-up');
                    // After animation completes, hide completely
                    setTimeout(() => {
                        if (window.scrollY > SCROLL_THRESHOLD && window.scrollY > lastScrollY) {
                            nav?.classList.add('mobile-nav-hidden');
                        }
                    }, 300);
                }
            } else if (isScrollingUp) {
                // Show when scrolling up
                if (nav?.classList.contains('mobile-nav-hidden')) {
                    nav?.classList.remove('mobile-nav-hidden', 'mobile-nav-slide-up');
                    nav?.classList.add('mobile-nav-slide-down');
                }
            }

            lastScrollY = currentScrollY;
        }

        // Handle scroll with throttling
        function handleScroll() {
            if (scrollTimeout) clearTimeout(scrollTimeout);
            scrollTimeout = setTimeout(updateNavVisibility, 10);
        }

        // Handle resize
        function handleResize() {
            updateNavVisibility();
        }

        // Initial setup
        updateNavVisibility();

        // Event listeners
        window.addEventListener('scroll', handleScroll, { passive: true });
        window.addEventListener('resize', handleResize);
    }

    // Handle scroll-based navigation highlighting
    function setupScrollNavigation() {
        if (!isHomePage()) return;

        const sections = document.querySelectorAll('section[id]');
        const navLinks = document.querySelectorAll('.nav-link[data-is-anchor="true"]');
        const mobileNavLinks = document.querySelectorAll('.nav-link-mobile[data-is-anchor="true"]');

        if (sections.length === 0) return;

        // Function to update active link
        function updateActiveLink(activeId: string): void {
            // Update desktop links
            navLinks.forEach((link) => {
                const href = link.getAttribute('href') || '';
                const isActive = href.endsWith(`#${activeId}`);
                const underline = link.querySelector('span');

                if (isActive) {
                    link.classList.remove('text-foreground-secondary');
                    link.classList.add('text-primary');
                    underline?.classList.remove('w-0');
                    underline?.classList.add('w-full');
                } else {
                    link.classList.remove('text-primary');
                    link.classList.add('text-foreground-secondary');
                    underline?.classList.remove('w-full');
                    underline?.classList.add('w-0');
                }
            });

            // Update mobile links
            mobileNavLinks.forEach((link) => {
                const href = link.getAttribute('href') || '';
                const isActive = href.endsWith(`#${activeId}`);

                if (isActive) {
                    link.classList.remove('text-foreground-secondary');
                    link.classList.add('text-primary', 'bg-primary/10');
                } else {
                    link.classList.remove('text-primary', 'bg-primary/10');
                    link.classList.add('text-foreground-secondary');
                }
            });
        }

        // Intersection Observer for scroll detection
        const observerOptions = {
            root: null,
            rootMargin: '-20% 0px -80% 0px',
            threshold: 0
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach((entry) => {
                if (entry.isIntersecting) {
                    updateActiveLink(entry.target.id);
                }
            });
        }, observerOptions);

        sections.forEach((section) => {
            observer.observe(section);
        });

        // Handle scroll to top (clear active states)
        window.addEventListener('scroll', () => {
            if (window.pageYOffset < 100) {
                navLinks.forEach((link) => {
                    link.classList.remove('text-primary');
                    link.classList.add('text-foreground-secondary');
                    const underline = link.querySelector('span');
                    underline?.classList.remove('w-full');
                    underline?.classList.add('w-0');
                });
                mobileNavLinks.forEach((link) => {
                    link.classList.remove('text-primary', 'bg-primary/10');
                    link.classList.add('text-foreground-secondary');
                });
            }
        });
    }

    // Handle smooth scroll clicks
    function setupSmoothScroll() {
        const anchorLinks = document.querySelectorAll('a[href*="#"]');

        anchorLinks.forEach((link) => {
            link.addEventListener('click', (e) => {
                const href = link.getAttribute('href') || '';

                if (href.includes('#') && isHomePage()) {
                    const url = new URL(href, window.location.origin);
                    const currentPath = window.location.pathname;

                    if (href.startsWith('#') || url.pathname === currentPath) {
                        e.preventDefault();
                        const targetId = url.hash.substring(1);
                        const targetElement = document.getElementById(targetId);

                        if (targetElement) {
                            // Close menus if open
                            closeMobileMenu();
                            closeActionsMenu();

                            const header = document.querySelector('nav');
                            const headerHeight = header ? header.offsetHeight : 80;
                            const elementPosition = targetElement.getBoundingClientRect().top;
                            const offsetPosition = elementPosition + window.pageYOffset - headerHeight;

                            smoothScrollTo(offsetPosition);
                        }
                    }
                }
            });
        });
    }

    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
        setupMobileNavigation();
        setupScrollNavigation();
        setupSmoothScroll();
    });
</script>

<style>
    /* Mobile navigation hide/show styles */
    @media (max-width: 767px) {
        .mobile-nav-hidden {
            display: none !important;
        }

        /* Slide down animation - navbar appears */
        .mobile-nav-slide-down {
            animation: slideDown 0.3s ease-out forwards;
        }

        /* Slide up animation - navbar disappears */
        .mobile-nav-slide-up {
            animation: slideUp 0.3s ease-in forwards;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                transform: translateY(0);
                opacity: 1;
            }
            to {
                transform: translateY(-100%);
                opacity: 0;
            }
        }
    }
</style>
