---
import type { CollectionEntry } from 'astro:content';
import { getCollection } from 'astro:content';
import AnimatedGradientBackground from '@/components/ui/AnimatedGradientBackground.astro';
import SectionTitle from '@/components/ui/SectionTitle.astro';
import { sectionsColors } from '@/data/colors';
import { languages } from '@/i18n/ui';
import { getLangFromUrl, getTranslations } from '@/i18n/utils';
import BaseLayout from '@/layouts/BaseLayout.astro';

export async function getStaticPaths() {
    const allBlogPosts = await getCollection('blog');

    // Generate paths for each language and each blog post
    return Object.keys(languages).flatMap((lang) =>
        allBlogPosts
            .filter((post: CollectionEntry<'blog'>) => !post.data.draft)
            .map((post: CollectionEntry<'blog'>) => ({
                params: { lang, slug: post.slug },
                props: { post }
            }))
    );
}

interface Props {
    post: CollectionEntry<'blog'>;
}

const { post } = Astro.props;
const { Content } = await post.render();

const lang = getLangFromUrl(Astro.url);
const t = getTranslations(lang);

const title = `${post.data.title} - qazuor.com`;
const description = post.data.excerpt;

// Format date
const formattedDate = new Date(post.data.publishDate).toLocaleDateString(lang === 'es' ? 'es-ES' : 'en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
});

// Extract read time number
const readTimeNumber = post.data.readTime.match(/\d+/)?.[0] || '5';
---

<BaseLayout title={title} description={description}>
    <div class="relative section overflow-hidden pt-32 pb-20" style={`background-color: ${sectionsColors.blog}`}>
        <AnimatedGradientBackground />

        <article class="container-custom">
            <div class="max-w-4xl mx-auto">
        <!-- Back button -->
        <a
            href={`/${lang}/blog`}
            class="inline-flex items-center gap-2 text-foreground-secondary hover:text-primary transition-colors duration-300 mb-8"
        >
            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width={2} d="M15 19l-7-7 7-7"></path>
            </svg>
            {t('blog.title')}
        </a>

        <!-- Article Header -->
        <header class="mb-12">
            <SectionTitle title={post.data.title} subtitle={post.data.excerpt} size="lg" />

            <!-- Meta information -->
            <div class="flex flex-wrap items-center gap-4 text-foreground-secondary mb-6">
                <time datetime={post.data.publishDate.toISOString()} class="flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width={2}
                            d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
                        ></path>
                    </svg>
                    {formattedDate}
                </time>
                <span>‚Ä¢</span>
                <span class="flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width={2}
                            d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    {readTimeNumber}
                    {t('blog.readTime')}
                </span>
            </div>

            <!-- Tags -->
            <div class="flex flex-wrap gap-2">
                {
                    post.data.tags.map((tag: string) => (
                        <span class="px-3 py-1 text-sm font-medium bg-primary/10 text-primary rounded-full border border-primary/20">
                            #{tag}
                        </span>
                    ))
                }
            </div>
        </header>

        <!-- Article Content -->
        <div
            class="prose prose-base dark:prose-invert max-w-none
      prose-headings:text-foreground prose-headings:!font-medium
      prose-h1:!text-lg prose-h1:!mb-3 prose-h1:!mt-16 prose-h1:!leading-snug
      prose-h2:!text-base prose-h2:!mb-3 prose-h2:!mt-12 prose-h2:!leading-snug
      prose-h3:!text-sm prose-h3:!mb-2 prose-h3:!mt-10 prose-h3:!font-semibold prose-h3:!leading-snug
      prose-h4:!text-xs prose-h4:!mb-2 prose-h4:!mt-8 prose-h4:!font-semibold prose-h4:!uppercase prose-h4:!tracking-wider prose-h4:text-foreground-secondary
      prose-p:text-foreground-secondary prose-p:!leading-relaxed prose-p:!text-sm
      prose-a:text-primary prose-a:no-underline hover:prose-a:underline prose-a:transition-colors
      prose-strong:text-foreground prose-strong:font-semibold
      prose-code:text-primary prose-code:bg-primary/10 prose-code:px-1.5 prose-code:py-0.5 prose-code:rounded prose-code:!text-xs prose-code:font-normal
      prose-pre:bg-background-secondary prose-pre:border prose-pre:border-foreground/10 prose-pre:!text-xs prose-pre:!leading-relaxed
      prose-blockquote:border-l-primary prose-blockquote:text-foreground-secondary prose-blockquote:italic prose-blockquote:!text-sm
      prose-img:rounded-lg prose-img:shadow-md
      prose-hr:border-foreground/10
      prose-ul:pl-5 prose-ul:!text-sm
      prose-ol:pl-5 prose-ol:!text-sm
      prose-li:text-foreground-secondary prose-li:!leading-relaxed prose-li:!mb-2"
        >
            <Content />
        </div>

        <!-- Article Footer -->
        <footer class="mt-16 pt-8 border-t border-foreground/10">
            <!-- Share section (optional - can add later) -->
            <div class="flex items-center justify-between">
                <a
                    href={`/${lang}/blog`}
                    class="inline-flex items-center gap-2 px-6 py-3 bg-primary text-white rounded-lg hover:bg-primary-600 transition-colors duration-300 font-medium shadow-glow-primary"
                >
                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width={2} d="M15 19l-7-7 7-7"
                        ></path>
                    </svg>
                    {t('blog.title')}
                </a>

                <!-- Author info (optional) -->
                <div class="flex items-center gap-3">
                    <div
                        class="w-12 h-12 rounded-full bg-gradient-to-br from-primary to-secondary flex items-center justify-center"
                    >
                        <span class="text-2xl">üë®‚Äçüíª</span>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-foreground">qazuor</p>
                        <p class="text-xs text-foreground-secondary">{post.data.author || 'qazuor'}</p>
                    </div>
                </div>
            </div>
        </footer>
            </div>
        </article>
    </div>
</BaseLayout>

<style is:global>
    /* Custom styles for markdown content */

    /* Headings - Override prose defaults */
    .prose h1 {
        font-size: 1.5rem !important; /* text-2xl */
        font-weight: 700 !important; /* font-bold */
        margin-top: 4rem !important; /* mt-16 */
        margin-bottom: 1rem !important; /* mb-4 */
        line-height: 1.3 !important;
        color: hsl(var(--primary)) !important;
    }

    .prose h2 {
        font-size: 1.25rem !important; /* text-xl */
        font-weight: 700 !important; /* font-bold */
        margin-top: 3rem !important; /* mt-12 */
        margin-bottom: 0.875rem !important;
        line-height: 1.35 !important;
        color: hsl(var(--primary)) !important;
    }

    .prose h3 {
        font-size: 1.0625rem !important; /* ~text-lg but smaller */
        font-weight: 700 !important; /* font-bold */
        margin-top: 2.5rem !important; /* mt-10 */
        margin-bottom: 0.75rem !important; /* mb-3 */
        line-height: 1.4 !important;
        color: hsl(var(--foreground)) !important;
    }

    .prose h4 {
        font-size: 0.9375rem !important; /* between text-sm and text-base */
        font-weight: 700 !important; /* font-bold */
        margin-top: 2rem !important; /* mt-8 */
        margin-bottom: 0.625rem !important;
        text-transform: uppercase !important;
        letter-spacing: 0.025em !important;
        color: hsl(var(--foreground-secondary)) !important;
    }

    /* Paragraphs */
    .prose p {
        font-size: 0.875rem !important; /* text-sm */
        margin-bottom: 1.25rem !important; /* mb-5 */
        line-height: 1.75 !important; /* leading-relaxed */
    }

    /* Code blocks */
    .prose pre {
        @apply overflow-x-auto;
        font-size: 0.75rem !important; /* text-xs */
        line-height: 1.75 !important;
    }

    .prose code {
        font-size: 0.75rem !important; /* text-xs */
        @apply font-normal;
    }

    .prose pre code {
        @apply bg-transparent p-0;
        font-size: 0.75rem !important;
    }

    /* Lists */
    .prose ul,
    .prose ol {
        font-size: 0.875rem !important; /* text-sm */
        margin-bottom: 1.25rem !important; /* mb-5 */
        @apply space-y-1.5;
    }

    /* Force bullets to show */
    .prose ul {
        list-style-type: disc !important;
        padding-left: 1.25rem !important;
    }

    .prose ol {
        list-style-type: decimal !important;
        padding-left: 1.25rem !important;
    }

    .prose ul li,
    .prose ol li {
        display: list-item !important;
        margin-bottom: 0.5rem !important; /* mb-2 */
    }

    .prose li {
        line-height: 1.75 !important; /* leading-relaxed */
    }

    .prose li::marker {
        color: hsl(var(--primary));
    }

    /* Blockquotes */
    .prose blockquote {
        font-size: 0.875rem !important; /* text-sm */
        @apply my-6 pl-6 italic font-normal;
    }

    /* Ensure nested lists have proper indentation */
    .prose ul ul,
    .prose ol ol,
    .prose ul ol,
    .prose ol ul {
        @apply mt-2 mb-0;
    }
</style>
