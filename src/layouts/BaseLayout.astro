---
// Import critical fonts and styles
// Note: fonts.css now handles font loading with proper critical/non-critical split
import '../styles/fonts.css';

// Import auto-generated colors
import '../styles/generated-colors.css';

// Astro image optimization
import { getImage } from 'astro:assets';
import { ViewTransitions } from 'astro:transitions';
// Vercel Speed Insights (keeping for Core Web Vitals monitoring)
import SpeedInsights from '@vercel/speed-insights/astro';
import photo1 from '@/assets/images/photo1.png';
// Other imports
import AutoAnimateGlobal from '@/components/AutoAnimateGlobal.astro';
import { SmoothScroll } from '@/components/animations/SmoothScroll';
import BuildSearchIndex from '@/components/BuildSearchIndex.astro';
import { CommandPalette } from '@/components/interactive/CommandPalette';
import { ScrollToTop } from '@/components/interactive/ScrollToTop';
import LifecycleInit from '@/components/LifecycleInit.astro';
import Footer from '@/components/layout/Footer.astro';
import SEO from '@/components/layout/SEO.astro';
import { FloatingNav } from '@/components/navigation/FloatingNav';
import BreadcrumbJsonLd from '@/components/seo/BreadcrumbJsonLd.astro';
import JsonLd from '@/components/seo/JsonLd.astro';
import ViewTransitionGSAP from '@/components/transitions/ViewTransitionGSAP.astro';
// import PageTransition from '@/components/transitions/PageTransition.astro';
import { languages } from '@/i18n/ui';
import { getLangFromUrl, getRouteFromUrl, getTranslations } from '@/i18n/utils';
import type { WebSiteSchema } from '@/types/jsonld';
import { generateBreadcrumbs } from '@/utils/breadcrumbs';

// Note: PixelCanvas custom element is lazy-loaded from src/scripts/pixel-canvas.ts
// to ensure it works with View Transitions navigation

interface Props {
    title: string;
    description?: string;
    image?: string;
    imageAlt?: string;
    type?: 'website' | 'article' | 'profile';
    keywords?: string[];
    publishDate?: string;
    modifiedDate?: string;
    articleTags?: string[];
    noindex?: boolean;
    author?: string;
    jobTitle?: string;
    socialLinks?: {
        github?: string;
        linkedin?: string;
        fiverr?: string;
        upwork?: string;
    };
    /** Custom page name for breadcrumbs (optional) */
    breadcrumbName?: string;
    /** Disable breadcrumbs on this page */
    noBreadcrumbs?: boolean;
    /** Preload hero image (only enable on homepage where hero is visible) */
    preloadHeroImage?: boolean;
}

const lang = getLangFromUrl(Astro.url);
const t = getTranslations(lang);

// Optimize hero image for LCP (Largest Contentful Paint)
const optimizedPhoto = await getImage({
    src: photo1,
    format: 'webp'
});

const {
    title,
    description = t('home.description'),
    image,
    imageAlt,
    type = 'website',
    keywords = [],
    publishDate,
    modifiedDate,
    articleTags = [],
    noindex = false,
    author,
    jobTitle,
    socialLinks,
    breadcrumbName,
    noBreadcrumbs = false,
    preloadHeroImage = false
} = Astro.props;

// Get current route without locale
const route = getRouteFromUrl(Astro.url);

// Check if we're on the home page (for floating nav)
const isHomePage = route === '' || route === '/';

// Floating nav labels for i18n
const floatingNavLabels = {
    hero: t('nav.home'),
    about: t('nav.about'),
    skills: t('nav.skills'),
    projects: t('nav.projects'),
    services: t('nav.services'),
    blog: t('nav.blog'),
    testimonials: t('nav.testimonials'),
    faqs: t('nav.faqs'),
    contact: t('nav.contact')
};

// Utility labels for mobile FloatingNav popover
const floatingNavUtilityLabels = {
    goodies: t('nav.tools'),
    command: t('aria.openCommandPalette'),
    theme: t('aria.toggleTheme'),
    language: t('aria.changeLanguage'),
    scrollToTop: t('aria.scrollToTop')
};

// Site configuration
const siteUrl = 'https://qazuor.com';
const siteName = 'Qazuor';
const authorName = 'JuliÃ¡n Cataldo';

// Generate WebSite schema (for all pages)
const websiteSchema: WebSiteSchema = {
    '@context': 'https://schema.org',
    '@type': 'WebSite',
    name: siteName,
    url: siteUrl,
    description: t('home.description'),
    author: {
        '@type': 'Person',
        name: authorName
    },
    inLanguage: ['en', 'es'],
    potentialAction: {
        '@type': 'SearchAction',
        target: {
            '@type': 'EntryPoint',
            urlTemplate: `${siteUrl}/{lang}?search={search_term_string}`
        },
        'query-input': 'required name=search_term_string'
    }
};

// Generate breadcrumb items for this page
const breadcrumbItems = noBreadcrumbs ? [] : generateBreadcrumbs(Astro.url.pathname, siteUrl, breadcrumbName || title);

// Generate alternate language links
const locales = Object.keys(languages);
const alternateLinks = locales.map((locale) => {
    const path = `/${locale}${route}`;
    return { locale, path };
});
---

<!doctype html>
<html lang={lang} class="dark">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />

        <!-- Performance: Preload Critical Resources -->
        <!-- Only preload fonts actually used above-the-fold (hero section) -->
        <!-- Using crossorigin="anonymous" is required for font preloading -->

        <!-- Inter 400 - Body text (used throughout hero section) -->
        <link
            rel="preload"
            href="/fonts/inter-latin-400-normal.woff2"
            as="font"
            type="font/woff2"
            crossorigin="anonymous"
        />

        <!-- Inter 900 - Hero h1 (font-black) - Critical for LCP -->
        <link
            rel="preload"
            href="/fonts/inter-latin-900-normal.woff2"
            as="font"
            type="font/woff2"
            crossorigin="anonymous"
        />

        <!-- Note: Inter 500/600/700 and JetBrains Mono are loaded on-demand via CSS -->
        <!-- They are not preloaded because they're used below the fold or in code blocks -->

        <!-- Preload LCP image (hero image) - only on pages with hero section -->
        {preloadHeroImage && (
            <link
                rel="preload"
                href={optimizedPhoto.src}
                as="image"
                fetchpriority="high"
            />
        )}

        <!-- Prefetch common navigation routes for faster navigation -->
        <link rel="prefetch" href="/en/projects/" />
        <link rel="prefetch" href="/en/blog/" />
        <link rel="prefetch" href="/es/projects/" />
        <link rel="prefetch" href="/es/blog/" />

        <!-- Critical CSS (inlined for fastest LCP) -->
        <!-- Contains ONLY styles needed for above-the-fold hero section -->
        <!-- IMPORTANT: Must include BOTH light and dark themes to prevent flash during View Transitions -->
        <style is:inline>
            /* CSS Variables - Light Mode (base) */
            :root {
                --bg-primary: 219 21% 96%;
                --bg-secondary: 219 21% 94%;
                --text-primary: 215 25% 15%;
                --text-secondary: 215 20% 25%;
                --background: 219 21% 94%;
                --foreground: 215 25% 15%;
                --primary: 215 60% 40%;
                color-scheme: light;
            }

            /* CSS Variables - Dark Mode (override when .dark class present) */
            html.dark {
                --bg-primary: 256 45% 6%;
                --bg-secondary: 250 30% 10%;
                --text-primary: 240 15% 96%;
                --text-secondary: 240 10% 72%;
                --background: 256 45% 8%;
                --foreground: 240 15% 95%;
                --primary: 250 60% 65%;
                color-scheme: dark;
            }

            body {
                font-family: "Inter", system-ui, -apple-system, sans-serif;
                background: hsl(var(--background));
                color: hsl(var(--foreground));
                line-height: 1.5;
            }

            .container-custom {
                max-width: 80rem;
                margin-left: auto;
                margin-right: auto;
                padding-left: 1rem;
                padding-right: 1rem;
            }

            @media (min-width: 640px) {
                .container-custom {
                    padding-left: 1.5rem;
                    padding-right: 1.5rem;
                }
            }

            @media (min-width: 1024px) {
                .container-custom {
                    padding-left: 2rem;
                    padding-right: 2rem;
                }
            }

            /* Extra padding for floating nav on homepage (desktop only) */
            @media (min-width: 768px) {
                .has-floating-nav .container-custom {
                    padding-right: 6rem;
                }
            }

            .hero-section {
                position: relative;
                display: flex;
                justify-content: center;
                overflow: hidden;
                padding-top: 1rem;
            }

            @media (min-width: 1024px) {
                .hero-section {
                    align-items: center;
                    padding-top: 0;
                }
            }

            .gradient-text-hero {
                background: linear-gradient(to right, #2563eb, #7c3aed, #0ea5e9);
                background-size: 300% 100%;
                background-clip: text;
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                animation: gradient-shift 12s ease infinite;
            }

            html.dark .gradient-text-hero {
                background: linear-gradient(to right, #3b82f6, #8b5cf6, #06b6d4);
                background-size: 300% 100%;
                background-clip: text;
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
            }

            @keyframes gradient-shift {
                0% {
                    background-position: 0% 50%;
                }
                50% {
                    background-position: 100% 50%;
                }
                100% {
                    background-position: 0% 50%;
                }
            }

            .text-foreground {
                color: hsl(var(--foreground));
            }

            .text-foreground-secondary {
                color: hsl(var(--text-secondary));
            }

            .text-primary {
                color: hsl(var(--primary));
            }

            .font-black {
                font-weight: 900;
            }

            .font-semibold {
                font-weight: 600;
            }

            .font-bold {
                font-weight: 700;
            }

            .hero-element {
                opacity: 1;
            }

            .skip-link {
                position: absolute;
                top: -40px;
                left: 0;
                background: hsl(var(--background));
                color: hsl(var(--foreground));
                padding: 8px;
                text-decoration: none;
                z-index: 100;
            }

            .skip-link:focus {
                top: 0;
            }
        </style>

        <!-- SEO Component -->
        <SEO
            title={title}
            description={description}
            image={image}
            imageAlt={imageAlt}
            type={type}
            keywords={keywords}
            locale={lang}
            publishDate={publishDate}
            modifiedDate={modifiedDate}
            articleTags={articleTags}
            noindex={noindex}
            author={author}
            jobTitle={jobTitle}
            socialLinks={socialLinks}
        />

        <!-- Favicons are automatically injected by astro-favicons integration -->

        <!-- View Transitions (Astro official) -->
        <ViewTransitions />

        <!-- Alternate language links -->
        {
            alternateLinks.map(({ locale, path }) => (
                <link rel="alternate" hreflang={locale} href={`${Astro.site || ''}${path}`} />
            ))
        }

        <!-- JSON-LD Structured Data -->
        <JsonLd schema={websiteSchema} />
        {breadcrumbItems.length > 1 && <BreadcrumbJsonLd items={breadcrumbItems} />}

        <!-- Additional head content from pages -->
        <slot name="head" />

        <!-- Fix for View Transitions + GSAP ScrollTrigger conflict -->
        <!-- https://github.com/withastro/astro/issues/12725 -->
        <script is:inline>
            delete window.onscrollend;
        </script>


        <!-- Prevent flash of unstyled content (FOUC) for dark mode -->
        <!-- Also handles View Transitions theme persistence -->
        <script is:inline>
            (function() {
                function applyTheme() {
                    const theme = localStorage.getItem('theme');
                    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                    if (theme === 'dark' || (!theme && prefersDark)) {
                        document.documentElement.classList.add('dark');
                    } else {
                        document.documentElement.classList.remove('dark');
                    }
                }

                // Apply on initial load
                applyTheme();

                // Apply after View Transitions (uses custom event from ViewTransitionGSAP)
                document.addEventListener('qazuor:content-ready', applyTheme);

                // Also apply before swap to prevent flash during transition
                document.addEventListener('astro:before-swap', function(e) {
                    const theme = localStorage.getItem('theme');
                    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                    const isDark = theme === 'dark' || (!theme && prefersDark);
                    // Apply to the new document before it's swapped in
                    if (e.newDocument && e.newDocument.documentElement) {
                        if (isDark) {
                            e.newDocument.documentElement.classList.add('dark');
                        } else {
                            e.newDocument.documentElement.classList.remove('dark');
                        }
                    }
                });
            })();
        </script>
    </head>
    <body class="has-floating-nav">
        <!-- Skip to main content link for accessibility -->
        <a href="#main-content" class="skip-link">
            {t('aria.skipToContent')}
        </a>

        <!-- Lifecycle Manager (must be first to handle View Transitions) -->
        <LifecycleInit />

        <!-- AutoAnimate Global -->
        <AutoAnimateGlobal />

        <!-- Smooth Scroll Integration -->
        <SmoothScroll client:only="react" />

        <!-- Build Search Index -->
        <BuildSearchIndex />

        <!-- Command Palette (Ctrl+K) -->
        <CommandPalette
            client:only="react"
            lang={lang}
            ariaLabel={t('aria.closeCommandPalette')}
            placeholder={t('aria.commandPalettePlaceholder')}
        />

        <!-- Scroll to Top Button - client:only to avoid SSR hooks issue with animate-ui icons -->
        <ScrollToTop client:only="react" ariaLabel={t('aria.scrollToTop')} />

        <!-- Floating Navigation - visible on all pages -->
        <!-- Using client:only to avoid SSR hooks issue with animate-ui icons -->
        <FloatingNav
            client:only="react"
            labels={floatingNavLabels}
            currentLocale={lang}
            utilityLabels={floatingNavUtilityLabels}
        />

        <!-- View Transitions with Custom GSAP Animation -->
        <ViewTransitionGSAP />

        <main id="main-content" class="min-h-screen">
            <slot />
        </main>

        <!-- New Footer Component -->
        <Footer lang={lang} isHome={isHomePage} />

        <!-- Callout Enhancer for prose content (blog, projects, goodies) -->
        <!-- Transforms blockquotes with patterns like **Info:** into styled callouts -->
        <!-- Uses is:inline to ensure re-execution after View Transitions -->
        <script is:inline>
            (function() {
                // Guard to prevent duplicate event listener registration
                if (window.__calloutEnhancerInitialized) return;
                window.__calloutEnhancerInitialized = true;

                var calloutPatterns = {
                    info: /^<strong>Info:?<\/strong>:?\s*/i,
                    warning: /^<strong>Warning:?<\/strong>:?\s*/i,
                    tip: /^<strong>Tip:?<\/strong>:?\s*/i,
                    success: /^<strong>Success:?<\/strong>:?\s*/i,
                    error: /^<strong>Error:?<\/strong>:?\s*/i,
                    quote: /^<strong>Quote:?<\/strong>:?\s*/i
                };

                function enhanceCallouts() {
                    // Early bailout: skip if no prose content on page
                    if (!document.querySelector('.content-prose')) return;

                    var blockquotes = document.querySelectorAll('.content-prose blockquote:not([data-callout-enhanced])');
                    if (!blockquotes.length) return;

                    blockquotes.forEach(function(blockquote) {
                        var firstParagraph = blockquote.querySelector('p');
                        if (!firstParagraph) return;

                        var html = firstParagraph.innerHTML.trim();

                        for (var type in calloutPatterns) {
                            if (calloutPatterns[type].test(html)) {
                                blockquote.dataset.calloutEnhanced = 'true';
                                blockquote.classList.add('callout-' + type);
                                var cleanedHtml = html.replace(calloutPatterns[type], '').trim();
                                firstParagraph.innerHTML = cleanedHtml;
                                if (!cleanedHtml) firstParagraph.remove();
                                break;
                            }
                        }
                    });
                }

                // Run on initial page load
                enhanceCallouts();

                // Run after View Transitions navigation
                document.addEventListener('qazuor:content-ready', enhanceCallouts);
            })();
        </script>

        <!-- Umami Analytics (privacy-focused, self-hosted) -->
        <!-- Only loads in production, async+defer to not block render -->
        {import.meta.env.PROD && (
            <script
                async
                defer
                src="https://qazuor-com-umami.vercel.app/script.js"
                data-website-id="2076519d-ab81-4c53-890f-9eabc54a0bb8"
            ></script>
        )}

        <!-- Vercel Speed Insights (Core Web Vitals monitoring) -->
        <SpeedInsights debug={false} />

        <!-- PixelCanvas Custom Element - Lazy loaded only when needed -->
        <script>
            // Load PixelCanvas script only when pixel-canvas elements exist
            function loadPixelCanvas() {
                if (document.querySelector('pixel-canvas')) {
                    import('../scripts/pixel-canvas');
                }
            }

            // Check on initial load
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', loadPixelCanvas);
            } else {
                loadPixelCanvas();
            }

            // Re-check after View Transitions navigation
            document.addEventListener('qazuor:content-ready', loadPixelCanvas);
        </script>
    </body>
</html>

<style is:global>
    @import '../styles/global.css';
</style>
