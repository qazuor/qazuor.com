---
/**
 * MermaidRenderer Component
 *
 * Lazy loads and renders Mermaid diagrams in blog posts.
 * Only included in blog post pages to avoid loading the library on other pages.
 *
 * Features:
 * - Lazy loads Mermaid library only when diagrams are present
 * - Supports theme switching (light/dark mode)
 * - Re-renders diagrams on theme change
 */
---

<script type="module" is:inline>
    // Theme detection for Mermaid diagrams
    function getMermaidTheme() {
        return document.documentElement.classList.contains('dark') ? 'dark' : 'default';
    }

    function getMermaidThemeVariables() {
        // Read colors from CSS variables for theme consistency
        const style = getComputedStyle(document.documentElement);
        const primary = style.getPropertyValue('--mermaid-primary').trim();
        const secondary = style.getPropertyValue('--mermaid-secondary').trim();
        const background = style.getPropertyValue('--mermaid-background').trim();
        const border = style.getPropertyValue('--mermaid-border').trim();
        const text = style.getPropertyValue('--mermaid-text').trim();

        return {
            primaryColor: primary,
            primaryTextColor: text,
            primaryBorderColor: primary,
            lineColor: secondary,
            secondaryColor: background,
            tertiaryColor: border,
            background: background,
            mainBkg: background,
            secondaryBkg: border,
            textColor: text,
            fontSize: '16px',
            fontFamily: 'Inter, system-ui, sans-serif',
            edgeLabelBackground: background,
            labelBackground: background,
            labelColor: text
        };
    }

    // Mermaid initialization function
    async function initializeMermaid() {
        // Check for mermaid blocks FIRST (before loading library)
        const mermaidBlocks = document.querySelectorAll('pre[data-language="mermaid"]');

        // Exit early if no mermaid diagrams on page (saves ~548KB)
        if (mermaidBlocks.length === 0) return;

        try {
            // Only load mermaid when needed
            const mermaidModule = await import(
                'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs'
            );
            const mermaid = mermaidModule.default || mermaidModule;

            // Store mermaid reference for theme change re-render
            window.__mermaidInstance = mermaid;

            // Initialize Mermaid with current theme
            mermaid.initialize({
                startOnLoad: false,
                theme: getMermaidTheme(),
                themeVariables: getMermaidThemeVariables(),
                flowchart: {
                    curve: 'basis',
                    lineWidth: 3,
                    padding: 20,
                    diagramPadding: 8,
                    htmlLabels: true,
                    rankSpacing: 50,
                    nodeSpacing: 50
                },
                securityLevel: 'loose'
            });

            // First, preserve expressive-code assets from the first block
            const firstExpressiveContainer = document.querySelector('.expressive-code');
            let expressiveCodeAssets = null;

            if (firstExpressiveContainer) {
                const linkTag = firstExpressiveContainer.querySelector('link[rel="stylesheet"]');
                const scriptTag = firstExpressiveContainer.querySelector('script[type="module"]');

                if (linkTag || scriptTag) {
                    expressiveCodeAssets = {
                        link: linkTag?.cloneNode(true),
                        script: scriptTag?.cloneNode(true)
                    };
                }
            }

            mermaidBlocks.forEach((pre, index) => {
                const expressiveContainer = pre.closest('.expressive-code');
                const copyButton = expressiveContainer?.querySelector('.copy button[data-code]');
                let code = copyButton?.getAttribute('data-code') || '';

                if (!code) return;

                // Fix expressive-code formatting
                code = code.replace(/    /g, '\n').replace(/\u007f/g, '\n');
                code = code.replace(/graph\s+(LR|RL)/gi, 'graph TD');
                code = code.replace(/flowchart\s+(LR|RL)/gi, 'flowchart TD');

                // Create mermaid container
                const container = document.createElement('div');
                container.className = 'expressive-code mermaid-diagram';

                // If this is the first mermaid block, preserve the assets
                if (index === 0 && expressiveCodeAssets) {
                    if (expressiveCodeAssets.link) {
                        container.appendChild(expressiveCodeAssets.link);
                    }
                    if (expressiveCodeAssets.script) {
                        container.appendChild(expressiveCodeAssets.script);
                    }
                }

                const figure = document.createElement('figure');
                figure.className = 'frame';

                const mermaidDiv = document.createElement('div');
                mermaidDiv.className = 'mermaid';
                mermaidDiv.textContent = code;

                figure.appendChild(mermaidDiv);
                container.appendChild(figure);

                if (expressiveContainer) {
                    expressiveContainer.replaceWith(container);
                } else {
                    pre.replaceWith(container);
                }
            });

            // Render diagrams
            await mermaid.run();

            // Style edge labels using CSS variables
            const style = getComputedStyle(document.documentElement);
            const edgeFill = style.getPropertyValue('--mermaid-background').trim();
            const edgeStroke = style.getPropertyValue('--mermaid-primary').trim();

            document.querySelectorAll('.mermaid svg g.edgeLabel').forEach((label) => {
                const rect = label.querySelector('rect');
                if (rect) {
                    const currentWidth = parseFloat(rect.getAttribute('width') || '0');
                    const currentHeight = parseFloat(rect.getAttribute('height') || '0');
                    const currentX = parseFloat(rect.getAttribute('x') || '0');
                    const currentY = parseFloat(rect.getAttribute('y') || '0');

                    const padding = 8;
                    rect.setAttribute('width', String(currentWidth + padding * 2));
                    rect.setAttribute('height', String(currentHeight + padding * 2));
                    rect.setAttribute('x', String(currentX - padding));
                    rect.setAttribute('y', String(currentY - padding));
                    rect.setAttribute('rx', '4');
                    rect.setAttribute('ry', '4');
                    rect.setAttribute('fill', edgeFill);
                    rect.setAttribute('stroke', edgeStroke);
                    rect.setAttribute('stroke-width', '1');
                }
            });
        } catch (error) {
            console.error('Mermaid failed to load:', error);
        }
    }

    // Initialize on initial page load
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeMermaid);
    } else {
        initializeMermaid();
    }

    // Re-initialize after View Transitions navigation
    // Uses custom event dispatched by ViewTransitionGSAP after DOM swap
    document.addEventListener('qazuor:content-ready', initializeMermaid);

    // Re-render diagrams on theme change
    document.addEventListener('theme-changed', async () => {
        const mermaid = window.__mermaidInstance;
        if (!mermaid) return;

        const mermaidContainers = document.querySelectorAll('.mermaid-diagram');
        if (mermaidContainers.length === 0) return;

        // Re-initialize with new theme
        mermaid.initialize({
            startOnLoad: false,
            theme: getMermaidTheme(),
            themeVariables: getMermaidThemeVariables(),
            flowchart: {
                curve: 'basis',
                lineWidth: 3,
                padding: 20,
                diagramPadding: 8,
                htmlLabels: true,
                rankSpacing: 50,
                nodeSpacing: 50
            },
            securityLevel: 'loose'
        });

        // Re-run mermaid on existing diagrams
        try {
            await mermaid.run();
        } catch (err) {
            console.error('Mermaid re-render failed:', err);
        }
    });
</script>
