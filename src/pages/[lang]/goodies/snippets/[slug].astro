---
import type { CollectionEntry } from 'astro:content';
import { getCollection } from 'astro:content';
import { Comments } from '@/components/blog/Comments';
import { ShareButton } from '@/components/blog/ShareButton';
import AnimatedGradientBackground from '@/components/ui/AnimatedGradientBackground.astro';
import LanguageIcon from '@/components/ui/LanguageIcon.astro';
import { sectionsColors } from '@/data/colors';
import { type Locale, languages } from '@/i18n/ui';
import { getLangFromUrl, getTranslations, translatePath } from '@/i18n/utils';
import BaseLayout from '@/layouts/BaseLayout.astro';

export async function getStaticPaths() {
    const snippets = await getCollection('snippets');
    const paths: Array<{
        params: { lang: string; slug: string };
        props: { snippet: CollectionEntry<'snippets'> };
    }> = [];

    const langs = Object.keys(languages);

    langs.forEach((lang: string) => {
        snippets.forEach((snippet: CollectionEntry<'snippets'>) => {
            paths.push({
                params: {
                    lang,
                    slug: snippet.slug
                },
                props: { snippet }
            });
        });
    });

    return paths;
}

const { snippet } = Astro.props;
const lang = getLangFromUrl(Astro.url);
const t = getTranslations(lang);
const { Content } = await snippet.render();

const title = snippet.data.title;
const description = snippet.data.description;
const snippetsUrl = translatePath('/goodies/snippets', lang);
const canonicalUrl = Astro.url.href;
---

<BaseLayout title={title} description={description}>
    <div class="relative section overflow-hidden pt-32 pb-20" style={`background-color: ${sectionsColors.goodies}`}>
        <AnimatedGradientBackground />

        <article class="container-custom">
            <!-- Back Navigation -->
            <div class="mb-8">
                <a
                    href={snippetsUrl}
                    class="inline-flex items-center gap-2 text-foreground-secondary hover:text-primary transition-colors"
                >
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                    {t('goodies.categories.snippets')}
                </a>
            </div>

            <!-- Header -->
            <header class="mb-12">
                <div class="flex items-center gap-4 mb-4">
                    <LanguageIcon name={snippet.data.language} size={32} class="text-primary" />
                    <span class="px-4 py-2 text-sm font-medium rounded-full bg-primary/10 text-primary border border-primary/20">
                        {snippet.data.language}
                    </span>
                    {snippet.data.featured && (
                        <span class="px-3 py-1 text-xs font-medium rounded-full bg-primary text-primary-foreground">
                            â˜… Featured
                        </span>
                    )}
                </div>

                <h1 class="text-xl md:text-2xl font-bold mb-4 leading-tight">
                    <span class="gradient-text">{snippet.data.title}</span>
                </h1>
                <p class="text-sm md:text-base text-foreground-secondary leading-relaxed">
                    {snippet.data.description}
                </p>

                <!-- Tags -->
                <div class="flex flex-wrap gap-2 mt-4">
                    {
                        snippet.data.tags.map((tag: string) => (
                            <span class="inline-flex items-center px-3 py-1 text-sm rounded-md bg-foreground/5 text-foreground-secondary">
                                #{tag}
                            </span>
                        ))
                    }
                </div>

                <!-- Share buttons -->
                <div class="mt-6">
                    <ShareButton
                        title={title}
                        description={description}
                        url={canonicalUrl}
                        lang={lang as Locale}
                        variant="compact"
                        client:load
                    />
                </div>
            </header>

            <!-- Code Block -->
            <div class="mb-12">
                <div class="relative">
                    <div class="absolute top-3 right-3 z-10">
                        <button
                            id="copyCode"
                            class="px-4 py-2 text-xs font-medium rounded-lg bg-foreground/10 text-foreground-secondary hover:bg-foreground/20 transition-colors"
                        >
                            Copy Code
                        </button>
                    </div>
                    <pre class="rounded-lg bg-card border border-foreground/10 p-6 overflow-x-auto"><code id="codeBlock" class={`language-${snippet.data.language}`}>{snippet.data.code}</code></pre>
                </div>
            </div>

            <!-- Documentation -->
            <div class="content-prose">
                <Content />
            </div>

            <!-- Share section -->
            <div class="mt-16 pt-8 border-t border-foreground/10">
                <h3 class="text-lg font-semibold mb-6 text-center">{t('social.share.titleSnippet')}</h3>
                <ShareButton
                    title={title}
                    description={description}
                    url={canonicalUrl}
                    lang={lang as Locale}
                    variant="full"
                    client:load
                />
            </div>

            <!-- Comments section -->
            <div class="mt-16 pt-8 border-t border-foreground/10">
                <h3 class="text-lg font-semibold mb-6">{t('social.comments.title')}</h3>
                <Comments lang={lang as Locale} client:idle />
            </div>
        </article>
    </div>
</BaseLayout>

<script is:inline>
    // Guard to prevent multiple event listener registrations
    if (!window.__copyCodeInitialized) {
        window.__copyCodeInitialized = true;

        // Event delegation for copy code button
        // This persists across View Transitions without needing to re-register
        document.addEventListener('click', async (e) => {
            const target = e.target;
            const copyButton = target.closest('#copyCode');

            if (!copyButton) return;

            const codeBlock = document.getElementById('codeBlock');
            if (!codeBlock) return;

            const code = codeBlock.textContent || '';
            await navigator.clipboard.writeText(code);
            copyButton.textContent = 'Copied!';
            setTimeout(() => {
                copyButton.textContent = 'Copy Code';
            }, 2000);
        });
    }
</script>
