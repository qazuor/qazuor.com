---
import AnimatedGradientBackground from '@/components/ui/AnimatedGradientBackground.astro';
import SectionTitle from '@/components/ui/SectionTitle.astro';
import ChatBubbleIcon from '@/icons/ui/chat-bubble.svg?raw';

interface Props {
    testimonials: Array<{
        name: string;
        role: string;
        company: string;
        content: string;
        avatar?: string;
        avatarUrl?: string; // External URL - fallback when avatar not downloaded yet
        linkedinUrl?: string;
        source: 'linkedin' | 'email' | 'other';
    }>;
    primaryColor?: string;
    translations: {
        title: string;
        subtitle: string;
        description?: string;
        noTestimonials: string;
        readMore: string;
        readLess: string;
        viewProfile: string;
        viewMore?: string;
    };
}

const { testimonials: allTestimonials, primaryColor = '#9333ea', translations } = Astro.props;

// All testimonials visible in carousel
const testimonials = allTestimonials.map((t, i) => ({
    ...t,
    index: i
}));
---

<section
    class="relative section section-purple overflow-hidden"
    id="testimonials"
    style={`background-color: ${primaryColor}`}
>
    <!-- Animated Gradient Background -->
    <AnimatedGradientBackground />

    <div class="container-custom">
        <!-- Section Header -->
        <SectionTitle
            title={translations.title}
            subtitle={translations.subtitle}
            description={translations.description}
            size="lg"
            titleClassName="mb-6"
            className="max-w-3xl mx-auto"
            descriptionClassName="!text-base !max-w-3xl mx-auto mt-6 leading-relaxed"
        />

        {
            testimonials.length === 0 ? (
                /* Empty State */
                <div class="text-center py-16">
                    <div class="w-24 h-24 mx-auto mb-6 rounded-full bg-muted flex items-center justify-center">
                        <div class="w-10 h-10 text-muted-foreground" set:html={ChatBubbleIcon} />
                    </div>
                    <p class="text-foreground-secondary text-lg" set:html={translations.noTestimonials} />
                </div>
            ) : (
                <>
                {/* Testimonials Carousel */}
                <div class="testimonials-carousel-container relative">
                    {/* Navigation Buttons */}
                    <button
                        type="button"
                        class="carousel-nav carousel-nav-prev"
                        aria-label="Previous testimonial"
                        data-carousel-prev
                    >
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                        </svg>
                    </button>
                    <button
                        type="button"
                        class="carousel-nav carousel-nav-next"
                        aria-label="Next testimonial"
                        data-carousel-next
                    >
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                    </button>

                    {/* Carousel Track */}
                    <div
                        id="testimonials-carousel"
                        class="testimonials-carousel"
                        role="region"
                        aria-label="Testimonials carousel"
                        data-total-count={testimonials.length}
                    >
                        {testimonials.map((testimonial) => (
                            <article
                                class="group testimonial-slide"
                                data-testimonial-index={testimonial.index}
                            >
                            {/* Card with 3D tilt effect - Clickable to open modal */}
                            <button
                                type="button"
                                class="h-full w-full text-left testimonial-card-3d cursor-pointer"
                                data-tilt
                                data-testimonial-trigger={testimonial.index}
                                aria-label={`${translations.readMore}: ${testimonial.name}`}
                            >
                                {/* Glow effect layer */}
                                <div class="testimonial-glow"></div>

                                {/* Gradient border */}
                                <div class="testimonial-border"></div>

                                {/* Card content */}
                                <div class="testimonial-content">
                                    {/* Decorative quote mark */}
                                    <div class="quote-decoration" aria-hidden="true">"</div>

                                    {/* Header with source */}
                                    <div class="flex items-center justify-between mb-4">
                                        {testimonial.source === 'linkedin' && (
                                            <div class="flex items-center gap-1.5 px-2.5 py-1 rounded-full bg-[#0077B5]/20 border border-[#0077B5]/30">
                                                <svg class="w-3.5 h-3.5 text-[#0077B5]" viewBox="0 0 24 24" fill="currentColor">
                                                    <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                                                </svg>
                                                <span class="text-xs font-medium text-[#0077B5]">LinkedIn</span>
                                            </div>
                                        )}
                                    </div>

                                    {/* Content - Truncated */}
                                    <blockquote class="testimonial-quote line-clamp-4">
                                        {testimonial.content}
                                    </blockquote>

                                    {/* Read more indicator */}
                                    <div class="flex items-center justify-end gap-1 text-white/80 text-sm font-semibold mt-2 group-hover:text-white transition-colors">
                                        <span>{translations.readMore}</span>
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                                        </svg>
                                    </div>

                                    {/* Author Info */}
                                    <footer class="flex items-center gap-4 mt-auto pt-4 border-t border-white/10">
                                        {/* Avatar with glow ring */}
                                        <div class="flex-shrink-0 avatar-wrapper">
                                            {(testimonial.avatar || testimonial.avatarUrl) ? (
                                                <img
                                                    src={testimonial.avatar || testimonial.avatarUrl}
                                                    alt={`${testimonial.name}, ${testimonial.role} at ${testimonial.company}`}
                                                    width={48}
                                                    height={48}
                                                    class="w-12 h-12 rounded-full object-cover"
                                                    loading="lazy"
                                                    decoding="async"
                                                />
                                            ) : (
                                                <div class="w-12 h-12 rounded-full bg-gradient-to-br from-primary via-accent to-secondary flex items-center justify-center text-white font-bold text-lg shadow-lg">
                                                    {testimonial.name.charAt(0)}
                                                </div>
                                            )}
                                        </div>

                                        {/* Name and Role */}
                                        <div class="flex-grow min-w-0">
                                            <div class="flex items-center gap-2 mb-0.5">
                                                <span class="font-semibold text-white">
                                                    {testimonial.name}
                                                </span>
                                            </div>
                                            <p class="text-[0.65rem] text-white/70">{testimonial.role}</p>
                                            <p class="text-[0.65rem] text-white/50 font-medium">{testimonial.company}</p>
                                        </div>
                                    </footer>
                                </div>
                            </button>
                        </article>
                        ))}
                    </div>
                </div>

                {/* Carousel Controls: Play/Pause + Indicators */}
                <div class="carousel-controls">
                    {/* Play/Pause Button */}
                    <button
                        type="button"
                        class="carousel-autoplay-btn playing"
                        aria-label="Pause autoplay"
                        data-carousel-autoplay
                    >
                        {/* Pause icon (shown when playing) */}
                        <svg class="autoplay-pause-icon" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <rect x="6" y="4" width="4" height="16" rx="1" />
                            <rect x="14" y="4" width="4" height="16" rx="1" />
                        </svg>
                        {/* Play icon (shown when paused) */}
                        <svg class="autoplay-play-icon" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M8 5.14v14l11-7-11-7z" />
                        </svg>
                    </button>

                    {/* Indicators (Dots) */}
                    <div class="carousel-indicators" role="tablist" aria-label="Testimonial slides">
                        {testimonials.map((_, i) => (
                            <button
                                type="button"
                                class={`carousel-dot ${i === 0 ? 'active' : ''}`}
                                role="tab"
                                aria-selected={i === 0 ? 'true' : 'false'}
                                aria-label={`Go to testimonial ${i + 1}`}
                                data-carousel-dot={i}
                            />
                        ))}
                    </div>
                </div>
                </>
            )
        }
    </div>

    {/* Testimonial Modal */}
    <div
        id="testimonial-modal"
        class="testimonial-modal"
        role="dialog"
        aria-modal="true"
        aria-labelledby="modal-title"
        aria-hidden="true"
    >
        <div class="modal-backdrop"></div>
        <div class="modal-container">
            <div class="modal-content">
                {/* Close button */}
                <button
                    type="button"
                    class="modal-close"
                    aria-label="Close modal"
                >
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>

                {/* Modal header */}
                <div class="modal-header">
                    <div class="modal-avatar" id="modal-avatar"></div>
                    <div class="modal-author">
                        <h3 id="modal-title" class="modal-name"></h3>
                        <p id="modal-role" class="modal-role"></p>
                        <p id="modal-company" class="modal-company"></p>
                    </div>
                    {/* LinkedIn profile link */}
                    <a
                        id="modal-linkedin"
                        href="#"
                        target="_blank"
                        rel="noopener noreferrer"
                        class="modal-linkedin hidden"
                        aria-label={translations.viewProfile}
                    >
                        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                        </svg>
                    </a>
                </div>

                {/* Modal body */}
                <div class="modal-body">
                    <div class="modal-quote-mark" aria-hidden="true">"</div>
                    <blockquote id="modal-content" class="modal-quote"></blockquote>
                </div>

                {/* Source badge */}
                <div id="modal-source" class="modal-source hidden">
                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                    </svg>
                    <span>LinkedIn</span>
                </div>
            </div>
        </div>
    </div>

    {/* Pass testimonial data to JavaScript */}
    <script is:inline define:vars={{ testimonials: testimonials.map(t => ({
        name: t.name,
        role: t.role,
        company: t.company,
        content: t.content,
        avatar: t.avatar || t.avatarUrl || null,
        linkedinUrl: t.linkedinUrl || null,
        source: t.source
    })) }}>
        window.__testimonials = testimonials;
    </script>
</section>

<style>
    /* === CAROUSEL CONTAINER === */

    .testimonials-carousel-container {
        position: relative;
        width: 100%;
        padding: 0 3rem;
    }

    @media (max-width: 768px) {
        .testimonials-carousel-container {
            padding: 0 0.5rem;
        }
    }

    /* === CAROUSEL TRACK === */

    .testimonials-carousel {
        display: flex;
        gap: 1.5rem;
        overflow-x: auto;
        scroll-snap-type: x mandatory;
        /* scroll-behavior controlled by JS for seamless infinite loop */
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none; /* Firefox */
        -ms-overflow-style: none; /* IE/Edge */
        padding: 1rem 0.5rem 2rem;
    }

    /* Disable ALL transitions during seamless jump */
    .testimonials-carousel.jumping,
    .testimonials-carousel.jumping * {
        transition: none !important;
        animation: none !important;
    }

    .testimonials-carousel::-webkit-scrollbar {
        display: none; /* Chrome/Safari */
    }

    /* === CAROUSEL SLIDE === */

    .testimonial-slide {
        flex: 0 0 calc(100% - 1rem);
        scroll-snap-align: center;
        perspective: 1000px;
        opacity: 0.4;
        transform: scale(0.92);
        transition: opacity 0.4s ease, transform 0.4s ease;
    }

    .testimonial-slide.active {
        opacity: 1;
        transform: scale(1);
    }

    @media (min-width: 640px) {
        .testimonial-slide {
            flex: 0 0 calc(50% - 1rem);
        }
    }

    @media (min-width: 1024px) {
        .testimonial-slide {
            flex: 0 0 calc(33.333% - 1rem);
        }
    }

    /* === NAVIGATION BUTTONS === */

    .carousel-nav {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        z-index: 10;
        width: 3rem;
        height: 3rem;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        color: white;
        cursor: pointer;
        transition: all 0.3s ease;
        opacity: 0.7;
    }

    .carousel-nav:hover {
        opacity: 1;
        background: rgba(255, 255, 255, 0.2);
        transform: translateY(-50%) scale(1.1);
    }

    .carousel-nav:disabled {
        opacity: 0.3;
        cursor: not-allowed;
    }

    .carousel-nav:disabled:hover {
        transform: translateY(-50%) scale(1);
        background: rgba(255, 255, 255, 0.1);
    }

    .carousel-nav-prev {
        left: 0;
    }

    .carousel-nav-next {
        right: 0;
    }

    @media (max-width: 768px) {
        .carousel-nav {
            display: none;
        }
    }

    /* === CAROUSEL CONTROLS === */

    .carousel-controls {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 1rem;
        margin-top: 1.5rem;
    }

    /* === AUTOPLAY BUTTON === */

    .carousel-autoplay-btn {
        width: 2.5rem;
        height: 2.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        color: white;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .carousel-autoplay-btn:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: scale(1.1);
    }

    /* Show/hide icons based on state */
    .carousel-autoplay-btn.playing .autoplay-pause-icon {
        display: block;
    }

    .carousel-autoplay-btn.playing .autoplay-play-icon {
        display: none;
    }

    .carousel-autoplay-btn:not(.playing) .autoplay-pause-icon {
        display: none;
    }

    .carousel-autoplay-btn:not(.playing) .autoplay-play-icon {
        display: block;
    }

    /* Light mode autoplay button */
    :global(html:not(.dark)) .carousel-autoplay-btn {
        background: rgba(6, 182, 212, 0.15);
        border-color: rgba(6, 182, 212, 0.3);
        color: rgba(15, 23, 42, 0.8);
    }

    :global(html:not(.dark)) .carousel-autoplay-btn:hover {
        background: rgba(6, 182, 212, 0.25);
    }

    /* === CAROUSEL INDICATORS (DOTS) === */

    .carousel-indicators {
        display: flex;
        justify-content: center;
        gap: 0.5rem;
    }

    .carousel-dot {
        width: 0.5rem;
        height: 0.5rem;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.3);
        border: none;
        padding: 0;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .carousel-dot:hover {
        background: rgba(255, 255, 255, 0.5);
    }

    .carousel-dot.active {
        background: rgba(255, 255, 255, 0.9);
        transform: scale(1.3);
    }

    /* Light mode nav buttons */
    :global(html:not(.dark)) .carousel-nav {
        background: rgba(6, 182, 212, 0.15);
        border-color: rgba(6, 182, 212, 0.3);
        color: rgba(15, 23, 42, 0.8);
    }

    :global(html:not(.dark)) .carousel-nav:hover {
        background: rgba(6, 182, 212, 0.25);
    }

    /* Light mode indicators */
    :global(html:not(.dark)) .carousel-dot {
        background: rgba(6, 182, 212, 0.3);
    }

    :global(html:not(.dark)) .carousel-dot:hover {
        background: rgba(6, 182, 212, 0.5);
    }

    :global(html:not(.dark)) .carousel-dot.active {
        background: rgba(6, 182, 212, 0.9);
    }

    /* === TESTIMONIAL CARD 3D + GLASSMORPHISM === */

    .testimonial-card-3d {
        position: relative;
        height: 100%;
        border-radius: 1.5rem;
        transform-style: preserve-3d;
        transition: transform 0.3s ease-out;
    }

    /* Glow effect that follows cursor - subtle */
    .testimonial-glow {
        position: absolute;
        inset: -4px;
        border-radius: 1.5rem;
        background: radial-gradient(
            600px circle at var(--mouse-x, 50%) var(--mouse-y, 50%),
            rgba(147, 51, 234, 0.15),
            rgba(59, 130, 246, 0.08) 30%,
            transparent 50%
        );
        opacity: 0;
        transition: opacity 0.4s ease;
        pointer-events: none;
        z-index: 1;
        filter: blur(3px);
    }

    .testimonial-card-3d:hover .testimonial-glow {
        opacity: 1;
    }

    /* Animated gradient border - subtle */
    .testimonial-border {
        position: absolute;
        inset: 0;
        border-radius: 1.5rem;
        padding: 1px;
        background: linear-gradient(
            135deg,
            rgba(147, 51, 234, 0.5),
            rgba(59, 130, 246, 0.5),
            rgba(6, 182, 212, 0.4),
            rgba(147, 51, 234, 0.5)
        );
        background-size: 300% 300%;
        animation: borderGlow 8s ease infinite;
        -webkit-mask:
            linear-gradient(#fff 0 0) content-box,
            linear-gradient(#fff 0 0);
        mask:
            linear-gradient(#fff 0 0) content-box,
            linear-gradient(#fff 0 0);
        -webkit-mask-composite: xor;
        mask-composite: exclude;
        opacity: 0.3;
        transition: opacity 0.3s ease;
        z-index: 2;
    }

    .testimonial-card-3d:hover .testimonial-border {
        opacity: 0.7;
        animation: borderGlow 4s ease infinite;
    }

    @keyframes borderGlow {
        0%, 100% {
            background-position: 0% 50%;
        }
        50% {
            background-position: 100% 50%;
        }
    }

    /* Card content with glassmorphism */
    .testimonial-content {
        position: relative;
        height: 100%;
        padding: 2rem;
        border-radius: 1.5rem;
        background: linear-gradient(
            135deg,
            rgba(255, 255, 255, 0.08) 0%,
            rgba(255, 255, 255, 0.02) 100%
        );
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        z-index: 3;
    }

    /* Decorative quote mark - LARGER & MORE VISIBLE */
    .quote-decoration {
        position: absolute;
        top: -1.5rem;
        right: 0.5rem;
        font-family: Georgia, 'Times New Roman', serif;
        font-size: 14rem;
        font-weight: bold;
        line-height: 1;
        background: linear-gradient(135deg, rgba(147, 51, 234, 0.15), rgba(59, 130, 246, 0.1));
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
        pointer-events: none;
        user-select: none;
        z-index: 0;
        transition: all 0.4s ease;
        transform: rotate(5deg);
    }

    .testimonial-card-3d:hover .quote-decoration {
        background: linear-gradient(135deg, rgba(147, 51, 234, 0.2), rgba(59, 130, 246, 0.15));
        -webkit-background-clip: text;
        background-clip: text;
        transform: rotate(0deg) scale(1.02);
    }

    /* Shimmer/Shine effect on hover */
    .testimonial-content::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
            90deg,
            transparent,
            rgba(255, 255, 255, 0.1),
            transparent
        );
        transition: none;
        z-index: 10;
        pointer-events: none;
    }

    .testimonial-card-3d:hover .testimonial-content::before {
        animation: shimmer 1s ease forwards;
    }

    @keyframes shimmer {
        0% {
            left: -100%;
        }
        100% {
            left: 100%;
        }
    }

    /* Quote text */
    .testimonial-quote {
        position: relative;
        font-size: 0.875rem;
        line-height: 1.7;
        color: rgba(255, 255, 255, 0.9);
        flex-grow: 1;
        z-index: 1;
    }

    /* === LIGHT MODE OVERRIDES === */
    /* Same effects as dark mode but with cyan/sky blue colors */

    /* Glow effect - same as dark but with cyan */
    :global(html:not(.dark)) .testimonial-glow {
        background: radial-gradient(
            600px circle at var(--mouse-x, 50%) var(--mouse-y, 50%),
            rgba(6, 182, 212, 0.2),
            rgba(56, 189, 248, 0.12) 30%,
            transparent 50%
        );
        filter: blur(3px);
    }

    /* Animated gradient border - cyan version */
    :global(html:not(.dark)) .testimonial-border {
        background: linear-gradient(
            135deg,
            rgba(6, 182, 212, 0.6),
            rgba(56, 189, 248, 0.6),
            rgba(14, 165, 233, 0.5),
            rgba(6, 182, 212, 0.6)
        );
        background-size: 300% 300%;
    }

    /* Card content - glassmorphism adapted for light bg */
    :global(html:not(.dark)) .testimonial-content {
        background: linear-gradient(
            135deg,
            rgba(255, 255, 255, 0.7) 0%,
            rgba(240, 249, 255, 0.6) 100%
        );
        border: 1px solid rgba(6, 182, 212, 0.2);
        box-shadow: 0 4px 24px rgba(6, 182, 212, 0.1);
    }

    /* Quote decoration - cyan gradient */
    :global(html:not(.dark)) .quote-decoration {
        background: linear-gradient(135deg, rgba(6, 182, 212, 0.2), rgba(56, 189, 248, 0.15));
        -webkit-background-clip: text;
        background-clip: text;
    }

    :global(html:not(.dark)) .testimonial-card-3d:hover .quote-decoration {
        background: linear-gradient(135deg, rgba(6, 182, 212, 0.3), rgba(56, 189, 248, 0.22));
        -webkit-background-clip: text;
        background-clip: text;
    }

    /* Text colors for light mode */
    :global(html:not(.dark)) .testimonial-quote {
        color: rgba(15, 23, 42, 0.9);
    }

    :global(html:not(.dark)) .testimonial-card-3d footer {
        border-top-color: rgba(6, 182, 212, 0.2);
    }

    :global(html:not(.dark)) .testimonial-card-3d .text-white {
        color: rgba(15, 23, 42, 0.95);
    }

    :global(html:not(.dark)) .testimonial-card-3d .text-white\/70 {
        color: rgba(15, 23, 42, 0.7);
    }

    :global(html:not(.dark)) .testimonial-card-3d .text-white\/50 {
        color: rgba(15, 23, 42, 0.55);
    }

    /* Shimmer effect - slightly more visible for light mode */
    :global(html:not(.dark)) .testimonial-content::before {
        background: linear-gradient(
            90deg,
            transparent,
            rgba(6, 182, 212, 0.15),
            transparent
        );
    }

    /* === MODAL LIGHT MODE === */
    :global(html:not(.dark)) .modal-content {
        background: linear-gradient(
            135deg,
            rgba(255, 255, 255, 0.98) 0%,
            rgba(240, 249, 255, 0.98) 100%
        );
        border: 1px solid rgba(6, 182, 212, 0.3);
        box-shadow:
            0 25px 50px -12px rgba(0, 0, 0, 0.15),
            0 0 100px rgba(6, 182, 212, 0.15);
    }

    :global(html:not(.dark)) .modal-close {
        background: rgba(6, 182, 212, 0.1);
        border: 1px solid rgba(6, 182, 212, 0.2);
        color: rgba(15, 23, 42, 0.8);
    }

    :global(html:not(.dark)) .modal-close:hover {
        background: rgba(6, 182, 212, 0.2);
    }

    :global(html:not(.dark)) .modal-avatar {
        background: linear-gradient(135deg, #06b6d4, #38bdf8);
    }

    :global(html:not(.dark)) .modal-name {
        color: rgba(15, 23, 42, 0.95);
    }

    :global(html:not(.dark)) .modal-role {
        color: rgba(15, 23, 42, 0.7);
    }

    :global(html:not(.dark)) .modal-company {
        color: rgba(15, 23, 42, 0.55);
    }

    :global(html:not(.dark)) .modal-quote-mark {
        background: linear-gradient(135deg, rgba(6, 182, 212, 0.25), rgba(56, 189, 248, 0.15));
        -webkit-background-clip: text;
        background-clip: text;
    }

    :global(html:not(.dark)) .modal-quote {
        color: rgba(15, 23, 42, 0.9);
    }

    :global(html:not(.dark)) .modal-source {
        background: rgba(6, 182, 212, 0.1);
        border: 1px solid rgba(6, 182, 212, 0.2);
        color: #0891b2;
    }

    /* Avatar wrapper */
    .avatar-wrapper {
        position: relative;
    }

    /* Entry animations removed - they interfere with infinite loop clones */

    /* Focus styles for accessibility */
    a:focus-visible,
    button:focus-visible {
        outline: 2px solid rgb(59 130 246);
        outline-offset: 2px;
        border-radius: 0.25rem;
    }

    /* === TESTIMONIAL MODAL === */
    .testimonial-modal {
        position: fixed;
        inset: 0;
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1rem;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
    }

    .testimonial-modal[aria-hidden="false"] {
        opacity: 1;
        visibility: visible;
    }

    .modal-backdrop {
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
    }

    .modal-container {
        position: relative;
        width: 100%;
        max-width: 600px;
        max-height: 90vh;
        overflow-y: auto;
        transform: scale(0.9) translateY(20px);
        transition: transform 0.3s ease;
    }

    .testimonial-modal[aria-hidden="false"] .modal-container {
        transform: scale(1) translateY(0);
    }

    .modal-content {
        position: relative;
        background: linear-gradient(
            135deg,
            rgba(30, 20, 50, 0.95) 0%,
            rgba(20, 10, 40, 0.98) 100%
        );
        border: 1px solid rgba(147, 51, 234, 0.3);
        border-radius: 1.5rem;
        padding: 2rem;
        box-shadow:
            0 25px 50px -12px rgba(0, 0, 0, 0.5),
            0 0 100px rgba(147, 51, 234, 0.2);
    }

    .modal-close {
        position: absolute;
        top: 1rem;
        right: 1rem;
        width: 2.5rem;
        height: 2.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        color: white;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .modal-close:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: rotate(90deg);
    }

    .modal-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1.5rem;
        padding-right: 3rem;
    }

    .modal-avatar {
        flex-shrink: 0;
        width: 4rem;
        height: 4rem;
        border-radius: 50%;
        background: linear-gradient(135deg, #9333ea, #3b82f6);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 1.5rem;
        overflow: hidden;
    }

    .modal-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .modal-author {
        flex-grow: 1;
        min-width: 0;
    }

    .modal-name {
        font-size: 1.25rem;
        font-weight: 700;
        color: white;
        margin: 0 0 0.25rem 0;
    }

    .modal-role {
        font-size: 0.875rem;
        color: rgba(255, 255, 255, 0.7);
        margin: 0;
    }

    .modal-company {
        font-size: 0.875rem;
        color: rgba(255, 255, 255, 0.5);
        font-weight: 500;
        margin: 0;
    }

    .modal-linkedin {
        flex-shrink: 0;
        width: 2.5rem;
        height: 2.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #0077B5;
        border-radius: 0.5rem;
        color: white;
        transition: all 0.2s ease;
    }

    .modal-linkedin:hover {
        background: #005885;
        transform: translateY(-2px);
    }

    .modal-body {
        position: relative;
        padding: 1rem 0 0 0;
    }

    .modal-quote-mark {
        position: absolute;
        top: -1rem;
        left: 1rem;
        font-family: Georgia, 'Times New Roman', serif;
        font-size: 6rem;
        font-weight: bold;
        line-height: 1;
        background: linear-gradient(135deg, rgba(147, 51, 234, 0.3), rgba(59, 130, 246, 0.2));
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
        pointer-events: none;
    }

    .modal-quote {
        position: relative;
        font-size: 0.9375rem;
        line-height: 1.75;
        color: rgba(255, 255, 255, 0.9);
        margin: 0;
        z-index: 1;
    }

    .modal-source {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-top: 1.5rem;
        padding: 0.5rem 1rem;
        background: rgba(0, 119, 181, 0.2);
        border: 1px solid rgba(0, 119, 181, 0.3);
        border-radius: 2rem;
        width: fit-content;
        color: #0077B5;
        font-size: 0.875rem;
        font-weight: 500;
    }

    /* Line clamp for truncated text */
    .line-clamp-4 {
        display: -webkit-box;
        -webkit-line-clamp: 4;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    /* Prevent body scroll when modal is open */
    :global(body.modal-open) {
        position: fixed;
        width: 100%;
        left: 0;
        right: 0;
        overflow-y: scroll;
    }
</style>

<script>
    // ============================================
    // Guard flag to prevent duplicate event listeners
    // ============================================
    declare global {
        interface Window {
            __testimonialsInitialized?: boolean;
        }
    }

    // Check if already initialized (prevents duplicate listeners on View Transitions)
    if (window.__testimonialsInitialized) {
        // Already initialized - the qazuor:content-ready listener will handle state reset
        // No need to re-add event listeners
    } else {
        window.__testimonialsInitialized = true;

        // ============================================
        // All event handlers use EVENT DELEGATION
        // This ensures compatibility with View Transitions
        // ============================================

        // Store scroll position globally for modal
        let savedScrollY = 0;

        // Store the element that triggered the modal (for focus return)
        let triggerElement: HTMLElement | null = null;

        // Cleanup handler for View Transitions
        document.addEventListener('astro:before-swap', () => {
            window.__testimonialsInitialized = false;
        }, { once: true });

        // ============================================
        // EVENT DELEGATION: Mouse move for 3D tilt effect
        // ============================================
        document.addEventListener('mousemove', (e: MouseEvent) => {
        const target = e.target;
        if (!(target instanceof Element)) return;

        const card = target.closest('[data-tilt]') as HTMLElement | null;
        if (!card) return;

        // Skip if reduced motion preference
        if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) return;

        const glowElement = card.querySelector<HTMLElement>('.testimonial-glow');
        const rect = card.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;

        // Calculate rotation (max 12 degrees for more dramatic effect)
        const centerX = rect.width / 2;
        const centerY = rect.height / 2;
        const rotateX = ((y - centerY) / centerY) * -12;
        const rotateY = ((x - centerX) / centerX) * 12;

        // Apply 3D transform with enhanced scale
        card.style.transform = `rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale3d(1.05, 1.05, 1.05)`;

        // Update glow position
        if (glowElement) {
            const percentX = (x / rect.width) * 100;
            const percentY = (y / rect.height) * 100;
            glowElement.style.setProperty('--mouse-x', `${percentX}%`);
            glowElement.style.setProperty('--mouse-y', `${percentY}%`);
        }
    });

    // ============================================
    // EVENT DELEGATION: Mouse leave for 3D tilt reset
    // ============================================
    document.addEventListener('mouseleave', (e: MouseEvent) => {
        const target = e.target;
        if (!(target instanceof Element)) return;

        const card = target.closest('[data-tilt]') as HTMLElement | null;

        if (card) {
            card.style.transform = 'rotateX(0deg) rotateY(0deg) scale3d(1, 1, 1)';
        }
    }, true); // Use capture to catch mouseleave on the element itself

    // ============================================
    // EVENT DELEGATION: Mouseout for 3D tilt reset (backup)
    // ============================================
    document.addEventListener('mouseout', (e: MouseEvent) => {
        const target = e.target;
        if (!(target instanceof HTMLElement)) return;

        const relatedTarget = e.relatedTarget as HTMLElement | null;

        // Check if we're leaving a tilt card
        if (target.hasAttribute('data-tilt')) {
            // Only reset if we're not moving to a child element
            if (!relatedTarget || !target.contains(relatedTarget)) {
                target.style.transform = 'rotateX(0deg) rotateY(0deg) scale3d(1, 1, 1)';
            }
        }
    });

    function openTestimonialModal(index: number) {
        const modal = document.getElementById('testimonial-modal');
        const modalAvatar = document.getElementById('modal-avatar');
        const modalTitle = document.getElementById('modal-title');
        const modalRole = document.getElementById('modal-role');
        const modalCompany = document.getElementById('modal-company');
        const modalContent = document.getElementById('modal-content');
        const modalLinkedin = document.getElementById('modal-linkedin') as HTMLAnchorElement;
        const modalSource = document.getElementById('modal-source');
        const modalClose = modal?.querySelector('.modal-close') as HTMLButtonElement | null;

        const testimonials = (window as any).__testimonials || [];
        const testimonial = testimonials[index];

        if (!testimonial || !modal) return;

        // Use savedScrollY captured on mousedown, or fallback to current
        if (savedScrollY === 0 && window.scrollY > 0) {
            savedScrollY = window.scrollY;
        }

        // Lock scroll - use position fixed with negative top to maintain visual position
        document.body.style.top = `-${savedScrollY}px`;
        document.body.classList.add('modal-open');

        // Populate modal content
        if (modalAvatar) {
            if (testimonial.avatar) {
                modalAvatar.innerHTML = `<img src="${testimonial.avatar}" alt="${testimonial.name}" />`;
            } else {
                modalAvatar.innerHTML = testimonial.name.charAt(0);
            }
        }
        if (modalTitle) modalTitle.textContent = testimonial.name;
        if (modalRole) modalRole.textContent = testimonial.role;
        if (modalCompany) modalCompany.textContent = testimonial.company;
        if (modalContent) modalContent.textContent = testimonial.content;

        // LinkedIn link
        if (modalLinkedin) {
            if (testimonial.linkedinUrl) {
                modalLinkedin.href = testimonial.linkedinUrl;
                modalLinkedin.classList.remove('hidden');
            } else {
                modalLinkedin.classList.add('hidden');
            }
        }

        // Source badge
        if (modalSource) {
            if (testimonial.source === 'linkedin') {
                modalSource.classList.remove('hidden');
            } else {
                modalSource.classList.add('hidden');
            }
        }

        // Show modal
        modal.setAttribute('aria-hidden', 'false');

        // Focus close button
        modalClose?.focus({ preventScroll: true });
    }

    function closeTestimonialModal() {
        const modal = document.getElementById('testimonial-modal');
        if (!modal) return;

        // Hide modal
        modal.setAttribute('aria-hidden', 'true');

        // Unlock scroll - remove fixed positioning and restore scroll
        document.body.classList.remove('modal-open');
        document.body.style.top = '';
        window.scrollTo(0, savedScrollY);

        // Return focus to the trigger element
        if (triggerElement) {
            triggerElement.focus({ preventScroll: true });
            triggerElement = null;
        }
    }

    // ============================================
    // EVENT DELEGATION: Mousedown to capture scroll position
    // ============================================
    document.addEventListener('mousedown', (e) => {
        const target = e.target;
        if (!(target instanceof Element)) return;
        const trigger = target.closest('[data-testimonial-trigger]');
        if (trigger) {
            savedScrollY = window.scrollY;
        }
    }, { capture: true });

    // ============================================
    // EVENT DELEGATION: Click for all interactions
    // ============================================
    document.addEventListener('click', (e) => {
        const target = e.target;
        if (!(target instanceof Element)) return;

        // Handle testimonial card click (open modal)
        const trigger = target.closest('[data-testimonial-trigger]') as HTMLElement | null;
        if (trigger) {
            e.preventDefault();
            // Store the trigger element for focus return
            triggerElement = trigger;
            const index = parseInt(trigger.getAttribute('data-testimonial-trigger') || '0', 10);
            openTestimonialModal(index);
            return;
        }

        // Handle modal close button click
        if (target.closest('.testimonial-modal .modal-close')) {
            closeTestimonialModal();
            return;
        }

        // Handle modal backdrop click
        if (target.closest('.testimonial-modal .modal-backdrop')) {
            closeTestimonialModal();
            return;
        }

        // Handle carousel prev button
        if (target.closest('[data-carousel-prev]')) {
            navigateCarousel('prev');
            resetAutoplayTimer(); // Reset timer on manual navigation
            return;
        }

        // Handle carousel next button
        if (target.closest('[data-carousel-next]')) {
            navigateCarousel('next');
            resetAutoplayTimer(); // Reset timer on manual navigation
            return;
        }

        // Handle carousel dot click
        const dot = target.closest('[data-carousel-dot]') as HTMLElement | null;
        if (dot) {
            const index = parseInt(dot.dataset.carouselDot || '0', 10);
            if (totalRealSlides > 0) {
                scrollToRealSlide(index);
            } else {
                scrollToSlide(index);
            }
            resetAutoplayTimer(); // Reset timer on manual navigation
            return;
        }

        // Handle autoplay button click
        if (target.closest('[data-carousel-autoplay]')) {
            toggleAutoplay();
            return;
        }
    });

    // ============================================
    // EVENT DELEGATION: Escape key to close modal
    // ============================================
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            const modal = document.getElementById('testimonial-modal');
            if (modal?.getAttribute('aria-hidden') === 'false') {
                closeTestimonialModal();
            }
        }
    });

    // ============================================
    // CAROUSEL: Navigation functions
    // ============================================
    function getCarouselElements() {
        const carousel = document.getElementById('testimonials-carousel');
        const slides = carousel?.querySelectorAll<HTMLElement>('.testimonial-slide') || [];
        const dots = document.querySelectorAll<HTMLElement>('[data-carousel-dot]');
        const prevBtn = document.querySelector<HTMLButtonElement>('[data-carousel-prev]');
        const nextBtn = document.querySelector<HTMLButtonElement>('[data-carousel-next]');
        return { carousel, slides: Array.from(slides), dots: Array.from(dots), prevBtn, nextBtn };
    }

    function getCurrentSlideIndex(): number {
        const { carousel, slides } = getCarouselElements();
        if (!carousel || slides.length === 0) return 0;

        // Find the slide whose center is closest to the viewport center
        const carouselRect = carousel.getBoundingClientRect();
        const viewportCenter = carouselRect.left + carouselRect.width / 2;

        let closestIndex = 0;
        let closestDistance = Infinity;

        slides.forEach((slide, index) => {
            const slideRect = slide.getBoundingClientRect();
            const slideCenter = slideRect.left + slideRect.width / 2;
            const distance = Math.abs(slideCenter - viewportCenter);

            if (distance < closestDistance) {
                closestDistance = distance;
                closestIndex = index;
            }
        });

        return closestIndex;
    }

    function scrollToSlide(index: number) {
        const { carousel, slides } = getCarouselElements();
        if (!carousel || slides.length === 0) return;

        const targetSlide = slides[Math.max(0, Math.min(index, slides.length - 1))];
        if (targetSlide) {
            // Calculate scroll position to center the target slide
            const slideLeft = targetSlide.offsetLeft;
            const slideWidth = targetSlide.offsetWidth;
            const carouselWidth = carousel.offsetWidth;

            // Scroll so the slide is centered in the viewport
            const scrollPosition = slideLeft - (carouselWidth / 2) + (slideWidth / 2);

            carousel.scrollTo({
                left: Math.max(0, scrollPosition),
                behavior: 'smooth'
            });
        }
    }

    function navigateCarousel(direction: 'prev' | 'next') {
        if (totalRealSlides > 0) {
            // Infinite loop mode - navigate through all slides including clones
            const carousel = document.getElementById('testimonials-carousel');
            if (!carousel) return;

            const allSlides = carousel.querySelectorAll<HTMLElement>('.testimonial-slide');
            const carouselRect = carousel.getBoundingClientRect();
            const viewportCenter = carouselRect.left + carouselRect.width / 2;

            // Find current centered slide
            let centeredIndex = 0;
            let closestDistance = Infinity;

            allSlides.forEach((slide, index) => {
                const slideRect = slide.getBoundingClientRect();
                const slideCenter = slideRect.left + slideRect.width / 2;
                const distance = Math.abs(slideCenter - viewportCenter);

                if (distance < closestDistance) {
                    closestDistance = distance;
                    centeredIndex = index;
                }
            });

            // Navigate to adjacent slide
            const newIndex = direction === 'prev' ? centeredIndex - 1 : centeredIndex + 1;

            // Bounds check (with clones, we have extra slides)
            if (newIndex >= 0 && newIndex < allSlides.length) {
                const targetSlide = allSlides[newIndex];
                const slideLeft = targetSlide.offsetLeft;
                const slideWidth = targetSlide.offsetWidth;
                const carouselWidth = carousel.offsetWidth;
                const scrollPosition = slideLeft - (carouselWidth / 2) + (slideWidth / 2);

                carousel.scrollTo({
                    left: Math.max(0, scrollPosition),
                    behavior: 'smooth'
                });
            }
        } else {
            // Fallback: non-infinite mode
            const currentIndex = getCurrentSlideIndex();
            const { slides } = getCarouselElements();
            const maxIndex = slides.length - 1;

            let newIndex: number;
            if (direction === 'prev') {
                newIndex = currentIndex <= 0 ? maxIndex : currentIndex - 1;
            } else {
                newIndex = currentIndex >= maxIndex ? 0 : currentIndex + 1;
            }

            scrollToSlide(newIndex);
        }
    }

    function updateCarouselIndicators() {
        const realIndex = totalRealSlides > 0 ? getRealSlideIndex() : getCurrentSlideIndex();
        const { dots, prevBtn, nextBtn } = getCarouselElements();
        const carousel = document.getElementById('testimonials-carousel');

        // Update dots (based on real slide index)
        dots.forEach((dot, i) => {
            const isActive = i === realIndex;
            dot.classList.toggle('active', isActive);
            dot.setAttribute('aria-selected', isActive ? 'true' : 'false');
        });

        // Update slides active state (for opacity effect)
        // Mark the centered slide as active
        if (carousel) {
            const allSlides = carousel.querySelectorAll<HTMLElement>('.testimonial-slide');
            const carouselRect = carousel.getBoundingClientRect();
            const viewportCenter = carouselRect.left + carouselRect.width / 2;

            let closestIndex = 0;
            let closestDistance = Infinity;

            allSlides.forEach((slide, index) => {
                const slideRect = slide.getBoundingClientRect();
                const slideCenter = slideRect.left + slideRect.width / 2;
                const distance = Math.abs(slideCenter - viewportCenter);

                if (distance < closestDistance) {
                    closestDistance = distance;
                    closestIndex = index;
                }
            });

            allSlides.forEach((slide, i) => {
                slide.classList.toggle('active', i === closestIndex);
            });
        }

        // Update button states - for infinite loop, buttons are always enabled
        if (prevBtn) prevBtn.disabled = false;
        if (nextBtn) nextBtn.disabled = false;
    }

    // ============================================
    // CAROUSEL: Scroll listener for indicator sync
    // ============================================
    let scrollTimeout: ReturnType<typeof setTimeout>;
    let scrollEndTimeout: ReturnType<typeof setTimeout>;

    document.addEventListener('scroll', (e) => {
        const target = e.target;
        if (!(target instanceof Element)) return;

        if (target.id === 'testimonials-carousel') {
            // Debounce the indicator update
            clearTimeout(scrollTimeout);
            scrollTimeout = setTimeout(updateCarouselIndicators, 50);

            // Check infinite loop bounds QUICKLY after scroll pauses
            // Using shorter delay for faster response
            clearTimeout(scrollEndTimeout);
            scrollEndTimeout = setTimeout(() => {
                checkInfiniteLoopBounds();
            }, 80); // Reduced from 150ms to 80ms for faster jump
        }
    }, true);

    // ============================================
    // CAROUSEL: Keyboard navigation
    // ============================================
    document.addEventListener('keydown', (e) => {
        const carousel = document.getElementById('testimonials-carousel');
        if (!carousel) return;

        // Check if carousel or its children are focused
        const isCarouselFocused = carousel.contains(document.activeElement);
        if (!isCarouselFocused) return;

        if (e.key === 'ArrowLeft') {
            e.preventDefault();
            navigateCarousel('prev');
            resetAutoplayTimer();
        } else if (e.key === 'ArrowRight') {
            e.preventDefault();
            navigateCarousel('next');
            resetAutoplayTimer();
        }
    });

    // ============================================
    // CAROUSEL: Autoplay functionality
    // ============================================
    const AUTOPLAY_INTERVAL = 4000; // 4 seconds per slide
    let autoplayTimer: ReturnType<typeof setInterval> | null = null;
    let isAutoplayEnabled = true; // Start with autoplay enabled

    function startAutoplay() {
        if (autoplayTimer) return; // Already running

        autoplayTimer = setInterval(() => {
            navigateCarousel('next');
        }, AUTOPLAY_INTERVAL);

        isAutoplayEnabled = true;
        updateAutoplayButton();
    }

    function stopAutoplay() {
        if (autoplayTimer !== null) {
            clearInterval(autoplayTimer as unknown as number);
            autoplayTimer = null;
        }
        isAutoplayEnabled = false;
        updateAutoplayButton();
    }

    function toggleAutoplay() {
        if (isAutoplayEnabled) {
            stopAutoplay();
        } else {
            startAutoplay();
        }
    }

    function resetAutoplayTimer() {
        // Reset the timer if autoplay is enabled
        if (isAutoplayEnabled && autoplayTimer !== null) {
            clearInterval(autoplayTimer as unknown as number);
            autoplayTimer = setInterval(() => {
                navigateCarousel('next');
            }, AUTOPLAY_INTERVAL);
        }
    }

    function updateAutoplayButton() {
        const btn = document.querySelector('[data-carousel-autoplay]');
        if (btn) {
            btn.classList.toggle('playing', isAutoplayEnabled);
            btn.setAttribute('aria-label', isAutoplayEnabled ? 'Pausar carrusel' : 'Reproducir carrusel');
        }
    }

    // Pause autoplay on hover
    document.addEventListener('mouseenter', (e) => {
        const target = e.target;
        if (!(target instanceof Element)) return;

        if (target.closest('#testimonials-carousel')) {
            if (isAutoplayEnabled && autoplayTimer !== null) {
                clearInterval(autoplayTimer as unknown as number);
                autoplayTimer = null;
            }
        }
    }, true);

    // Resume autoplay on mouse leave
    document.addEventListener('mouseleave', (e) => {
        const target = e.target;
        if (!(target instanceof Element)) return;

        if (target.closest('#testimonials-carousel')) {
            if (isAutoplayEnabled && !autoplayTimer) {
                autoplayTimer = setInterval(() => {
                    navigateCarousel('next');
                }, AUTOPLAY_INTERVAL);
            }
        }
    }, true);

    // ============================================
    // INFINITE LOOP: Clone slides for seamless scrolling
    // ============================================
    const CLONES_PER_SIDE = 3; // Number of clones on each side for seamless loop
    let totalRealSlides = 0;
    let isJumping = false; // Flag to prevent scroll handler during instant jumps

    function setupInfiniteLoop() {
        const carousel = document.getElementById('testimonials-carousel');
        if (!carousel) return;

        const slides = carousel.querySelectorAll<HTMLElement>('.testimonial-slide:not(.clone)');
        totalRealSlides = slides.length;

        if (totalRealSlides === 0) return;

        // Remove existing clones (for View Transitions re-init)
        carousel.querySelectorAll('.clone').forEach(clone => clone.remove());

        // Clone slides: add enough clones for seamless infinite loop
        const clonesNeeded = Math.min(totalRealSlides, CLONES_PER_SIDE);

        // Clone last slides and prepend (in reverse order so they appear correctly)
        for (let i = 0; i < clonesNeeded; i++) {
            const sourceIndex = totalRealSlides - 1 - i;
            const clone = slides[sourceIndex].cloneNode(true) as HTMLElement;
            clone.classList.add('clone');
            clone.removeAttribute('data-testimonial-index');
            clone.setAttribute('data-clone-of', String(sourceIndex));
            carousel.insertBefore(clone, carousel.firstChild);
        }

        // Clone first slides and append
        for (let i = 0; i < clonesNeeded; i++) {
            const clone = slides[i].cloneNode(true) as HTMLElement;
            clone.classList.add('clone');
            clone.removeAttribute('data-testimonial-index');
            clone.setAttribute('data-clone-of', String(i));
            carousel.appendChild(clone);
        }

        // Set initial scroll position to center the first real slide
        requestAnimationFrame(() => {
            scrollToRealSlide(0, false);
        });
    }

    function scrollToRealSlide(realIndex: number, smooth = true) {
        const carousel = document.getElementById('testimonials-carousel');
        if (!carousel) return;

        const allSlides = carousel.querySelectorAll<HTMLElement>('.testimonial-slide');
        // Real slides start after the prepended clones
        const targetIndex = realIndex + CLONES_PER_SIDE;
        const targetSlide = allSlides[targetIndex];

        if (targetSlide) {
            if (smooth) {
                // Use scrollIntoView for smooth scrolling
                targetSlide.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
            } else {
                // For instant jump, use the seamless jump technique
                performSeamlessJump(carousel, allSlides, realIndex);
            }
        }
    }

    function getRealSlideIndex(): number {
        const { carousel } = getCarouselElements();
        if (!carousel || totalRealSlides === 0) return 0;

        const allSlides = carousel.querySelectorAll<HTMLElement>('.testimonial-slide');
        const carouselRect = carousel.getBoundingClientRect();
        const viewportCenter = carouselRect.left + carouselRect.width / 2;

        let closestIndex = 0;
        let closestDistance = Infinity;

        allSlides.forEach((slide, index) => {
            const slideRect = slide.getBoundingClientRect();
            const slideCenter = slideRect.left + slideRect.width / 2;
            const distance = Math.abs(slideCenter - viewportCenter);

            if (distance < closestDistance) {
                closestDistance = distance;
                closestIndex = index;
            }
        });

        // Convert to real slide index (accounting for prepended clones)
        // Example with 8 slides and 3 clones: [5, 6, 7, 0, 1, 2, 3, 4, 5, 6, 7, 0, 1, 2]
        // Index:                                0  1  2  3  4  5  6  7  8  9 10 11 12 13
        const adjustedIndex = closestIndex - CLONES_PER_SIDE;

        if (adjustedIndex < 0) {
            return totalRealSlides + adjustedIndex; // Wrap to end
        } else if (adjustedIndex >= totalRealSlides) {
            return adjustedIndex - totalRealSlides; // Wrap to beginning
        }
        return adjustedIndex;
    }

    function checkInfiniteLoopBounds() {
        if (isJumping) return;

        const carousel = document.getElementById('testimonials-carousel');
        if (!carousel || totalRealSlides === 0) return;

        const allSlides = carousel.querySelectorAll<HTMLElement>('.testimonial-slide');
        const carouselRect = carousel.getBoundingClientRect();
        const viewportCenter = carouselRect.left + carouselRect.width / 2;

        // Find which slide is centered
        let centeredIndex = 0;
        let closestDistance = Infinity;

        allSlides.forEach((slide, index) => {
            const slideRect = slide.getBoundingClientRect();
            const slideCenter = slideRect.left + slideRect.width / 2;
            const distance = Math.abs(slideCenter - viewportCenter);

            if (distance < closestDistance) {
                closestDistance = distance;
                centeredIndex = index;
            }
        });

        // Layout with 8 slides and 3 clones per side:
        // Index:  0   1   2   3   4   5   6   7   8   9  10  11  12  13
        // Slide: [5] [6] [7] [0] [1] [2] [3] [4] [5] [6] [7] [0] [1] [2]
        //         prepend     real slides     append 
        //
        // Real slides are at indices: CLONES_PER_SIDE to (CLONES_PER_SIDE + totalRealSlides - 1)
        // i.e., indices 3 to 10 for real slides 0-7

        const firstRealIndex = CLONES_PER_SIDE; // 3
        const lastRealIndex = CLONES_PER_SIDE + totalRealSlides - 1; // 10

        // Only jump when we're on an ACTUAL CLONE (outside real slides range)
        // Jump happens AFTER scroll ends, when clone is centered and stable
        if (centeredIndex < firstRealIndex) {
            // On a prepended clone - jump to corresponding real slide
            const cloneOfSlide = allSlides[centeredIndex].getAttribute('data-clone-of');
            if (cloneOfSlide !== null) {
                const realSlideIndex = parseInt(cloneOfSlide, 10);
                performSeamlessJump(carousel, allSlides, realSlideIndex);
            }
        } else if (centeredIndex > lastRealIndex) {
            // On an appended clone - jump to corresponding real slide
            const cloneOfSlide = allSlides[centeredIndex].getAttribute('data-clone-of');
            if (cloneOfSlide !== null) {
                const realSlideIndex = parseInt(cloneOfSlide, 10);
                performSeamlessJump(carousel, allSlides, realSlideIndex);
            }
        }
    }

    function performSeamlessJump(carousel: HTMLElement, allSlides: NodeListOf<HTMLElement>, realSlideIndex: number) {
        isJumping = true;

        // Target is the real slide at position CLONES_PER_SIDE + realSlideIndex
        const targetIndex = realSlideIndex + CLONES_PER_SIDE;
        const targetSlide = allSlides[targetIndex];

        if (!targetSlide) {
            isJumping = false;
            return;
        }

        // Calculate target scroll position
        const slideLeft = targetSlide.offsetLeft;
        const slideWidth = targetSlide.offsetWidth;
        const carouselWidth = carousel.offsetWidth;
        const scrollPosition = slideLeft - (carouselWidth / 2) + (slideWidth / 2);

        // TECHNIQUE 1: Add CSS class to disable all transitions/animations
        carousel.classList.add('jumping');

        // TECHNIQUE 2: Disable scroll-snap during jump
        const originalSnapType = carousel.style.scrollSnapType;
        carousel.style.scrollSnapType = 'none';

        // Perform the instant jump synchronously
        carousel.scrollLeft = Math.max(0, scrollPosition);

        // Force browser to commit immediately
        void carousel.scrollLeft;

        // Re-enable everything in next animation frame
        requestAnimationFrame(() => {
            carousel.style.scrollSnapType = originalSnapType || '';

            // Remove jumping class after a tiny delay to ensure stability
            requestAnimationFrame(() => {
                carousel.classList.remove('jumping');

                // Allow next jump detection
                setTimeout(() => {
                    isJumping = false;
                }, 20);
            });
        });
    }

    // ============================================
    // INITIALIZATION: Setup carousel
    // ============================================
    function initCarousel() {
        setupInfiniteLoop();
        updateCarouselIndicators();
        // Start autoplay on initialization
        if (isAutoplayEnabled) {
            startAutoplay();
        }
    }

    // Initialize on page load and after View Transitions
    initCarousel();
    document.addEventListener('qazuor:content-ready', initCarousel);

    } // End of else block (guard flag check)
</script>
